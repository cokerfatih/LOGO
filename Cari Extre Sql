USE [LKSDB]
GO

/****** Object:  View [dbo].[SAGLAM_320_CARIEXTRE]    Script Date: 29.01.2023 12:17:04 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER VIEW [dbo].[SAGLAM_320_CARIEXTRE]
AS


SELECT

CLC.CODE AS [CARI KOD],
CLC.DEFINITION_ AS [CARI ADI],


ISNULL(CLF.DATE_,'') [FIS TARIHI],
--ISNULL(CFC.DATE_,'')+ISNULL(BNF.DATE_,'')+ISNULL(CSR.DATE_,'')+ISNULL(KSL.DATE_,'')+ISNULL(INV.DATE_,'') AS [FIS TAR],
ISNULL(CFC.FICHENO,'')+ISNULL(BNF.TRANNO,'')+ISNULL(CSR.ROLLNO,'')+ISNULL(KSL.FICHENO,'')+ISNULL(INV.FICHENO,'') AS [FIS NO],

(CASE 
WHEN CLF.MODULENR=4 AND CLF.TRCODE=31 THEN 'Mal Alım Fat.' 
WHEN CLF.MODULENR=4 AND CLF.TRCODE=32 THEN 'Perakende Satış İade Fat.' 
WHEN CLF.MODULENR=4 AND CLF.TRCODE=33 THEN 'Toptan Satış İade Fat.' 
WHEN CLF.MODULENR=4 AND CLF.TRCODE=34 THEN 'Alınan Hizmet Fat.' 
WHEN CLF.MODULENR=4 AND CLF.TRCODE=36 THEN 'Alım İade Fat.' 
WHEN CLF.MODULENR=4 AND CLF.TRCODE=38 THEN 'Toptan Satış Fat.' 
WHEN CLF.MODULENR=4 AND CLF.TRCODE=39 THEN 'Verilen Hizmet Fat.' 
WHEN CLF.MODULENR=4 AND CLF.TRCODE=56 THEN 'Müstahsil' 
WHEN CLF.MODULENR=5 AND CLF.TRCODE=1 THEN 'Nakit Tahsilat' 
WHEN CLF.MODULENR=5 AND CLF.TRCODE=2 THEN 'Nakit Ödeme' 
WHEN CLF.MODULENR=5 AND CLF.TRCODE=3 THEN 'Borç Dekontu' 
WHEN CLF.MODULENR=5 AND CLF.TRCODE=4 THEN 'Alacak Dekontu' 
WHEN CLF.MODULENR=5 AND CLF.TRCODE=5 THEN 'Virman İşlemi' 
WHEN CLF.MODULENR=5 AND CLF.TRCODE=14 THEN 'Açılış İşlemi' 
WHEN CLF.MODULENR=5 AND CLF.TRCODE=46 THEN 'Alınan Serbest Meslek Makbuzu' 
WHEN CLF.MODULENR=6 AND CLF.TRCODE=61 THEN 'Çek Girişi' 
WHEN CLF.MODULENR=6 AND CLF.TRCODE=62 THEN 'Senet Girişi' 
WHEN CLF.MODULENR=6 AND CLF.TRCODE=63 THEN 'Çek Çıkışı(Cari Hesaba)' 
WHEN CLF.MODULENR=6 AND CLF.TRCODE=64 THEN 'Senet Çıkış(Cari Hesaba)' 
WHEN CLF.MODULENR=7 AND CLF.TRCODE=20 THEN 'Gelen Havaleler' 
WHEN CLF.MODULENR=7 AND CLF.TRCODE=21 THEN 'Gönderilen Havaleler' 
WHEN CLF.MODULENR=7 AND CLF.TRCODE=28 THEN 'Banka Alınan Hizmet Fat.' 

WHEN CLF.MODULENR=10  AND CLF.TRCODE=1 THEN 'Nakit Tahsilat' 
WHEN CLF.MODULENR=10  AND CLF.TRCODE=2 THEN 'Nakit Ödeme' 
WHEN CLF.MODULENR=61 AND CLF.TRCODE=3 THEN 'Müşteriye İade Edilen Çekler' 
WHEN CLF.MODULENR=61 AND CLF.TRCODE=4 THEN 'Müşteriden Portföye İade Çekler' Else '' END) AS [FİŞTÜRÜ], 



---------
ISNULL(CFC.GENEXP1,'')+ISNULL(BNF.LINEEXP,'')+ISNULL(CSR.GENEXP1,'')+ISNULL(KSL.LINEEXP,'')+ISNULL(INV.GENEXP1,'') AS [ACIKLAMA]
--(CASE CLF.SIGN WHEN 0 THEN CLF.AMOUNT ELSE 0 END) AS [BORÇ TL],
--(CASE CLF.SIGN WHEN 1 THEN CLF.AMOUNT ELSE 0 END) AS [ALACAK TL],
--------------------------
,CASE WHEN CLF.TRCURR IN (0,160) THEN (CASE CLF.SIGN WHEN 0 THEN CLF.TRNET ELSE 0 END) ELSE CLF.AMOUNT END AS [BORÇ TL]
,CASE WHEN CLF.TRCURR IN (0,160) THEN (CASE CLF.SIGN WHEN 1 THEN CLF.TRNET * -1 ELSE 0 END) ELSE CLF.AMOUNT END AS [ALACAK TL]
,CASE WHEN CLF.TRCURR IN (0,160) THEN (CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 ELSE 0 END) ELSE CLF.AMOUNT END AS [BAKIYE TL]
,[TL YURUYEN BAKIYE] = ((SELECT SUM(CASE WHEN CLF1.SIGN IN (0) THEN CLF1.TRNET WHEN  CLF1.SIGN IN (1)  THEN CLF1.TRNET * -1 END) FROM LG_320_01_CLFLINE CLF1 WHERE CLF1.TRCURR IN (0,160) AND ((CLF1.DATE_ < CLF.DATE_) OR (CLF1.DATE_ = CLF.DATE_ AND CLF1.FTIME <= CLF.FTIME)) AND CLF1.CLIENTREF = CLF.CLIENTREF))
,(CASE CLF.SIGN WHEN 0 THEN CLF.TRNET ELSE 0 END) AS [BORÇ ID],
(CASE CLF.SIGN WHEN 1 THEN CLF.TRNET ELSE 0 END) AS [ALACAK ID],

(CASE CLF.SIGN WHEN 0 THEN CLF.TRNET ELSE 0 END)-(CASE CLF.SIGN WHEN 1 THEN CLF.TRNET*-1 ELSE 0 END) AS [BAKIYE ID]
,CASE CLF.TRCURR WHEN 0 THEN 'TL' WHEN 1 THEN 'USD' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 3 THEN 'AUD' WHEN 11 THEN 'CHF' WHEN 13 THEN 'JPY' ELSE 'DIGER' END AS [ID TURU]
FROM 
LG_320_01_CLFLINE CLF 
LEFT JOIN LG_320_01_CLFICHE CFC ON CFC.LOGICALREF=CLF.SOURCEFREF AND CLF.MODULENR=5
LEFT JOIN LG_320_01_BNFLINE BNF ON BNF.LOGICALREF=CLF.SOURCEFREF AND CLF.MODULENR=7
LEFT JOIN LG_320_01_CSROLL CSR ON CSR.LOGICALREF=CLF.SOURCEFREF AND CLF.MODULENR=6
LEFT JOIN LG_320_01_KSLINES KSL ON KSL.TRANSREF=CLF.LOGICALREF AND  CLF.MODULENR=10
LEFT JOIN LG_320_01_INVOICE INV ON INV.LOGICALREF=CLF.SOURCEFREF AND CLF.MODULENR=4
LEFT JOIN LG_320_CLCARD CLC ON CLC.LOGICALREF=CLF.CLIENTREF

WHERE CLF.CANCELLED=0 AND CLC.ACTIVE=0 
GO


