USE [LKSDB]
GO

/****** Object:  View [dbo].[SAGLAM_320_CARIEXTREDETAYLI]    Script Date: 29.01.2023 12:19:44 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






ALTER VIEW [dbo].[SAGLAM_320_CARIEXTREDETAYLI]
AS

SELECT 
	CTRNS.DATE_ "TARİH", 
		CASE CTRNS.MODULENR 
			WHEN 4 THEN INVFC.FICHENO 
			WHEN 5 THEN CLFIC.FICHENO
			WHEN 6 THEN CSK.PORTFOYNO 
			WHEN 7 THEN CTRNS.TRANNO 
			WHEN 10 THEN CTRNS.TRANNO ELSE CTRNS.TRANNO END  "FİŞ NO",
	CLNTC.CODE "CARI KODU",
	CLNTC.DEFINITION_ "CARI UNVANI",
		CASE CTRNS.MODULENR 
				WHEN 3 THEN 'Sipariş' 
				WHEN 4 THEN 'Fatura  ' 
				WHEN 5 THEN 'Cari  ' 
				WHEN 6 THEN 'Çek/Senet  ' 
				WHEN 7 THEN 'Banka  ' 
				WHEN 10 THEN 'Kasa  ' ELSE 'Çek/Senet  ' END "TÜRÜ", 
--------------------------------------------------------------------------


CASE 
		CTRNS.MODULENR WHEN 4 THEN 

					CASE CTRNS.TRCODE	
							WHEN 31  THEN 'Mal Alım Faturası' when 38 THEN 'Toptan Satış Faturası'WHEN 39 THEN 'Verilen Hizmet Faturası' WHEN 56 THEN 'Mustahsıl'WHEN 34 THEN 'Alınan Hizmet faturası'END 
							
						WHEN 6 THEN 
					CASE CTRNS.TRCODE	
							WHEN 61 THEN 'Çek Girişi' WHEN 62 THEN 'Senet Girişi' END
						WHEN 5 THEN 
					CASE CTRNS.TRCODE	
							WHEN 5 THEN 'Virman'WHEN 46 THEN 'Alınan Serbest Meslek Makbuzu' WHEN 1 THEN 'Nakit Tahsilat'WHEN 2 THEN 'Nakit Ödeme' WHEN 3 THEN 'Borç Dekontu'WHEN 4 THEN 'Alacak Dekontu'WHEN 14 THEN 'Açılış Fişi'END
                        WHEN 7 THEN 
					CASE CTRNS.TRCODE	
							WHEN  20 THEN 'Gelen Havale' WHEN  21 THEN 'Gönderilen Havale' END


							END "FİŞ TÜRÜ",


				
				--SELECT * FROM LG_320_01_CLFLINE WHERE CLIENTREF=1004



------------------------------------------------------------




	CASE 
		WHEN CTRNS.MODULENR=6 THEN CSK.DUEDATE 
		WHEN CTRNS.MODULENR IN (5,61,62,63,64) THEN TMP1.ORT_VADE
		WHEN CTRNS.MODULENR IN (4,7,10) THEN TMP2.ORT_VADE
	ELSE ' ' END "VADESI",

	---ISNULL(STL.LINEEXP,'') + '/' +  ISNULL(CTRNS.LINEEXP,'')  "AÇIKLAMA",

	-----
	CASE CTRNS.MODULENR 
				WHEN 3 THEN ISNULL(CTRNS.LINEEXP,'') 
				WHEN 4 THEN ISNULL(STL.LINEEXP,'')
				WHEN 5 THEN ISNULL(CTRNS.LINEEXP,'') 
				WHEN 6 THEN ISNULL(CTRNS.LINEEXP,'')  
				WHEN 7 THEN ISNULL(CTRNS.LINEEXP,'') 
				WHEN 10 THEN ISNULL(CTRNS.LINEEXP,'')  ELSE ISNULL(CTRNS.LINEEXP,'') END "AÇIKLAMA", 

	-----
	ISNULL(
	CASE STL.LINETYPE 
			WHEN 4 THEN SRV.CODE ELSE ITM.CODE END, '') "MALZEME KODU",
	ISNULL(
	CASE STL.LINETYPE 
			WHEN 4 THEN SRV.DEFINITION_ ELSE ITM.NAME END, '') "MALZEME ADI",
	ISNULL(STL.AMOUNT, 0) "MİKTAR",
	ISNULL(UTL.CODE, '')  "BİRİMİ",
	ISNULL(STL.PRICE,0) "BİRİM FİYATI",
	ISNULL(STL.DISTDISC,0) "INDIRIM TOPLAMI",
	ISNULL(STL.DISTEXP,0) "MASRAF TOPLAMI",
	ISNULL(STL.TOTAL,0) "TUTAR",
	ISNULL(STL.VAT,0) "KDV ORANI",
	ISNULL(STL.VATMATRAH,0) "KDV MATRAHI",
	ISNULL(STL.VATAMNT,0) "KDV TUTARI",
	--ISNULL(STL.VATMATRAH,0)+ISNULL(STL.VATAMNT,0) "NET TUTAR",

	---
		CASE 
		CTRNS.SIGN WHEN 0 THEN 
					ISNULL(STL.VATMATRAH,0)+ISNULL(STL.VATAMNT,0)
							ELSE (ISNULL(STL.VATMATRAH,0)+ISNULL(STL.VATAMNT,0))*-1 END "NET TUTAR",

	---
	CASE 
		CTRNS.SIGN WHEN 0 THEN 
					CASE CTRNS.MODULENR	
							WHEN 4 THEN CASE WHEN CTRNS.TRCODE IN (41,42) THEN CTRNS.AMOUNT ELSE ISNULL(STL.LINENET+STL.VATAMNT,0) END 
							WHEN 6 THEN CSK.AMOUNT
							ELSE CTRNS.AMOUNT END
					ELSE ISNULL(INVFC.FROMKASA*(STL.LINENET+STL.VATAMNT),0) END "BORÇ",
	CASE 
		CTRNS.SIGN WHEN 1 THEN 
					CASE CTRNS.MODULENR	
							WHEN 4 THEN CASE WHEN CTRNS.TRCODE IN (41,42) THEN CTRNS.AMOUNT ELSE ISNULL(STL.LINENET+STL.VATAMNT,0) END 
							WHEN 6 THEN CSK.AMOUNT
							ELSE CTRNS.AMOUNT END
					ELSE ISNULL(INVFC.FROMKASA*(STL.LINENET+STL.VATAMNT),0) END "ALACAK",
	
(
	CASE 
		CTRNS.SIGN WHEN 0 THEN 
					CASE CTRNS.MODULENR	
							WHEN 4 THEN CASE WHEN CTRNS.TRCODE IN (41,42) THEN CTRNS.AMOUNT ELSE ISNULL(STL.LINENET+STL.VATAMNT,0) END
							WHEN 6 THEN CSK.AMOUNT
							ELSE CTRNS.AMOUNT END
					ELSE ISNULL(INVFC.FROMKASA*(STL.LINENET+STL.VATAMNT),0) END 
) -
( 
	CASE 
		CTRNS.SIGN WHEN 1 THEN 
					CASE CTRNS.MODULENR	
							WHEN 4 THEN CASE WHEN CTRNS.TRCODE IN (41,42) THEN CTRNS.AMOUNT ELSE ISNULL(STL.LINENET+STL.VATAMNT,0) END 
							WHEN 6 THEN CSK.AMOUNT
							ELSE CTRNS.AMOUNT END
					ELSE ISNULL(INVFC.FROMKASA*(STL.LINENET+STL.VATAMNT),0) END 
) "BAKIYE"

,[TL YURUYEN BAKIYE] = ISNULL(((SELECT SUM(CASE WHEN CLF1.SIGN IN (0) THEN CLF1.TRNET WHEN  CLF1.SIGN IN (1)  THEN CLF1.TRNET * -1 END) FROM LG_320_01_CLFLINE CLF1 WHERE CLF1.TRCURR IN (0,160) AND ((CLF1.DATE_ < CTRNS.DATE_) OR (CLF1.DATE_ = CTRNS.DATE_ AND CLF1.FTIME <= CTRNS.FTIME)) AND CLF1.CLIENTREF = CTRNS.CLIENTREF)),0)
+ISNULL(((SELECT SUM(CASE WHEN CLF1.SIGN IN (0) THEN CLF1.TRNET*CLF1.TRRATE WHEN  CLF1.SIGN IN (1)  THEN (CLF1.TRNET*CLF1.TRRATE) * -1 END) FROM LG_320_01_CLFLINE CLF1 WHERE CLF1.TRCURR = 1 AND ((CLF1.DATE_ < CTRNS.DATE_) OR (CLF1.DATE_ = CTRNS.DATE_ AND CLF1.FTIME <=CTRNS.FTIME)) AND CLF1.CLIENTREF = CTRNS.CLIENTREF)),0)
+ISNULL(((SELECT SUM(CASE WHEN CLF1.SIGN IN (0) THEN CLF1.TRNET*CLF1.TRRATE WHEN  CLF1.SIGN IN (1)  THEN (CLF1.TRNET*CLF1.TRRATE) * -1 END) FROM LG_320_01_CLFLINE CLF1 WHERE CLF1.TRCURR = 20 AND ((CLF1.DATE_ < CTRNS.DATE_) OR (CLF1.DATE_ = CTRNS.DATE_ AND CLF1.FTIME <=CTRNS.FTIME)) AND CLF1.CLIENTREF = CTRNS.CLIENTREF)),0)

,YEAR(CTRNS.DATE_) "YIL"
FROM 
LG_320_01_CLFLINE CTRNS WITH(NOLOCK) 
LEFT OUTER JOIN LG_320_PAYPLANS PAYPL WITH(NOLOCK) ON (CTRNS.PAYDEFREF = PAYPL.LOGICALREF) 
LEFT OUTER JOIN LG_320_01_CLFICHE CLFIC WITH(NOLOCK) ON (CTRNS.SOURCEFREF = CLFIC.LOGICALREF) 
LEFT OUTER JOIN LG_320_01_INVOICE INVFC WITH(NOLOCK) ON (CTRNS.SOURCEFREF = INVFC.LOGICALREF) AND (CTRNS.MODULENR=4) 
LEFT OUTER JOIN LG_320_01_STLINE STL WITH(NOLOCK) ON (STL.INVOICEREF = INVFC.LOGICALREF) AND (STL.LINETYPE NOT IN (2,3,7))
LEFT OUTER JOIN LG_320_UNITSETL UTL WITH(NOLOCK) ON (UTL.LOGICALREF = STL.UOMREF) AND (STL.LINETYPE NOT IN (2,3,7))
LEFT OUTER JOIN LG_320_ITEMS ITM WITH(NOLOCK) ON (ITM.LOGICALREF = STL.STOCKREF) AND (STL.LINETYPE NOT IN (2,3,4,7))
LEFT OUTER JOIN LG_320_SRVCARD SRV WITH(NOLOCK) ON (SRV.LOGICALREF = STL.STOCKREF) AND (STL.LINETYPE IN (4))
LEFT OUTER JOIN LG_320_01_CSROLL RLFIC WITH(NOLOCK) ON (CTRNS.SOURCEFREF = RLFIC.LOGICALREF) AND (CTRNS.MODULENR=6)
LEFT OUTER JOIN LG_320_01_CSTRANS CST WITH(NOLOCK) ON (CST.ROLLREF = RLFIC.LOGICALREF) 
LEFT OUTER JOIN LG_320_01_CSCARD CSK WITH(NOLOCK) ON (CST.CSREF = CSK.LOGICALREF) 
LEFT OUTER JOIN LG_320_01_EMFICHE GLFIC WITH(NOLOCK) ON (CTRNS.ACCFICHEREF = GLFIC.LOGICALREF) 
LEFT OUTER JOIN LG_SLSMAN SLSMC WITH(NOLOCK) ON (INVFC.SALESMANREF = SLSMC.LOGICALREF) 
LEFT OUTER JOIN LG_320_CLCARD CLNTC WITH(NOLOCK) ON (CTRNS.CLIENTREF = CLNTC.LOGICALREF)
LEFT OUTER JOIN 

(
SELECT 
	MODULENR, FICHEREF, PROCDATE, DATEADD(DAY,(SUM(DATEDIFF(DAY,PROCDATE,DATE_)*TOTAL)/SUM(TOTAL)),PROCDATE) AS ORT_VADE
FROM
 LG_320_01_PAYTRANS WITH(NOLOCK)
WHERE
	CANCELLED=0
 AND MODULENR IN (5,61,62,63,64) 
GROUP BY MODULENR, FICHEREF, PROCDATE
) TMP1 
ON CTRNS.MODULENR IN (5,61,62,63,64) 
AND TMP1.FICHEREF=CTRNS.LOGICALREF

 AND TMP1.MODULENR=CTRNS.MODULENR  
LEFT  OUTER JOIN 

(
SELECT 
	MODULENR, FICHEREF, PROCDATE, DATEADD(DAY,(SUM(DATEDIFF(DAY,PROCDATE,DATE_)*TOTAL)/SUM(TOTAL)),PROCDATE) AS ORT_VADE
FROM LG_320_01_PAYTRANS WITH(NOLOCK)
WHERE
	CANCELLED=0
 AND MODULENR NOT IN (5,61,62,63,64) 
GROUP BY
 MODULENR, FICHEREF, PROCDATE
) TMP2 
ON CTRNS.MODULENR NOT IN (5,61,62,63,64) 
AND TMP2.FICHEREF=CTRNS.SOURCEFREF 
AND TMP2.MODULENR=CTRNS.MODULENR 
WHERE 
(CTRNS.TRCODE IN (31, 32, 33, 34, 36, 37, 38, 39, 43, 44, 56, 1, 2, 3, 4, 5, 6, 12, 14, 41, 42, 45, 46, 70, 71, 20, 21, 24, 25, 28, 29, 61, 62, 63, 64,81, 82)) 

AND CTRNS.CANCELLED=0 --AND CLNTC.DEFINITION_='TURGAY'






GO


