USE [TIGERDB]
GO

/****** Object:  View [dbo].[1STC_321_01_VADELICARIBAKIYELER_120]    Script Date: 27.04.2022 15:57:36 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER VIEW [dbo].[1STC_321_01_VADELICARIBAKIYELER_120] AS

SELECT

CLC.CODE [CH KODU]
,CLC.DEFINITION_ [CH UNVAN]

,[CH TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_321_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0)
---,[TL ORT VADE]   = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_321_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (0,160))

,[CH USD BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_321_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0)
---,[USD ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_321_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (1))

,[CH EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_321_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0)
--,[EUR ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_321_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (20))

,[TOPLAM TL BAKIYE] = (SELECT ISNULL(ROUND(CLC2.DEBIT - CLC2.CREDIT,3),0) FROM LV_321_01_CLCARD CLC2 WHERE CLC2.LOGICALREF = CLC.LOGICALREF)
--,[TOPLAM TL ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_321_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID)

FROM LG_321_CLCARD CLC
WHERE CLC.ACTIVE = 0 AND CLC.CARDTYPE <> 22 AND CLC.CODE LIKE '120%'
GO


