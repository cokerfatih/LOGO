USE [TIGERDB]
GO

/****** Object:  View [dbo].[1MT_003_MIZAN]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[1MT_003_MIZAN] AS

SELECT 
	
	LEFT(EMU.CODE,3) [Kebir],
	EMU.CODE [Hesap Kodu],
	EMU.DEFINITION_ [Hesap Adı],
	CASE TOT.MONTH_ WHEN 1 THEN '01-Ocak' WHEN 2 THEN '02-Şubat' WHEN 3 THEN '03-Mart' WHEN 4 THEN '04-Nisan' WHEN 5 THEN '05-Mayıs' WHEN 6 THEN '06-Haziran' 
									 WHEN 7 THEN '07-Temmuz' WHEN 8 THEN '08-Ağustos' WHEN 9 THEN '09-Eylül' WHEN 10 THEN '10-Ekim' WHEN 11 THEN '11-Kasım' WHEN 12 THEN '12-Aralık'
									 ELSE '00-Açılış' END [Ay],
	CASE TOT.MONTH_ WHEN 1 THEN '01-Ocak' WHEN 2 THEN '02-Şubat' WHEN 3 THEN '03-Mart' WHEN 4 THEN '04-Nisan' WHEN 5 THEN '05-Mayıs' WHEN 6 THEN '06-Haziran' 
									 WHEN 7 THEN '07-Temmuz' WHEN 8 THEN '08-Ağustos' WHEN 9 THEN '09-Eylül' WHEN 10 THEN '10-Ekim' WHEN 11 THEN '11-Kasım' WHEN 12 THEN '12-Aralık'
									 ELSE '00-Açılış' END [Ay_secim],
	TOT.DEBIT [Borç],
	TOT.CREDIT [Alacak],
	TOT.DEBIT-TOT.CREDIT [Bakiye],
	CASE WHEN TOT.CURRTYP=0 THEN 'TL' ELSE CURR.CURCODE END [Döviz],
	TOT.BRANCH [İşyeri],
	EMU.SPECODE [OZEL KOD],
	TOT.TOTTYPE
	

FROM LV_003_01_EMUHTOT TOT 
		LEFT JOIN LG_003_EMUHACC EMU ON TOT.ACCOUNTREF=EMU.LOGICALREF 
		LEFT JOIN L_CURRENCYLIST CURR ON CURR.CURTYPE=TOT.CURRTYP
		
WHERE TOT.TOTTYPE=1
GO

/****** Object:  View [dbo].[1MTL_003_01_MIZAN]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[1MTL_003_01_MIZAN] AS 

SELECT
EMF.FICHENO [Fiş No],
EML.DATE_ [Fiş Tarihi],
month(EML.DATE_) [AY],
YEAR(EML.DATE_) [YIL],
EML.KEBIRCODE [Kebir Hesap],
LEFT(EMU.CODE,1) [Grup],
EMU.CODE [Hesap Kodu],
EMU.DEFINITION_ [Hesap Adı],
--CASE WHEN EML.TRCURR=0 THEN 'TL'
--           WHEN EML.TRCURR=1 THEN 'USD'
--           WHEN EML.TRCURR=20 THEN 'EUR'
--           WHEN EML.TRCURR=17 THEN 'GBP'
--           ELSE 'Tanımsız' END [Döviz],
CASE   WHEN EML.SIGN=0 THEN 'Borç' ELSE 'Alacak' END [Hareket],
EML.DEBIT [Borç],
EML.CREDIT [Alacak],

EML.DEBIT-EML.CREDIT [Bakiye],
EML.LINEEXP [Satır Açıklaması],
--CASE WHEN EML.SIGN=0 AND EML.TRNET<>0 THEN EML.TRNET 
--           WHEN EML.SIGN=1 AND EML.TRNET<>0 THEN EML.TRNET*-1
--           WHEN EML.SIGN=0 AND EML.TRNET=0 THEN EML.DEBIT+EML.CREDIT 
--           WHEN EML.SIGN=1 AND EML.TRNET=0 THEN (EML.DEBIT+EML.CREDIT)*-1
--           END [İD Bakiye],
EMF.GENEXP1 [Genel Açıklama]

FROM LG_003_01_EMFLINE EML 
             LEFT JOIN LG_003_EMUHACC EMU ON EML.ACCOUNTREF=EMU.LOGICALREF
             LEFT JOIN LG_003_01_EMFICHE EMF ON EMF.LOGICALREF=EML.ACCFICHEREF

WHERE EML.CANCELLED=0


GO

/****** Object:  View [dbo].[DST_003_01_ALISLAR]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[DST_003_01_ALISLAR] AS
SELECT
	
	CASE 
	WHEN STL.TRCODE IN (1) THEN 'Mal Alım' WHEN STL.TRCODE IN (4) THEN 'Alınan Hizmet' 
	WHEN STL.TRCODE IN (5) THEN 'Konsinye Giriş'WHEN STL.TRCODE=6 THEN 'Alım İade Faturası' ELSE 'Diğer' END [Hareket],	
	STL.SOURCEINDEX [Ambar No],
	AMB.NAME [Ambar Adı],
	ISY.NR [İşyeri No],
	ISY.NAME [İşyeri Adı],
	MONTH(STF.DATE_) [Ay (İrsaliye)],
	MONTH(INV.DATE_) [Ay (Fatura)],
	INV.DATE_ [Fatura Tarihi],
	INV.FICHENO [Fatura No],
	INV.DOCODE [Fatura Belge No],
	INV.CYPHCODE [Fatura Yetki Kodu],
	CASE WHEN STL.INVOICEREF=0 THEN 'Faturalanmamış' ELSE 'Faturalanmış' END [Faturalanma],
	
	STF.DATE_ [İrsaliye Tarihi],
	STF.FICHENO [İrsaliye No],
	STF.DOCODE [İrsaliye Belge No],
	STF.CYPHCODE [İrsaliye Yetki Kodu],
	STL.TRCODE [Fiş Tütü],
	CLC.CODE [Cari Kodu],
	CLC.DEFINITION_ [Cari Adı],
	CLC.TRADINGGRP [Cari TİG],
	CLC.CYPHCODE [Cari Yetki Kodu],
	CLC.CITYCODE [Cari Şehir Kodu],
	CLC.CITY [Cari Şehir],
	CLC.COUNTRY [Cari Ülke],
	CASE WHEN STL.LINETYPE=0 THEN 'Malzeme' WHEN STL.LINETYPE=1 THEN 'Promosyon' WHEN STL.LINETYPE=4 THEN 'Hizmet' ELSE 'Diğer' END [Satır], 
	
	ISNULL(ITM.CODE,'')+ISNULL(SRV.CODE,'') [Stok/Hizmet Kodu],
	ISNULL(ITM.NAME,'')+ISNULL(SRV.DEFINITION_,'') [Stok/Hizmet Adı],
	ITM.PRODUCERCODE [Stok Üretici kodu],
	SPE.DEFINITION_ [Stok Grup Adı],
	CASE WHEN STL.TRCODE=6 THEN STL.AMOUNT*-1 ELSE STL.AMOUNT END [Miktar],
	UNT.CODE [Satır Birim],
	
	CASE WHEN STL.LINETYPE=1 THEN 0 ELSE (CASE WHEN STL.TRCODE=6 THEN STL.VATMATRAH*-1 ELSE STL.VATMATRAH END) END [Matrah],
	CASE WHEN STL.LINETYPE=1 THEN 0 ELSE (CASE WHEN STL.TRCODE=6 THEN STL.VATAMNT*-1 ELSE STL.VATAMNT END) END [KDV],
	CASE WHEN STL.LINETYPE=1 THEN 0 ELSE (CASE WHEN STL.TRCODE=6 THEN STL.DISTDISC*-1 ELSE STL.DISTDISC END) END [İndirim],
	CASE WHEN STL.LINETYPE=1 THEN 0 ELSE (CASE WHEN STL.TRCODE=6 THEN STL.DISTEXP ELSE STL.DISTEXP END) END [Masraf],
	CLC_2.CODE [Sevkiyat Cari Kodu],
	CLC_2.DEFINITION_ [Sevkiyat Cari Adı],
	INV.GENEXP1 + INV.GENEXP2 [Fatura Açıklama],
	PAY.CODE [Ödeme Planı],

	USR.NAME [Ekleyen(irsaliye)],
	SHP.NAME [Sevkıyat Adresi],
	SHP.CITYCODE [Sevk Adresi Şehir Kodu],
	SLS.DEFINITION_ [Satış Elemanı]

FROM LG_003_01_STLINE STL WITH(NOLOCK)
		LEFT JOIN LG_003_ITEMS ITM WITH(NOLOCK) ON STL.STOCKREF=ITM.LOGICALREF AND STL.LINETYPE IN (0,1)
		LEFT JOIN LG_003_SRVCARD SRV WITH(NOLOCK) ON STL.STOCKREF=SRV.LOGICALREF AND STL.LINETYPE=4
		LEFT JOIN LG_003_CLCARD CLC WITH(NOLOCK) ON CLC.LOGICALREF=STL.CLIENTREF
		LEFT JOIN LG_003_01_INVOICE INV WITH(NOLOCK) ON INV.LOGICALREF=STL.INVOICEREF
		LEFT JOIN LG_003_01_STFICHE STF WITH(NOLOCK) ON STF.LOGICALREF=STL.STFICHEREF
		LEFT JOIN LG_003_UNITSETL UNT WITH(NOLOCK) ON STL.UOMREF=UNT.LOGICALREF
		LEFT JOIN LG_003_CLCARD CLC_2 WITH(NOLOCK) ON CLC_2.LOGICALREF=INV.RECVREF
		LEFT JOIN LG_003_SPECODES SPE WITH(NOLOCK) ON SPE.SPECODE=ITM.STGRPCODE AND SPE.CODETYPE=4 AND SPE.SPECODETYPE=0
		LEFT JOIN LG_003_PAYPLANS PAY WITH(NOLOCK) ON INV.PAYDEFREF=PAY.LOGICALREF
		LEFT JOIN LG_003_ITMUNITA ITU2  WITH(NOLOCK) ON ITU2.ITEMREF=ITM.LOGICALREF AND ITU2.LINENR=2
		LEFT JOIN LG_003_ITMUNITA ITU3  WITH(NOLOCK) ON ITU3.ITEMREF=ITM.LOGICALREF AND ITU3.LINENR=3
		LEFT JOIN L_CAPIWHOUSE AMB ON AMB.NR=STL.SOURCEINDEX AND AMB.FIRMNR=020
		LEFT JOIN L_CAPIDIV ISY ON ISY.NR=INV.BRANCH AND ISY.FIRMNR=020
		LEFT JOIN L_CAPIUSER USR ON USR.NR=STF.CAPIBLOCK_CREATEDBY
		LEFT JOIN LG_003_SHIPINFO SHP WITH(NOLOCK) ON SHP.LOGICALREF=STF.SHIPINFOREF
		LEFT JOIN LG_SLSMAN SLS ON SLS.LOGICALREF=STF.SALESMANREF
		

WHERE STL.TRCODE IN (1,4,6,5) AND STL.CANCELLED=0  AND STL.LINETYPE IN (0,1,4) 
GO

/****** Object:  View [dbo].[DST_003_01_CARIBAKIYELER_AYBAZINDA]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE VIEW [dbo].[DST_003_01_CARIBAKIYELER_AYBAZINDA]
AS


 SELECT

CLC.CODE [CH KODU]
,CLC.DEFINITION_ [CH UNVAN]
	,CLC2.CODE [Grup Kodu]
	,CLC2.DEFINITION_ [Grup Firma Adı]
,CASE WHEN CLC.CODE LIKE '120%'THEN '120'WHEN CLC.CODE LIKE '320%' THEN '320'WHEN CLC.CODE LIKE '128%' THEN '128'WHEN CLC.CODE LIKE '329%' THEN '329'ELSE 'DİGER' END 'CARİ GRUP'

,[CH TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0)
,[OCAK TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200101' and '20200131')
,[ŞUBAT TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200201' and '20200228')
,[MART TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200301' and '20200331')
,[NİSAN TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200401' and '20200430')
,[MAYIS TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200501' and '20200531')
,[HAZİRAN TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200601' and '20200630')
,[TEMMUZ TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200701' and '20200731')
,[AĞUSTOS TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200801' and '20200831')
,[EYLÜL TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200901' and '20200930')
,[EKİM TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20201001' and '20201031')
,[KASIM TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20201101' and '20201130')
,[ARALIK TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20201201' and '20201231')
--,[TL SATIS ORT VADE]   = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_003_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (0,160))
--,[TL ALIS ORT VADE]   = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_003_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 1 AND PYT.TRCODE = 1 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (0,160))

,[CH USD BAKIYE] =     (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0)
,[OCAK USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200101' and '20200131')
,[ŞUBAT USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200201' and '20200228')
,[MART USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200301' and '20200331')
,[NİSAN USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200401' and '20200430')
,[MAYIS USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200501' and '20200531')
,[HAZİRAN USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200601' and '20200630')
,[TEMMUZ USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200701' and '20200731')
,[AĞUSTOS USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200801' and '20200831')
,[EYLÜL USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200901' and '20200930')
,[EKİM USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20201001' and '20201031')
,[KASIM USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20201101' and '20201130')
,[ARALIK USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20201201' and '20201231')
--,[CH USD_KUR FARKI]  =(SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.AMOUNT WHEN 1 THEN CLF.AMOUNT * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.TRCODE IN(6)AND CLF.DATE_ BETWEEN '20200101'AND '20201231' )
--,[USD SATIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_003_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (1))
--,[USD ALIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_003_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 1 AND PYT.TRCODE = 1 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (1))

,[CH EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0)
,[OCAK  EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200101' and '20200131')
,[ŞUBAT EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200201' and '20200228')
,[MART EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200301' and '20200331')
,[NİSAN EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200401' and '20200430')
,[MAYIS EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200501' and '20200531')
,[HAZİRAN EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200601' and '20200630')
,[TEMMUZ EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200701' and '20200731')
,[AĞUSTOS EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200801' and '20200831')
,[EYLÜL EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20200901' and '20200930')
,[EKİM EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20201001' and '20201031')
,[KASIM EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20201101' and '20201130')
,[ARALIK EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20201201' and '20201231')
--,[CH EURO_KUR FARKI]  =(SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.AMOUNT WHEN 1 THEN CLF.AMOUNT * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.TRCODE IN(6)AND CLF.DATE_ BETWEEN '20200101'AND '20201231' ) 
--,[EUR SATIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_003_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (20))
--,[EUR ALIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_003_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 1 AND PYT.TRCODE = 1 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (20))

,[TOPLAM TL BAKIYE] = (SELECT ISNULL(ROUND(CLC2.DEBIT - CLC2.CREDIT,3),0) FROM LV_003_01_CLCARD CLC2 WHERE CLC2.LOGICALREF = CLC.LOGICALREF)
,[TOPLAM TL YENI] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200101' and '20201231' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200101' AND '20201231' AND CLIENTREF=CLC.LOGICALREF),0)
,[OCAK] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200101' and '20200131' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200101' AND '20200131' AND CLIENTREF=CLC.LOGICALREF),0)
,[ŞUBAT] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200201' and '20200228' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200201' and '20200228' AND CLIENTREF=CLC.LOGICALREF),0)
,[MART] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200301' and '20200331' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200301' and '20200331' AND CLIENTREF=CLC.LOGICALREF),0)
,[NİSAN] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200401' and '20200430' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200401' and '20200430' AND CLIENTREF=CLC.LOGICALREF),0)
,[MAYIS] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200501' and '20200531' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200501' and '20200531' AND CLIENTREF=CLC.LOGICALREF),0)
,[HAZİRAN] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200601' and '20200630' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200601' and '20200630' AND CLIENTREF=CLC.LOGICALREF),0)
,[TEMMUZ] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200701' and '20200731' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200701' and '20200731' AND CLIENTREF=CLC.LOGICALREF),0)
,[AĞUSTOS] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200801' and '20200831' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200801' and '20200831' AND CLIENTREF=CLC.LOGICALREF),0)
,[EYLÜL] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200901' and '20200930' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200901' and '20200930' AND CLIENTREF=CLC.LOGICALREF),0)
,[EKİM] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20201001' and '20201031' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20201001' and '20201031' AND CLIENTREF=CLC.LOGICALREF),0)
,[KASIM] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20201101' and '20201130' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20201101' and '20201130'AND CLIENTREF=CLC.LOGICALREF),0)
,[ARALIK] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20201201' and '20201231' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20201201' and '20201231' AND CLIENTREF=CLC.LOGICALREF),0)
----,[TOPLAM TL SATIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_003_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID)
--,[TOPLAM TL ALS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_003_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 1 AND PYT.TRCODE = 1 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID)
,ISNULL(convert(varchar, (SELECT MAX(DATE_)  FROM LG_003_01_CLFLINE WHERE  CLIENTREF=CLC.LOGICALREF), 104),'') AS[SON HAREKET TARIHI]
FROM LG_003_CLCARD CLC
LEFT JOIN LG_003_CLCARD CLC2 WITH(NOLOCK) ON CLC2.LOGICALREF=CLC.PARENTCLREF AND CLC2.CARDTYPE=4
WHERE CLC.ACTIVE = 0 AND CLC.CARDTYPE <> 22 AND
  (SUBSTRING(CLC.CODE, 1, 3) = '120' OR
   SUBSTRING(CLC.CODE, 1, 3) = '320' OR
   SUBSTRING(CLC.CODE, 1, 3) = '128' OR
   SUBSTRING(CLC.CODE, 1, 3) = '329' OR 
   SUBSTRING(CLC.CODE, 1, 3) = '136' OR
   SUBSTRING(CLC.CODE, 1, 3) = '336' OR
   SUBSTRING(CLC.CODE, 1, 3) = '770' OR
   SUBSTRING(CLC.CODE, 1, 3) = '309')


   AND ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200101' and '20201231' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200101' AND '20201231' AND CLIENTREF=CLC.LOGICALREF),0)>0


GO

/****** Object:  View [dbo].[DST_003_01_SATISLAR]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




--USE [TIGERDB]
--GO

--/****** Object:  View [dbo].[DST_003_01_SATISLAR]    Script Date: 23.06.2020 22:58:17 ******/
--SET ANSI_NULLS ON
--GO

--SET QUOTED_IDENTIFIER ON
----GO

CREATE VIEW [dbo].[DST_003_01_SATISLAR] AS 

SELECT
	--[GRUP KODU] =(SELECT CODE FROM LG_003_CLCARD CLC2 WHERE CLC.PARENTCLREF=CLC2.LOGICALREF and CARDTYPE=4) ,
	CLC2.CODE [Grup Kodu],
	CLC2.DEFINITION_ [Grup Firma Adı],
	CLC.PARENTCLREF,
	CLC.SPECODE2[Satış Elemanı],
	LEFT(CLC.CODE,6) [Plaka],
	CASE 
	WHEN INV.TRCODE IN (1) THEN 'Satınalma'
	WHEN INV.TRCODE IN (3) THEN 'Toptan Satış İade'
	WHEN INV.TRCODE IN (8) THEN 'Toptan Satış'
	
	
	ELSE 'Diğer' END [Fatura Türü],
	MONTH(INV.DATE_) [Ay],
	DAY(INV.DATE_) [Gün],
	year(ınv.date_) [Yıl],
	INV.DATE_ [Fatura Tarihi],
	INV.FICHENO [Fatura No],
	INV.DOCODE [Fatura Belge No],
	STF.DATE_ [İrsaliye Tarihi],
	STF.FICHENO [İrsaliye No],
	STF.DOCODE [İrsaliye Belge No],
	CLC.CODE [Cari Kodu],
	CLC.DEFINITION_ [Cari Adı],
	CLC.CITY [Cari Şehir],
	CLC.COUNTRY [Cari Ülke],
	CASE WHEN STL.LINETYPE=0 THEN 'Malzeme' WHEN STL.LINETYPE=1 THEN 'Promosyon' WHEN STL.LINETYPE=4 THEN 'Hizmet' ELSE 'Diğer' END [Satır], 
	STL.TRCODE,
	ISNULL(ITM.CODE,'')+ISNULL(SRV.CODE,'') [Stok/Hizmet Kodu],
	ISNULL(ITM.NAME,'')+ISNULL(SRV.DEFINITION_,'') [Stok/Hizmet Adı],
	ITM.PRODUCERCODE [Stok Üretici kodu],
	SPE.DEFINITION_ [Stok Grup Adı],
	STL.AMOUNT  [İadesiz Miktar],
	CASE WHEN STL.TRCODE IN (3,8) THEN STL.AMOUNT*-1 ELSE STL.AMOUNT END [İadeli Miktar],
	UNT.CODE [Satır Birim],	
	CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.PRICE END [Birim Fiyat],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.VATMATRAH END [KDV Matrah],
	CASE WHEN INV.TRCODE IN (8) THEN  STL.VATMATRAH WHEN INV.TRCODE IN (1,3) THEN  STL.VATMATRAH*-1 ELSE 0 END [KDV Matrah],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.VATAMNT END [KDV],
	CASE WHEN INV.TRCODE IN (8) THEN STL.VATAMNT WHEN INV.TRCODE IN (1,3) THEN  STL.VATAMNT*-1 ELSE 0 END [KDV],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.DISTDISC END [İndirim],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.DISTEXP END [Masraf],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.VATMATRAH+STL.VATAMNT END [KDV'li Tutar],
	CASE WHEN INV.TRCODE IN (8) THEN STL.VATMATRAH+STL.VATAMNT WHEN INV.TRCODE IN (1,3) THEN (STL.VATMATRAH+STL.VATAMNT)*-1 ELSE 0 END [KDV'li Tutar],
	INV.GENEXP1 + INV.GENEXP2 [Fatura Açıklama],
	STL.LINEEXP [Satır Açıklama],
	PAY.CODE [Ödeme Planı]
	
	
FROM LG_003_01_STLINE STL WITH(NOLOCK)
		LEFT JOIN LG_003_ITEMS ITM WITH(NOLOCK) ON STL.STOCKREF=ITM.LOGICALREF AND STL.LINETYPE IN (0,1)
		LEFT JOIN LG_003_SRVCARD SRV WITH(NOLOCK) ON STL.STOCKREF=SRV.LOGICALREF AND STL.LINETYPE=4
		LEFT JOIN LG_003_CLCARD CLC WITH(NOLOCK) ON CLC.LOGICALREF=STL.CLIENTREF --AND CLC.CODE LIKE '120%'
		LEFT JOIN LG_003_CLCARD CLC2 WITH(NOLOCK) ON CLC2.LOGICALREF=CLC.PARENTCLREF AND CLC2.CARDTYPE=4
	    LEFT JOIN LG_003_01_INVOICE INV WITH(NOLOCK) ON INV.LOGICALREF=STL.INVOICEREF
		LEFT JOIN LG_003_01_STFICHE STF WITH(NOLOCK) ON STF.LOGICALREF=STL.STFICHEREF
		LEFT JOIN LG_003_UNITSETL UNT WITH(NOLOCK) ON STL.UOMREF=UNT.LOGICALREF
		LEFT JOIN LG_003_SPECODES SPE WITH(NOLOCK) ON SPE.SPECODE=ITM.STGRPCODE AND SPE.CODETYPE=4 AND SPE.SPECODETYPE=0
		LEFT JOIN LG_003_PAYPLANS PAY WITH(NOLOCK) ON INV.PAYDEFREF=PAY.LOGICALREF
		LEFT JOIN LG_003_ITMUNITA ITU2  WITH(NOLOCK) ON ITU2.ITEMREF=ITM.LOGICALREF AND ITU2.LINENR=2
		LEFT JOIN LG_003_ITMUNITA ITU3  WITH(NOLOCK) ON ITU3.ITEMREF=ITM.LOGICALREF AND ITU3.LINENR=3
		LEFT JOIN L_CAPIWHOUSE AMB ON AMB.NR=STL.SOURCEINDEX AND AMB.FIRMNR=003
		LEFT JOIN L_CAPIUSER USR ON USR.NR=STF.CAPIBLOCK_CREATEDBY
		LEFT JOIN LG_SLSMAN SLS ON SLS.LOGICALREF=STF.SALESMANREF
		

WHERE INV.TRCODE IN (1,3,8) AND INV.CANCELLED=0 AND STL.LINETYPE IN (0,1,4) AND STL.BILLED=1 and (ITM.CODE LIKE '150%' OR ITM.CODE LIKE '151%' OR ITM.CODE LIKE '152%' OR ITM.CODE LIKE '153%') AND (CLC.CODE BETWEEN '120.01.001.01' AND '120.89.001.01')


GO

/****** Object:  View [dbo].[DST_004_01_ALISLAR]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

--USE [LOGO_DB]
--GO

--/****** Object:  View [dbo].[DST_004_01_ALISLAR]    Script Date: 27.12.2021 12:00:12 ******/
--SET ANSI_NULLS ON
--GO

--SET QUOTED_IDENTIFIER ON
--GO


CREATE view [dbo].[DST_004_01_ALISLAR] AS

SELECT
	
	CASE 
	WHEN STL.TRCODE IN (1) THEN 'Mal Alım' WHEN STL.TRCODE IN (4) THEN 'Alınan Hizmet' 
	WHEN STL.TRCODE IN (5) THEN 'Konsinye Giriş'WHEN STL.TRCODE=6 THEN 'Alım İade Faturası' ELSE 'Diğer' END [Hareket],	
	--STL.SOURCEINDEX [Ambar No],
	--AMB.NAME [Ambar Adı],
	--ISY.NR [İşyeri No],
	--ISY.NAME [İşyeri Adı],
	
	--CASE WHEN CLC.ISPERSCOMP=1 THEN CLC.TCKNO ELSE CLC.TAXNR END [TC KİMLİK NO/VERGİ NO] ,
	--(STF.DATE_) [Ay (İrsaliye)],
--	MONTH(INV.DATE_) [Ay (Fatura)],
--	YEAR(STF.DATE_) [Yıl (İrsaliye)],
--	YEAR(INV.DATE_) [Yıl (Fatura)],
	INV.DATE_ [Fatura Tarihi],
	INV.FICHENO [Fatura No],
	--INV.DOCODE [Fatura Belge No],
	--INV.CYPHCODE [Fatura Yetki Kodu],
	CASE WHEN STL.INVOICEREF=0 THEN 'Faturalanmamış' ELSE 'Faturalanmış' END [Faturalanma],
	
	STF.DATE_ [İrsaliye Tarihi],
	STF.FICHENO [İrsaliye No],
	--STF.DOCODE [İrsaliye Belge No],
	--STF.CYPHCODE [İrsaliye Yetki Kodu],
	--STL.TRCODE [Fiş Türü],
	CLC.CODE [Cari Kodu],
	CLC.DEFINITION_ [Cari Adı],
	--CLC.TRADINGGRP [Cari TİG],
	--CLC.CYPHCODE [Cari Yetki Kodu],
	--CLC.CITYCODE [Cari Şehir Kodu],
	--CLC.CITY [Cari Şehir],
	--CLC.COUNTRY [Cari Ülke],
	CASE WHEN STL.LINETYPE=0 THEN 'Malzeme' WHEN STL.LINETYPE=1 THEN 'Promosyon' WHEN STL.LINETYPE=4 THEN 'Hizmet' ELSE 'Diğer' END [Satır], 
	
	ISNULL(ITM.CODE,'')+ISNULL(SRV.CODE,'') [Stok/Hizmet Kodu],
	ISNULL(ITM.NAME,'')+ISNULL(SRV.DEFINITION_,'') [Stok/Hizmet Adı],
	--ITM.PRODUCERCODE [Stok Üretici kodu],
	--SPE.DEFINITION_ [Stok Grup Adı],
	CASE WHEN STL.TRCODE=6 THEN STL.AMOUNT*-1 ELSE STL.AMOUNT END [Miktar],
	 --( ITU2.CONVFACT1*STL.AMOUNT) [KG],
	 STL.PRICE[Birim Fiyat],
	 --STL.VATMATRAH/( ITU2.CONVFACT1*STL.AMOUNT) [KG Birim Fiyat],
	UNT.CODE [Satır Birim],
	
	CASE WHEN STL.LINETYPE=1 THEN 0 ELSE (CASE WHEN STL.TRCODE=6 THEN STL.VATMATRAH*-1 ELSE STL.VATMATRAH END) END [Matrah],
	CASE WHEN STL.LINETYPE=1 THEN 0 ELSE (CASE WHEN STL.TRCODE=6 THEN STL.VATAMNT*-1 ELSE STL.VATAMNT END) END [KDV],
	CASE WHEN STL.LINETYPE=1 THEN 0 ELSE (CASE WHEN STL.TRCODE=6 THEN STL.DISTDISC*-1 ELSE STL.DISTDISC END) END [İndirim],
	CASE WHEN STL.LINETYPE=1 THEN 0 ELSE (CASE WHEN STL.TRCODE=6 THEN STL.DISTEXP ELSE STL.DISTEXP END) END [Masraf],
--	CLC_2.CODE [Sevkiyat Cari Kodu],
	--CLC_2.DEFINITION_ [Sevkiyat Cari Adı],
	--INV.GENEXP1 + INV.GENEXP2 [Fatura Açıklama],
	--PAY.CODE [Ödeme Planı],

	USR.NAME [Ekleyen(irsaliye)],
	--SHP.NAME [Sevkıyat Adresi],
	--SHP.CITYCODE [Sevk Adresi Şehir Kodu],
	--SLS.DEFINITION_ [Satış Elemanı],
	SPE.DEFINITION_[Ozel Kod1],
	SPE2.DEFINITION_ [Ozel Kod2],
	SPE3.DEFINITION_[Ozel Kod3],
	SPE4.DEFINITION_[Ozel Kod4],
	SPE5.DEFINITION_[Ozel Kod5]

FROM LG_004_01_STLINE STL WITH(NOLOCK)
		LEFT JOIN LG_004_ITEMS ITM WITH(NOLOCK) ON STL.STOCKREF=ITM.LOGICALREF AND STL.LINETYPE IN (0,1)
		LEFT JOIN LG_004_SRVCARD SRV WITH(NOLOCK) ON STL.STOCKREF=SRV.LOGICALREF AND STL.LINETYPE=4
		LEFT JOIN LG_004_CLCARD CLC WITH(NOLOCK) ON CLC.LOGICALREF=STL.CLIENTREF
		LEFT JOIN LG_004_01_INVOICE INV WITH(NOLOCK) ON INV.LOGICALREF=STL.INVOICEREF
		LEFT JOIN LG_004_01_STFICHE STF WITH(NOLOCK) ON STF.LOGICALREF=STL.STFICHEREF
		LEFT JOIN LG_004_UNITSETL UNT WITH(NOLOCK) ON STL.UOMREF=UNT.LOGICALREF
		LEFT JOIN LG_004_CLCARD CLC_2 WITH(NOLOCK) ON CLC_2.LOGICALREF=INV.RECVREF
		LEFT JOIN LG_004_SPECODES SPE WITH(NOLOCK) ON SPE.SPECODE=ITM.SPECODE AND SPE.CODETYPE=1 AND SPE.SPECODETYPE=1 AND SPE.SPETYP1=1
		LEFT JOIN LG_004_SPECODES SPE2 WITH(NOLOCK) ON SPE2.SPECODE=ITM.SPECODE2 AND SPE2.CODETYPE=1 AND SPE2.SPECODETYPE=1 AND SPE2.SPETYP2=1
		LEFT JOIN LG_004_SPECODES SPE3 WITH(NOLOCK) ON SPE3.SPECODE=ITM.SPECODE3 AND SPE3.CODETYPE=1 AND SPE3.SPECODETYPE=1 AND SPE3.SPETYP3=1
		LEFT JOIN LG_004_SPECODES SPE4 WITH(NOLOCK) ON SPE4.SPECODE=ITM.SPECODE4 AND SPE4.CODETYPE=1 AND SPE4.SPECODETYPE=1 AND SPE4.SPETYP4=1
		LEFT JOIN LG_004_SPECODES SPE5 WITH(NOLOCK) ON SPE5.SPECODE=ITM.SPECODE5 AND SPE5.CODETYPE=1 AND SPE5.SPECODETYPE=1 AND SPE5.SPETYP5=1
		LEFT JOIN LG_004_PAYPLANS PAY WITH(NOLOCK) ON INV.PAYDEFREF=PAY.LOGICALREF
		LEFT JOIN LG_004_ITMUNITA ITU2  WITH(NOLOCK) ON ITU2.ITEMREF=ITM.LOGICALREF AND ITU2.LINENR=2
		LEFT JOIN LG_004_ITMUNITA ITU3  WITH(NOLOCK) ON ITU3.ITEMREF=ITM.LOGICALREF AND ITU3.LINENR=3
		LEFT JOIN L_CAPIWHOUSE AMB ON AMB.NR=STL.SOURCEINDEX AND AMB.FIRMNR=004
		LEFT JOIN L_CAPIDIV ISY ON ISY.NR=INV.BRANCH AND ISY.FIRMNR=004
		LEFT JOIN L_CAPIUSER USR ON USR.NR=STF.CAPIBLOCK_CREATEDBY
		LEFT JOIN LG_004_SHIPINFO SHP WITH(NOLOCK) ON SHP.LOGICALREF=STF.SHIPINFOREF
		LEFT JOIN LG_SLSMAN SLS ON SLS.LOGICALREF=STF.SALESMANREF
		

WHERE STL.TRCODE IN (1,13,14) AND STL.CANCELLED=0  AND STL.LINETYPE IN (0,4) --AND SPE5.SPECODE <>'SİL' AND ITM.CARDTYPE NOT IN (22,4) --AND INV.FICHENO='EFT2020000008660'

--SELECT * FROM LG_004_SPECODES


GO

/****** Object:  View [dbo].[DST_004_01_CARIBAKIYELER]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

--USE [TIGERDB]
--GO

--/****** Object:  View [dbo].[GNC_004_01_CARIBAKIYELER]    Script Date: 1.02.2022 13:27:01 ******/
--SET ANSI_NULLS ON
--GO

--SET QUOTED_IDENTIFIER ON
--GO








CREATE VIEW [dbo].[DST_004_01_CARIBAKIYELER]
AS
 SELECT

CLC.CODE [CH KODU]
,CLC.DEFINITION_ [CH UNVAN]
,CASE WHEN CLC.CODE LIKE '120%'THEN '120'WHEN CLC.CODE LIKE '320%' THEN '320'WHEN CLC.CODE LIKE '128%' THEN '128'WHEN CLC.CODE LIKE '329%' THEN '329'WHEN CLC.CODE LIKE '340%' THEN '340'WHEN CLC.CODE LIKE '159%'THEN '159'WHEN CLC.CODE LIKE '129%'THEN '129'ELSE 'DİGER' END 'CARİ GRUP'

,[CH TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.PAIDINCASH=0)
,[CH TL BAKIYE_BORC]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN 0 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.PAIDINCASH=0)
,[CH TL BAKIYE_ALACAK]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN 0 WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.PAIDINCASH=0)
,[TL SATIS ORT VADE]   = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_004_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (0,160))
,[TL ALIS ORT VADE]   = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_004_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 1 AND PYT.TRCODE = 1 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (0,160))

,[CH USD BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0)
,[CH USD BAKIYE_BORC] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN 0 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0)
,[CH USD BAKIYE_ALACAK] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN 0 WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0)
,[USD SATIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_004_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (1))
,[USD ALIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_004_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 1 AND PYT.TRCODE = 1 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (1))

,[CH EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0)
,[CH EUR BAKIYE_BORC] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN 0 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0)
,[CH EUR BAKIYE_ALACAK] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN 0 WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0)
,[EUR SATIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_004_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (20))
,[EUR ALIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_004_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 1 AND PYT.TRCODE = 1 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (20))


,[TOPLAM TL BORÇ BAKIYE] = (SELECT ISNULL(ROUND(CLC2.DEBIT,3),0) FROM LV_004_01_CLCARD CLC2 WHERE CLC2.LOGICALREF = CLC.LOGICALREF)
,[TOPLAM TL ALACAK BAKIYE] = (SELECT ISNULL(ROUND(CLC2.CREDIT,3)*-1,0) FROM LV_004_01_CLCARD CLC2 WHERE CLC2.LOGICALREF = CLC.LOGICALREF)
,[TOPLAM TL BAKIYE] = (SELECT ISNULL(ROUND(CLC2.DEBIT - CLC2.CREDIT,3),0) FROM LV_004_01_CLCARD CLC2 WHERE CLC2.LOGICALREF = CLC.LOGICALREF)
,[TOPLAM TL SATIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_004_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID)
,[TOPLAM TL ALS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_004_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 1 AND PYT.TRCODE = 1 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID)

FROM LG_004_CLCARD CLC
WHERE CLC.ACTIVE = 0 AND CLC.CARDTYPE <> 22


--  (SUBSTRING(CLC.CODE, 1, 3) = '120' OR
--   SUBSTRING(CLC.CODE, 1, 3) = '320' OR
--   SUBSTRING(CLC.CODE, 1, 3) = '128' OR
--   SUBSTRING(CLC.CODE, 1, 3) = '329' OR 
--   SUBSTRING(CLC.CODE, 1, 3) = '136' OR
--   SUBSTRING(CLC.CODE, 1, 3) = '336' OR
--    SUBSTRING(CLC.CODE, 1, 3) = '129' OR
--	 SUBSTRING(CLC.CODE, 1, 3) = '159' OR
--   SUBSTRING(CLC.CODE, 1, 3) = '770' OR
--   SUBSTRING(CLC.CODE, 1, 3) = '309' OR
--   SUBSTRING(CLC.CODE, 1, 3) = '340')--and clc.code='120.34.0026'
--GO


GO

/****** Object:  View [dbo].[DST_004_01_CARIBAKIYELER_AYBAZINDA]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

--USE [TIGERDB]
--GO

--/****** Object:  View [dbo].[DST_004_01_CARIBAKIYELER_AYBAZINDA]    Script Date: 11.02.2021 15:26:34 ******/
--SET ANSI_NULLS ON
--GO

--SET QUOTED_IDENTIFIER ON
--GO

----USE [TIGERDB]
----GO

----/****** Object:  View [dbo].[DST_004_01_CARIBAKIYELER_AYBAZINDA]    Script Date: 11.02.2021 15:09:58 ******/
----SET ANSI_NULLS ON
----GO

----SET QUOTED_IDENTIFIER ON
----GO

CREATE VIEW [dbo].[DST_004_01_CARIBAKIYELER_AYBAZINDA]
AS


 SELECT

CLC.CODE [CH KODU]
,CLC.DEFINITION_ [CH UNVAN]
	,CLC2.CODE [Grup Kodu]
	,CLC2.DEFINITION_ [Grup Firma Adı]
,CASE WHEN CLC.CODE LIKE '120%'THEN '120'WHEN CLC.CODE LIKE '320%' THEN '320'WHEN CLC.CODE LIKE '128%' THEN '128'WHEN CLC.CODE LIKE '329%' THEN '329'ELSE 'DİGER' END 'CARİ GRUP'

,[CH TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0)
,[OCAK TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210101' and '20210131')
,[ŞUBAT TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210201' and '20210228')
,[MART TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210301' and '20210331')
,[NİSAN TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210401' and '20210430')
,[MAYIS TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210501' and '20210531')
,[HAZİRAN TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210601' and '20210630')
,[TEMMUZ TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210701' and '20210731')
,[AĞUSTOS TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210801' and '20210831')
,[EYLÜL TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210901' and '20210930')
,[EKİM TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20211001' and '20211031')
,[KASIM TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20211101' and '20211130')
,[ARALIK TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20211201' and '20211231')
--,[TL SATIS ORT VADE]   = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_004_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (0,160))
--,[TL ALIS ORT VADE]   = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_004_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 1 AND PYT.TRCODE = 1 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (0,160))

,[CH USD BAKIYE] =     (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0)
,[OCAK USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210101' and '20210131')
,[ŞUBAT USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210201' and '20210228')
,[MART USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210301' and '20210331')
,[NİSAN USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210401' and '20210430')
,[MAYIS USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210501' and '20210531')
,[HAZİRAN USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210601' and '20210630')
,[TEMMUZ USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210701' and '20210731')
,[AĞUSTOS USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210801' and '20210831')
,[EYLÜL USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210901' and '20210930')
,[EKİM USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20211001' and '20211031')
,[KASIM USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20211101' and '20211130')
,[ARALIK USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20211201' and '20211231')
--,[CH USD_KUR FARKI]  =(SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.AMOUNT WHEN 1 THEN CLF.AMOUNT * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.TRCODE IN(6)AND CLF.DATE_ BETWEEN '20210101'AND '20211231' )
--,[USD SATIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_004_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (1))
--,[USD ALIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_004_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 1 AND PYT.TRCODE = 1 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (1))

,[CH EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0)
,[OCAK  EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210101' and '20210131')
,[ŞUBAT EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210201' and '20210228')
,[MART EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210301' and '20210331')
,[NİSAN EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210401' and '20210430')
,[MAYIS EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210501' and '20210531')
,[HAZİRAN EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210601' and '20210630')
,[TEMMUZ EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210701' and '20210731')
,[AĞUSTOS EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210801' and '20210831')
,[EYLÜL EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20210901' and '20210930')
,[EKİM EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20211001' and '20211031')
,[KASIM EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20211101' and '20211130')
,[ARALIK EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20211201' and '20211231')
--,[CH EURO_KUR FARKI]  =(SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.AMOUNT WHEN 1 THEN CLF.AMOUNT * -1 END ELSE 0 END),2),0) FROM LG_004_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.TRCODE IN(6)AND CLF.DATE_ BETWEEN '20210101'AND '20211231' ) 
--,[EUR SATIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_004_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (20))
--,[EUR ALIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_004_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 1 AND PYT.TRCODE = 1 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (20))

---,[TOPLAM TL BAKIYE] = (SELECT ISNULL(ROUND(CLC2.DEBIT - CLC2.CREDIT,3),0) FROM LV_004_01_CLCARD CLC2 WHERE CLC2.LOGICALREF = CLC.LOGICALREF)
,[TOPLAM TL YENI] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20210101' and '20211231' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20210101' AND '20211231' AND CLIENTREF=CLC.LOGICALREF),0)
,[OCAK] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20210101' and '20210131' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20210101' AND '20210131' AND CLIENTREF=CLC.LOGICALREF),0)
,[ŞUBAT] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20210201' and '20210228' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20210201' and '20210228' AND CLIENTREF=CLC.LOGICALREF),0)
,[MART] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20210301' and '20210331' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20210301' and '20210331' AND CLIENTREF=CLC.LOGICALREF),0)
,[NİSAN] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20210401' and '20210430' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20210401' and '20210430' AND CLIENTREF=CLC.LOGICALREF),0)
,[MAYIS] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20210501' and '20210531' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20210501' and '20210531' AND CLIENTREF=CLC.LOGICALREF),0)
,[HAZİRAN] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20210601' and '20210630' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20210601' and '20210630' AND CLIENTREF=CLC.LOGICALREF),0)
,[TEMMUZ] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20210701' and '20210731' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20210701' and '20210731' AND CLIENTREF=CLC.LOGICALREF),0)
,[AĞUSTOS] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20210801' and '20210831' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20210801' and '20210831' AND CLIENTREF=CLC.LOGICALREF),0)
,[EYLÜL] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20210901' and '20210930' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20210901' and '20210930' AND CLIENTREF=CLC.LOGICALREF),0)
,[EKİM] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20211001' and '20211031' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20211001' and '20211031' AND CLIENTREF=CLC.LOGICALREF),0)
,[KASIM] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20211101' and '20211130' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20211101' and '20211130'AND CLIENTREF=CLC.LOGICALREF),0)
,[ARALIK] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20211201' and '20211231' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20211201' and '20211231' AND CLIENTREF=CLC.LOGICALREF),0)
--,[TOPLAM TL SATIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_004_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID)
--,[TOPLAM TL ALS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_004_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 1 AND PYT.TRCODE = 1 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID)
,ISNULL(convert(varchar, (SELECT MAX(DATE_)  FROM LG_004_01_CLFLINE WHERE  CLIENTREF=CLC.LOGICALREF), 104),'') AS[SON HAREKET TARIHI]
FROM LG_004_CLCARD CLC
LEFT JOIN LG_004_CLCARD CLC2 WITH(NOLOCK) ON CLC2.LOGICALREF=CLC.PARENTCLREF AND CLC2.CARDTYPE=4
WHERE CLC.ACTIVE = 0 AND CLC.CARDTYPE <> 22 AND
  (SUBSTRING(CLC.CODE, 1, 3) = '120' OR
   SUBSTRING(CLC.CODE, 1, 3) = '320' OR
   SUBSTRING(CLC.CODE, 1, 3) = '128' OR
   SUBSTRING(CLC.CODE, 1, 3) = '329' OR 
   SUBSTRING(CLC.CODE, 1, 3) = '136' OR
   SUBSTRING(CLC.CODE, 1, 3) = '336' OR
   SUBSTRING(CLC.CODE, 1, 3) = '770' OR
   SUBSTRING(CLC.CODE, 1, 3) = '309')


   AND ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20210101' and '20211231' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_004_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20210101' AND '20211231' AND CLIENTREF=CLC.LOGICALREF),0)>0



GO

/****** Object:  View [dbo].[DST_004_01_DETAYLI_SATIS_FATURA_LISTESI]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE VIEW [dbo].[DST_004_01_DETAYLI_SATIS_FATURA_LISTESI] AS

SELECT
      CASE
            WHEN MAX(INV.TRCODE)=1 THEN '(01) Satınalma Faturası'
            WHEN MAX(INV.TRCODE)=2 THEN '(02) Perakende Satış ıade Faturası'
            WHEN MAX(INV.TRCODE)=3 THEN '(03) Toptan Satış ıade Faturası'
            WHEN MAX(INV.TRCODE)=4 THEN '(04) Alınan Hizmet Faturası'
            WHEN MAX(INV.TRCODE)=5 THEN '(05) Alınan Proforma Fatura'
            WHEN MAX(INV.TRCODE)=6 THEN '(06) Satınalma ıade Faturası'
            WHEN MAX(INV.TRCODE)=7 THEN '(07) Perakende Satış Faturası'
            WHEN MAX(INV.TRCODE)=8 THEN '(08) Toptan Satış Faturası'
            WHEN MAX(INV.TRCODE)=9 THEN '(09) Verilen Hizmet Faturası'
            WHEN MAX(INV.TRCODE)=10 THEN '(10) Verilen Proforma Fatura'
            WHEN MAX(INV.TRCODE)=13 THEN '(13) Satınalma Fiyat Farkı Faturası'
            WHEN MAX(INV.TRCODE)=14 THEN '(14) Satış Fiyat Farkı Faturası'
            WHEN MAX(INV.TRCODE)=26 THEN '(26) Müstahsil Makbuzu' END [Fatura Türü],
      MAX(INV.FICHENO) [Fatura No],
      MAX(INV.DATE_) [Fatura Tarihi],
      MAX(INV.DOCODE) [Belge No],
      MAX(CLC.CODE) [Cari Kodu],
      MAX(CLC.DEFINITION_) [Cari Ünvanı],
      MAX(ISNULL(PRJ.CODE,'')) [Proje Kodu],
      MAX(ISNULL(PRJ.NAME,'')) [Proje Açıklaması],
      MAX(ISNULL(SLSM.DEFINITION_,'')) [Müşteri Temsilcisi],
      MAX(ISNULL(TRDGRP.GDEF,'')) [Ticari ışlem Grubu],
      CASE WHEN MAX(PAYLN.GUN) > 0 THEN DATEADD(DAY,MAX(PAYLN.GUN),MAX(INV.DATE_))
            WHEN MAX(PAYLN.AY)     > 0 THEN DATEADD(MONTH,MAX(PAYLN.AY),MAX(INV.DATE_))
            WHEN MAX(PAYLN.YIL) > 0 THEN DATEADD(YEAR,MAX(PAYLN.YIL),MAX(INV.DATE_)) 
            WHEN MAX(PAYLN.GUN) IS NULL OR MAX(PAYLN.AY) IS NULL OR MAX(PAYLN.YIL) IS NULL THEN MAX(INV.DATE_) END [Ödeme Tarihi],
            
      CASE WHEN MAX(STL.LINETYPE) IN(0,6,7,8,9) THEN MAX(ITM.CODE) WHEN MAX(STL.LINETYPE)=4 THEN MAX(SRV.CODE) END [Malzeme Kodu],
      CASE WHEN MAX(STL.LINETYPE) IN(0,6,7,8,9) THEN MAX(ITM.NAME) WHEN MAX(STL.LINETYPE)=4 THEN MAX(SRV.DEFINITION_) END [Malzeme Adı],
      MAX(ITM.STGRPCODE) [Malzeme Grup Kodu],
      MAX(ITM.PRODUCERCODE) [Malzeme Üretici Kodu],
      MAX(ITM.SPECODE) [Mlz Özel Kodu],
      MAX(ITM.SPECODE2) [Mlz Özel Kod 2],
      MAX(ITM.SPECODE3) [Mlz Özel Kod 3],
      MAX(ITM.SPECODE4) [Mlz Özel Kod 4],
      MAX(ITM.SPECODE5) [Mlz Özel Kod 5],
      ISNULL(MAX(SP.DEFINITION_),'') [Mlz ÖK Açıklama],
      ISNULL(MAX(SP2.DEFINITION_),'') [Mlz ÖK2 Açıklama],
      ISNULL(MAX(SP3.DEFINITION_),'') [Mlz ÖK3 Açıklama],
      ISNULL(MAX(SP4.DEFINITION_),'') [Mlz ÖK4 Açıklama],
      ISNULL(MAX(SP5.DEFINITION_),'') [Mlz ÖK5 Açıklama],
      --ISNULL(MAX(DEFN.TEXTFLDS1),'') [Kırılım 1],
      --ISNULL(MAX(DEFN.TEXTFLDS2),'') [Kırılım 2],
      --ISNULL(MAX(DEFN.TEXTFLDS3),'') [Kırılım 3],
      --ISNULL(MAX(DEFN.TEXTFLDS4),'') [Kırılım 4],
      --ISNULL(MAX(DEFN.TEXTFLDS5),'') [Kırılım 5 (Sezon)],
      --ISNULL(MAX(DEFN.NUMFLDS7),0) [Kırılım 7 (Maliyet)],
      MAX(STFICHE.FICHENO) [IRSALıYE NO],
      CASE MAX(ITM.CARDTYPE) WHEN 4 THEN 'SK' WHEN 12 THEN 'MM' WHEN 10 THEN 'HM' WHEN 1 THEN 'TM' WHEN 11 THEN 'YM' ELSE 'TANIMSIZ' END [Malzeme Türü],
      CASE MAX(ITM.ACTIVE) WHEN 0 THEN 'Kullanımda' WHEN 1 THEN 'Kullanım Dışı' ELSE 'Tanımsız' END [Malzeme Durumu],
      MAX(MRK.DESCR) [Marka],
      MAX(USL.NAME) [Birim],
      CASE WHEN MAX(STL.TRCODE) IN(2,3) THEN MAX(STL.AMOUNT)*-1 ELSE MAX(STL.AMOUNT)END [Miktar],
      MAX(PRCL.PRICE) [Tanımlı Satış Fiyatı TL],
      MAX(STL.PRICE) [Brüt Birim Fiyat TL],
      --MAX(STL.LINENET)/MAX(STL.AMOUNT) [Net Birim Fiyat TL],
      MAX(STL.VAT) [Kdv Oranı %],
      MAX(STL.VATMATRAH) [Kdv Tutarı TL],
      MAX(STL.DISTDISC) [Satır ındirim Tutarı TL],
      CASE WHEN MAX(STL.TRCODE) IN(2,3) THEN MAX(STL.TOTAL)*-1 ELSE MAX(STL.TOTAL) END [Brüt Satır Tutarı TL],
      CASE WHEN MAX(STL.TRCODE) IN(2,3) THEN (MAX(STL.TOTAL)-ISNULL(MAX(STL.DISTDISC),0))*-1 ELSE MAX(STL.TOTAL)-ISNULL(MAX(STL.DISTDISC),0) END [Net Satır Tutarı TL],
      --ışlem Dövizi
      CASE MAX(STL.TRCURR) WHEN 0 THEN 'TL' ELSE MAX(CURR.CURCODE) END [ı.D. Türü],
      CASE MAX(STL.TRCURR) WHEN 0 THEN 1 ELSE MAX(STL.TRRATE) END [ı.D. Kuru],
      CASE MAX(STL.TRRATE) WHEN 0 THEN 0 ELSE CONVERT(DECIMAL(28,4),MAX(STL.PRICE)/MAX(STL.TRRATE)) END [Brüt Birim Fiyat ı.D.],
      CASE MAX(STL.TRRATE) WHEN 0 THEN 0 ELSE CONVERT(DECIMAL(28,4),MAX(STL.LINENET)/MAX(STL.AMOUNT)/MAX(STL.TRRATE)) END [Net Birim Fiyat ı.D.],
      CASE MAX(STL.TRRATE) WHEN 0 THEN 0 ELSE CONVERT(DECIMAL(28,4),MAX(STL.TOTAL)/MAX(STL.TRRATE)) END [Brüt Satır Tutarı ı.D.],
      CASE MAX(STL.TRRATE) WHEN 0 THEN 0 ELSE CONVERT(DECIMAL(28,4),MAX(STL.LINENET)/MAX(STL.TRRATE)) END [Net Satır Tutarı ı.D.]
FROM 
      LG_004_01_INVOICE INV INNER JOIN
      LG_004_01_STLINE STL ON STL.INVOICEREF=INV.LOGICALREF LEFT OUTER JOIN
            LG_004_01_STFICHE STFICHE ON STFICHE.LOGICALREF=STL.STFICHEREF LEFT OUTER JOIN 
      LG_004_ITEMS ITM ON STL.STOCKREF=ITM.LOGICALREF LEFT OUTER JOIN
      LG_004_SRVCARD SRV ON STL.STOCKREF=SRV.LOGICALREF INNER JOIN
      LG_004_CLCARD CLC ON INV.CLIENTREF=CLC.LOGICALREF LEFT OUTER JOIN
      LG_SLSMAN SLSM ON INV.SALESMANREF=SLSM.LOGICALREF AND SLSM.FIRMNR=003 LEFT OUTER JOIN
      LG_004_PROJECT PRJ ON INV.PROJECTREF=PRJ.LOGICALREF LEFT OUTER JOIN
      LG_004_DEFNFLDSCARDV DEFN ON ITM.LOGICALREF=DEFN.PARENTREF LEFT OUTER JOIN
      L_TRADGRP TRDGRP ON INV.TRADINGGRP=TRDGRP.GCODE INNER JOIN
      LG_004_UNITSETF USF ON ITM.UNITSETREF=USF.LOGICALREF INNER JOIN
      LG_004_UNITSETL USL ON USF.LOGICALREF=USL.UNITSETREF LEFT OUTER JOIN
      LG_004_PRCLIST PRCL ON ITM.LOGICALREF=PRCL.CARDREF LEFT OUTER JOIN
      L_CURRENCYLIST CURR ON STL.TRCURR=CURR.CURTYPE AND CURR.FIRMNR=003 LEFT OUTER JOIN
      LG_004_SPECODES SP ON SP.SPECODE=ITM.SPECODE AND SP.SPETYP1=1 LEFT OUTER JOIN
      LG_004_SPECODES SP2 ON SP2.SPECODE=ITM.SPECODE2 AND SP2.SPETYP2=1 LEFT OUTER JOIN
      LG_004_SPECODES SP3 ON SP3.SPECODE=ITM.SPECODE3 AND SP3.SPETYP3=1 LEFT OUTER JOIN
      LG_004_SPECODES SP4 ON SP4.SPECODE=ITM.SPECODE4 AND SP4.SPETYP4=1 LEFT OUTER JOIN
      LG_004_SPECODES SP5 ON SP5.SPECODE=ITM.SPECODE5 AND SP5.SPETYP5=1 LEFT OUTER JOIN
      LG_004_MARK MRK ON MRK.LOGICALREF=ITM.MARKREF LEFT OUTER JOIN
      (SELECT PAYLN.PAYPLANREF,
            CASE WHEN ISNULL(PAYLN.DAY_,'')<>'' THEN SUBSTRING(PAYLN.DAY_,2,LEN(PAYLN.DAY_)-1) ELSE 0 END GUN,
            CASE WHEN ISNULL(PAYLN.MOUNTH,'')<>'' THEN SUBSTRING(PAYLN.MOUNTH,2,LEN(PAYLN.MOUNTH)-1) ELSE 0 END AY,
            CASE WHEN ISNULL(PAYLN.YEAR_,'')<>'' THEN SUBSTRING(PAYLN.YEAR_,2,LEN(PAYLN.YEAR_)-1) ELSE 0 END YIL
      FROM LG_004_PAYLINES PAYLN) PAYLN ON INV.PAYDEFREF=PAYLN.PAYPLANREF
WHERE
      INV.CANCELLED = 0
GROUP BY 
      STL.LOGICALREF




















GO

/****** Object:  View [dbo].[DST_004_01_MIZAN]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE VIEW [dbo].[DST_004_01_MIZAN] AS 

SELECT
EMF.FICHENO [Fiş No],
EML.DATE_ [Fiş Tarihi],
month(EML.DATE_) [AY],
YEAR(EML.DATE_) [YIL],
EML.KEBIRCODE [Kebir Hesap],
--LEFT(EMU.CODE,1) [Grup],
EMU.CODE [Hesap Kodu],
EMU.DEFINITION_ [Hesap Adı],
--CASE WHEN EML.TRCURR=0 THEN 'TL'
--           WHEN EML.TRCURR=1 THEN 'USD'
--           WHEN EML.TRCURR=20 THEN 'EUR'
--           WHEN EML.TRCURR=17 THEN 'GBP'
--           ELSE 'Tanımsız' END [Döviz],
CASE   WHEN EML.SIGN=0 THEN 'Borç' ELSE 'Alacak' END [Hareket],
EML.DEBIT [Borç],
EML.CREDIT [Alacak],

EML.DEBIT-EML.CREDIT [Bakiye],
EML.LINEEXP [Satır Açıklaması],
--CASE WHEN EML.SIGN=0 AND EML.TRNET<>0 THEN EML.TRNET 
--           WHEN EML.SIGN=1 AND EML.TRNET<>0 THEN EML.TRNET*-1
--           WHEN EML.SIGN=0 AND EML.TRNET=0 THEN EML.DEBIT+EML.CREDIT 
--           WHEN EML.SIGN=1 AND EML.TRNET=0 THEN (EML.DEBIT+EML.CREDIT)*-1
--           END [İD Bakiye],
EMF.GENEXP1 [Genel Açıklama],
EMU.SPECODE [Hesap Özel Kod],
EMU.SPECODE2 [Hesap Özel Kod2],

CASE EMF.MODULENR WHEN 0 THEN 'Kaynak Fiş Türü Olmayanlar' WHEN 1 THEN 'Malzeme Fişleri' WHEN 2 THEN 'Satınalma Faturası' WHEN 3 THEN 'Satış Faturası' WHEN 4 THEN 'Cari Hesap Fişleri' WHEN 5 THEN 'Çek/Senet Bordroları' WHEN 6 THEN 'Banka Fişleri' WHEN 7 THEN 'Kasa İşlemleri' WHEN 20 THEN 'Dağıtım Fişleri' WHEN 25 THEN 'Sabit Kıymet' WHEN 160 THEN 'Teminat Bordroları' WHEN 170 THEN 'Kiralama İşlemleri' ELSE 'Diğer Fişler' END [Kaynak Fiş Türü]
FROM LG_004_01_EMFLINE EML 
             LEFT JOIN LG_004_EMUHACC EMU ON EML.ACCOUNTREF=EMU.LOGICALREF
             LEFT JOIN LG_004_01_EMFICHE EMF ON EMF.LOGICALREF=EML.ACCFICHEREF

WHERE EML.CANCELLED=0





GO

/****** Object:  View [dbo].[DST_004_01_SATISFATURALARI]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

--USE [TIGERDB]
--GO

--/****** Object:  View [dbo].[DST_004_01_SATISLAR]    Script Date: 14.12.2021 15:51:55 ******/
--SET ANSI_NULLS ON
--GO

--SET QUOTED_IDENTIFIER ON
--GO





----USE [TIGERDB]
----GO

----/****** Object:  View [dbo].[DST_004_01_SATISLAR]    Script Date: 23.06.2020 22:58:17 ******/
----SET ANSI_NULLS ON
----GO

----SET QUOTED_IDENTIFIER ON
------GO

CREATE VIEW [dbo].[DST_004_01_SATISFATURALARI] AS 

SELECT
	--[GRUP KODU] =(SELECT CODE FROM LG_004_CLCARD CLC2 WHERE CLC.PARENTCLREF=CLC2.LOGICALREF and CARDTYPE=4) ,
	CLC2.CODE [Grup Kodu],
	CLC2.DEFINITION_ [Grup Firma Adı],
	--CLC.PARENTCLREF,
	CLC.SPECODE2[Satış Elemanı],
	LEFT(CLC.CODE,6) [Plaka],
	CASE 
	WHEN INV.TRCODE IN (1) THEN 'Satınalma'
	WHEN INV.TRCODE IN (3) THEN 'Toptan Satış İade'
	WHEN INV.TRCODE IN (8) THEN 'Toptan Satış'
	
	
	ELSE 'Diğer' END [Fatura Türü],
	MONTH(INV.DATE_) [Ay],
	DAY(INV.DATE_) [Gün],
	year(ınv.date_) [Yıl],
	INV.DATE_ [Fatura Tarihi],
	INV.FICHENO [Fatura No],
	INV.DOCODE [Fatura Belge No],
	STF.DATE_ [İrsaliye Tarihi],
	STF.FICHENO [İrsaliye No],
	STF.DOCODE [İrsaliye Belge No],
	CLC.CODE [Cari Kodu],
	CLC.DEFINITION_ [Cari Adı],
	CLC.CITY [Cari Şehir],
	CLC.COUNTRY [Cari Ülke],
	CASE WHEN STL.LINETYPE=0 THEN 'Malzeme' WHEN STL.LINETYPE=1 THEN 'Promosyon' WHEN STL.LINETYPE=4 THEN 'Hizmet' ELSE 'Diğer' END [Satır], 
	--STL.TRCODE,
	ISNULL(ITM.CODE,'')+ISNULL(SRV.CODE,'') [Stok/Hizmet Kodu],
	ISNULL(ITM.NAME,'')+ISNULL(SRV.DEFINITION_,'') [Stok/Hizmet Adı],
	--ITM.PRODUCERCODE [Stok Üretici kodu],
	--SPE.DEFINITION_ [Stok Grup Adı],
	STL.AMOUNT  [İadesiz Miktar],
	CASE WHEN STL.TRCODE IN (3,8) THEN STL.AMOUNT*-1 ELSE STL.AMOUNT END [İadeli Miktar],
	UNT.CODE [Satır Birim],	
	CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.PRICE END [Birim Fiyat],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.VATMATRAH END [KDV Matrah],
	CASE WHEN INV.TRCODE IN (8) THEN  STL.VATMATRAH WHEN INV.TRCODE IN (1,3) THEN  STL.VATMATRAH*-1 ELSE 0 END [KDV Matrah],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.VATAMNT END [KDV],
	CASE WHEN INV.TRCODE IN (8) THEN STL.VATAMNT WHEN INV.TRCODE IN (1,3) THEN  STL.VATAMNT*-1 ELSE 0 END [KDV],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.DISTDISC END [İndirim],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.DISTEXP END [Masraf],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.VATMATRAH+STL.VATAMNT END [KDV'li Tutar],
	CASE WHEN INV.TRCODE IN (8) THEN STL.VATMATRAH+STL.VATAMNT WHEN INV.TRCODE IN (1,3) THEN (STL.VATMATRAH+STL.VATAMNT)*-1 ELSE 0 END [KDV'li Tutar],
	INV.GENEXP1 + INV.GENEXP2 [Fatura Açıklama],
	STL.LINEEXP [Satır Açıklama]
	--PAY.CODE [Ödeme Planı]
	
	
FROM LG_004_01_STLINE STL WITH(NOLOCK)
		LEFT JOIN LG_004_ITEMS ITM WITH(NOLOCK) ON STL.STOCKREF=ITM.LOGICALREF AND STL.LINETYPE IN (0,1)
		LEFT JOIN LG_004_SRVCARD SRV WITH(NOLOCK) ON STL.STOCKREF=SRV.LOGICALREF AND STL.LINETYPE=4
		LEFT JOIN LG_004_CLCARD CLC WITH(NOLOCK) ON CLC.LOGICALREF=STL.CLIENTREF --AND CLC.CODE LIKE '120%'
		LEFT JOIN LG_004_CLCARD CLC2 WITH(NOLOCK) ON CLC2.LOGICALREF=CLC.PARENTCLREF AND CLC2.CARDTYPE=4
	    LEFT JOIN LG_004_01_INVOICE INV WITH(NOLOCK) ON INV.LOGICALREF=STL.INVOICEREF
		LEFT JOIN LG_004_01_STFICHE STF WITH(NOLOCK) ON STF.LOGICALREF=STL.STFICHEREF
		LEFT JOIN LG_004_UNITSETL UNT WITH(NOLOCK) ON STL.UOMREF=UNT.LOGICALREF
		LEFT JOIN LG_004_SPECODES SPE WITH(NOLOCK) ON SPE.SPECODE=ITM.STGRPCODE AND SPE.CODETYPE=4 AND SPE.SPECODETYPE=0
		LEFT JOIN LG_004_PAYPLANS PAY WITH(NOLOCK) ON INV.PAYDEFREF=PAY.LOGICALREF
		LEFT JOIN LG_004_ITMUNITA ITU2  WITH(NOLOCK) ON ITU2.ITEMREF=ITM.LOGICALREF AND ITU2.LINENR=2
		LEFT JOIN LG_004_ITMUNITA ITU3  WITH(NOLOCK) ON ITU3.ITEMREF=ITM.LOGICALREF AND ITU3.LINENR=3
		LEFT JOIN L_CAPIWHOUSE AMB ON AMB.NR=STL.SOURCEINDEX AND AMB.FIRMNR=003
		LEFT JOIN L_CAPIUSER USR ON USR.NR=STF.CAPIBLOCK_CREATEDBY
		LEFT JOIN LG_SLSMAN SLS ON SLS.LOGICALREF=STF.SALESMANREF
		

WHERE INV.TRCODE IN (3,8,9) AND INV.CANCELLED=0 AND STL.LINETYPE IN (0,1,4) AND STL.BILLED=1 --and (ITM.CODE LIKE '150%' OR ITM.CODE LIKE '151%' OR ITM.CODE LIKE '152%' OR ITM.CODE LIKE '153%') AND (CLC.CODE BETWEEN '120.01.001.01' AND '120.89.001.01')



GO

/****** Object:  View [dbo].[DST_004_01_SATISLAR]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





--USE [TIGERDB]
--GO

--/****** Object:  View [dbo].[DST_004_01_SATISLAR]    Script Date: 23.06.2020 22:58:17 ******/
--SET ANSI_NULLS ON
--GO

--SET QUOTED_IDENTIFIER ON
----GO

CREATE VIEW [dbo].[DST_004_01_SATISLAR] AS 

SELECT
	--[GRUP KODU] =(SELECT CODE FROM LG_004_CLCARD CLC2 WHERE CLC.PARENTCLREF=CLC2.LOGICALREF and CARDTYPE=4) ,
	CLC2.CODE [Grup Kodu],
	CLC2.DEFINITION_ [Grup Firma Adı],
	CLC.PARENTCLREF,
	CLC.SPECODE2[Satış Elemanı],
	LEFT(CLC.CODE,6) [Plaka],
	CASE 
	WHEN INV.TRCODE IN (1) THEN 'Satınalma'
	WHEN INV.TRCODE IN (3) THEN 'Toptan Satış İade'
	WHEN INV.TRCODE IN (8) THEN 'Toptan Satış'
	
	
	ELSE 'Diğer' END [Fatura Türü],
	MONTH(INV.DATE_) [Ay],
	DAY(INV.DATE_) [Gün],
	year(ınv.date_) [Yıl],
	INV.DATE_ [Fatura Tarihi],
	INV.FICHENO [Fatura No],
	INV.DOCODE [Fatura Belge No],
	STF.DATE_ [İrsaliye Tarihi],
	STF.FICHENO [İrsaliye No],
	STF.DOCODE [İrsaliye Belge No],
	CLC.CODE [Cari Kodu],
	CLC.DEFINITION_ [Cari Adı],
	CLC.CITY [Cari Şehir],
	CLC.COUNTRY [Cari Ülke],
	CASE WHEN STL.LINETYPE=0 THEN 'Malzeme' WHEN STL.LINETYPE=1 THEN 'Promosyon' WHEN STL.LINETYPE=4 THEN 'Hizmet' ELSE 'Diğer' END [Satır], 
	STL.TRCODE,
	ISNULL(ITM.CODE,'')+ISNULL(SRV.CODE,'') [Stok/Hizmet Kodu],
	ISNULL(ITM.NAME,'')+ISNULL(SRV.DEFINITION_,'') [Stok/Hizmet Adı],
	ITM.PRODUCERCODE [Stok Üretici kodu],
	SPE.DEFINITION_ [Stok Grup Adı],
	STL.AMOUNT  [İadesiz Miktar],
	CASE WHEN STL.TRCODE IN (3,8) THEN STL.AMOUNT*-1 ELSE STL.AMOUNT END [İadeli Miktar],
	UNT.CODE [Satır Birim],	
	CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.PRICE END [Birim Fiyat],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.VATMATRAH END [KDV Matrah],
	CASE WHEN INV.TRCODE IN (8) THEN  STL.VATMATRAH WHEN INV.TRCODE IN (1,3) THEN  STL.VATMATRAH*-1 ELSE 0 END [KDV Matrah],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.VATAMNT END [KDV],
	CASE WHEN INV.TRCODE IN (8) THEN STL.VATAMNT WHEN INV.TRCODE IN (1,3) THEN  STL.VATAMNT*-1 ELSE 0 END [KDV],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.DISTDISC END [İndirim],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.DISTEXP END [Masraf],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.VATMATRAH+STL.VATAMNT END [KDV'li Tutar],
	CASE WHEN INV.TRCODE IN (8) THEN STL.VATMATRAH+STL.VATAMNT WHEN INV.TRCODE IN (1,3) THEN (STL.VATMATRAH+STL.VATAMNT)*-1 ELSE 0 END [KDV'li Tutar],
	INV.GENEXP1 + INV.GENEXP2 [Fatura Açıklama],
	STL.LINEEXP [Satır Açıklama],
	PAY.CODE [Ödeme Planı]
	
	
FROM LG_004_01_STLINE STL WITH(NOLOCK)
		LEFT JOIN LG_004_ITEMS ITM WITH(NOLOCK) ON STL.STOCKREF=ITM.LOGICALREF AND STL.LINETYPE IN (0,1)
		LEFT JOIN LG_004_SRVCARD SRV WITH(NOLOCK) ON STL.STOCKREF=SRV.LOGICALREF AND STL.LINETYPE=4
		LEFT JOIN LG_004_CLCARD CLC WITH(NOLOCK) ON CLC.LOGICALREF=STL.CLIENTREF --AND CLC.CODE LIKE '120%'
		LEFT JOIN LG_004_CLCARD CLC2 WITH(NOLOCK) ON CLC2.LOGICALREF=CLC.PARENTCLREF AND CLC2.CARDTYPE=4
	    LEFT JOIN LG_004_01_INVOICE INV WITH(NOLOCK) ON INV.LOGICALREF=STL.INVOICEREF
		LEFT JOIN LG_004_01_STFICHE STF WITH(NOLOCK) ON STF.LOGICALREF=STL.STFICHEREF
		LEFT JOIN LG_004_UNITSETL UNT WITH(NOLOCK) ON STL.UOMREF=UNT.LOGICALREF
		LEFT JOIN LG_004_SPECODES SPE WITH(NOLOCK) ON SPE.SPECODE=ITM.STGRPCODE AND SPE.CODETYPE=4 AND SPE.SPECODETYPE=0
		LEFT JOIN LG_004_PAYPLANS PAY WITH(NOLOCK) ON INV.PAYDEFREF=PAY.LOGICALREF
		LEFT JOIN LG_004_ITMUNITA ITU2  WITH(NOLOCK) ON ITU2.ITEMREF=ITM.LOGICALREF AND ITU2.LINENR=2
		LEFT JOIN LG_004_ITMUNITA ITU3  WITH(NOLOCK) ON ITU3.ITEMREF=ITM.LOGICALREF AND ITU3.LINENR=3
		LEFT JOIN L_CAPIWHOUSE AMB ON AMB.NR=STL.SOURCEINDEX AND AMB.FIRMNR=003
		LEFT JOIN L_CAPIUSER USR ON USR.NR=STF.CAPIBLOCK_CREATEDBY
		LEFT JOIN LG_SLSMAN SLS ON SLS.LOGICALREF=STF.SALESMANREF
		

WHERE INV.TRCODE IN (1,3,8) AND INV.CANCELLED=0 AND STL.LINETYPE IN (0,1,4) AND STL.BILLED=1 and (ITM.CODE LIKE '150%' OR ITM.CODE LIKE '151%' OR ITM.CODE LIKE '152%' OR ITM.CODE LIKE '153%') AND (CLC.CODE BETWEEN '120.01.001.01' AND '120.89.001.01')



GO

/****** Object:  View [dbo].[DST_004_FISTAKIP]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE VIEW [dbo].[DST_004_FISTAKIP] AS

SELECT FT.ZYT FROM FISNOTAKIP FT 

 EXCEPT 
 
 SELECT INV.FICHENO FROM LG_005_01_INVOICE INV  WHERE INV.FICHENO LIKE 'ZYT2022%'	
GO

/****** Object:  View [dbo].[DST_004_FISTAKIP2]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE VIEW [dbo].[DST_004_FISTAKIP2] AS

SELECT FT.ZYA FROM FISNOTAKIP FT 

 EXCEPT 
 
 SELECT INV.FICHENO FROM LG_005_01_INVOICE INV  WHERE INV.FICHENO LIKE 'ZYA2022%'	
GO

/****** Object:  View [dbo].[DST_004_FISTAKIP3]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE VIEW [dbo].[DST_004_FISTAKIP3] AS

SELECT FT.ZYI FROM FISNOTAKIP FT 

 EXCEPT 
 
 SELECT STF.FICHENO FROM LG_005_01_STFICHE STF  WHERE STF.FICHENO LIKE 'ZYI2022%'	

GO

/****** Object:  View [dbo].[DST_004_HESAPPLANI]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[DST_004_HESAPPLANI] AS 
SELECT EMU.CODE,
EMU.DEFINITION_,
EMU.SPECODE ,
EMU.SPECODE2 
FROM LG_004_EMUHACC EMU 
WHERE ACTIVE=0
GO

/****** Object:  View [dbo].[DST_005_01_KDVRAPORU_MUHASEBEFISNOLU]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO








CREATE VIEW [dbo].[DST_005_01_KDVRAPORU_MUHASEBEFISNOLU] AS
SELECT               'Tevkıfatsız' [Türü], INV.FICHENO[Fatura No], INV.DOCODE[Belge No], INV.DATE_[Fatura Tarihi], INV.DOCDATE [Düzenleme Tarihi],MONTH(INV.DOCDATE) [Düzenleme Ayı],CAST(YEAR(INV.DATE_) AS VARCHAR) + ' - ' + RIGHT('0' + RTRIM(MONTH(INV.DATE_)), 2)  [YYYY-MM],MONTH(INV.DATE_) [Fatura Ayı], CLC.CODE[Firma Kodu],
                         CLC.DEFINITION_ [Firma Adı], 
                         CLC.TAXOFFICE[Vergi Dairesi], CLC.TAXNR[Vergi No],CLC.TCKNO [TC Kimlik No], CASE WHEN STL.TRCODE IN (1, 2, 3, 4) THEN 'Alış' WHEN STL.TRCODE IN (6, 7, 8, 9) THEN 'Satış' ELSE '' END [Hareket], 
                         CASE STL.TRCODE WHEN 1 THEN 'Mal Alım' WHEN 2 THEN 'Per satış İade' WHEN 3 THEN 'Satış İade' WHEN 4 THEN 'Alınan Hizmet' WHEN 6 THEN 'Alım İade' WHEN 7 THEN 'Perakende Satış' WHEN 8 THEN 'Toptan Satış'
                          WHEN 9 THEN 'Verilen Hizmet' ELSE '' END [Fatura Türü],
                          ----CASE INV.FROMKASA WHEN 1 THEN 'Kasa' ELSE 'Diğer' END 'Fatura Yeri',  
                         CASE WHEN STL.LINETYPE = 0 THEN 'Stok' WHEN STL.LINETYPE = 4 THEN 'Hizmet' WHEN STL.LINETYPE = 8 THEN 'Sabit Kıymet' WHEN STL.LINETYPE = 11 THEN 'Tevkıfat' ELSE '' END [Satır], 
                         CASE WHEN STL.LINETYPE IN (0, 8) THEN ITM.CODE WHEN STL.LINETYPE IN (4, 11) THEN SRV.CODE ELSE '' END [Stok/Hizmet Kodu], CASE WHEN STL.LINETYPE IN (0, 8) 
                         THEN ITM.NAME WHEN STL.LINETYPE IN (4, 11) THEN SRV.DEFINITION_ ELSE '' END [Stok/Hizmet Adı], STL.TOTAL * (CASE WHEN STL.TRCODE IN (1,4,3, 2) THEN - 1 ELSE 1 END) 
                         + STL.VATAMNT * (CASE WHEN STL.TRCODE IN (1,4,3, 2) THEN - 1 ELSE 1 END) [KDVLİ Tutar], STL.DISTDISC * (CASE WHEN STL.TRCODE IN ( 1,4,3, 2) THEN - 1 ELSE 1 END) [İndirim], 
                         STL.DISTEXP * (CASE WHEN STL.TRCODE IN ( 1,4,3, 2) THEN - 1 ELSE 1 END) [Masraf], STL.VATMATRAH * (CASE WHEN STL.TRCODE IN ( 1,4,3, 2) THEN - 1 ELSE 1 END) 
                         + STL.DISTEXP * (CASE WHEN STL.TRCODE IN (1,4,3, 2) THEN - 1 ELSE 1 END) [Matrah], STL.VAT[%KDV],'0' [TEV KDV], 
                         STL.VATAMNT * (CASE WHEN STL.TRCODE IN ( 1,4,3, 2) THEN - 1 ELSE 1 END) [KDV], ISNULL(ITM.STGRPCODE, '') [Grup Kodu], EMC.CODE[Masraf Merkezi Kodu],EMC.DEFINITION_[Masraf Merkezi], 
						 PRJ.CODE [Proje Kodu], PRJ.NAME [Proje Adı], SUBSTRING(EMU.CODE, 1, 15) [Hesap Kodu], SUBSTRING(EMU1.CODE, 1, 15) [KDV_Hesap_Kodu],
						 
						 --------------------------------------------------------YENI EKLENEN
						 
						 			CASE   CASE INV.TRCODE WHEN 6 THEN 'İADE'WHEN 8 THEN 'SATIŞ'WHEN 9 THEN 'SATIŞ'ELSE 'ALIŞ'END
					
					
					 WHEN 'SATIŞ'
					 THEN
					   (SELECT       TOP 1 ACCOUNTCODE
                               FROM            LG_005_01_EMFLINE
                               WHERE        ACCFICHEREF IN
                                                             (SELECT        ACCFICHEREF
                                                               FROM            LG_005_01_INVOICE
                                                               WHERE        LOGICALREF = INV.LOGICALREF)AND ACCOUNTCODE LIKE '6%') 
															   
															 WHEN 'ALIŞ' 
															 
															 THEN
															  (SELECT       TOP 1 ACCOUNTCODE
                               FROM            LG_005_01_EMFLINE
                               WHERE        ACCFICHEREF IN
                                                             (SELECT        ACCFICHEREF
                                                               FROM            LG_005_01_INVOICE
                                                               WHERE        LOGICALREF = INV.LOGICALREF)AND ACCOUNTCODE !='19%')
															 
															   ELSE
															   
															(SELECT       TOP 1 ACCOUNTCODE
                               FROM            LG_005_01_EMFLINE
                               WHERE        ACCFICHEREF IN
                                                             (SELECT        ACCFICHEREF
                                                               FROM            LG_005_01_INVOICE
                                                               WHERE        LOGICALREF = INV.LOGICALREF)AND ACCOUNTCODE LIKE '7%')   
															   
															   END			  
															   [HESAP KODU YENI],


	----------------------------------------------- -----------------------

CASE   CASE INV.TRCODE WHEN 6 THEN 'İADE'WHEN 8 THEN 'SATIŞ'WHEN 9 THEN 'SATIŞ'ELSE 'ALIŞ'END WHEN 'SATIŞ'THEN
					   (SELECT       TOP 1 ACCOUNTCODE
                               FROM            LG_005_01_EMFLINE
                               WHERE        ACCFICHEREF IN
                                                             (SELECT        ACCFICHEREF
                                                               FROM            LG_005_01_INVOICE
                                                               WHERE        LOGICALREF = INV.LOGICALREF)AND ACCOUNTCODE LIKE '391%') 
															   
															 ELSE 
															  (SELECT       TOP 1 ACCOUNTCODE
                               FROM            LG_005_01_EMFLINE
                               WHERE        ACCFICHEREF IN
                                                             (SELECT        ACCFICHEREF
                                                               FROM            LG_005_01_INVOICE
                                                               WHERE        LOGICALREF = INV.LOGICALREF)AND ACCOUNTCODE LIKE '191%')END							  
															   [KDV KODU YENI ],

						 
						 
						 
						 
						 
						 
						 
						 
						 
						 
						 -------------------------------------------------------------------------------------------------
						 
						 STL.VAT [KDV ORANI],
						 EMU.DEFINITION_[Hesap Açıklaması], STL.AMOUNT[Miktar], UNT.CODE[Birim],
                             (SELECT        FICHENO
                               FROM            LG_005_01_EMFICHE
                               WHERE        LOGICALREF IN
                                                             (SELECT        ACCFICHEREF
                                                               FROM            LG_005_01_INVOICE
                                                               WHERE        LOGICALREF = INV.LOGICALREF)) [MUH FİŞ NO],INV.BRANCH [İşyeri No],
															   CASE  CLC.ACCEPTEINV WHEN 0 THEN 'E-ARŞİV'WHEN 1 THEN 'E-FATURA'ELSE 'DİĞER' END [CARİ E-FATURA TİPİ],
															               CASE  INV.EINVOICE WHEN 0 THEN 'KAĞIT'WHEN 1 THEN 'E-FATURA'WHEN 2 THEN 'E-ARŞİV'ELSE 'DİĞER' END [E-FATURA TİPİ],
						 CASE INV.CANCELLED WHEN 1 THEN 'EVET'ELSE 'HAYIR'END [İPTAL Mİ],
						 CASE INV.TRCURR WHEN 0 THEN 'TL' WHEN 1 THEN 'USD'WHEN 20 THEN 'EURO' ELSE 'DİĞER' END [DÖVİZ TÜRÜ],
				        CASE INV.EINVOICE WHEN 1 THEN CASE INV.ESTATUS WHEN 10 THEN 'Alıcıda İşlendi-Başarıyla Tamamlandı' WHEN 12 THEN 'Kabul edildi'when 22 THEN 'Sunucuya Gönderildi'
						 WHEN 0 THEN 'GIBe Gönderilecek' WHEN 2 THEN 'Rapor Dosyasına Yazıldı' WHEN 13 THEN 'Reddedildi' ELSE 'DİĞER' END

                      WHEN 2 THEN CASE INV.ESTATUS  WHEN 2 THEN 'Sunucuda İmzalandı'ELSE 'DİĞER'END
					  WHEN 0 THEN 'BOŞ'
					  
					  
					  ELSE 'DİĞER' END'GİB DURUMU',
					  STL.DEDUCTIONPART1 [TEVK.ORANI PAY],
					  STL.DEDUCTIONPART2 [TEVK.ORANI PAYDA],
					  EMF.FICHENO [MUHASEBE FISNO],
					     (SELECT       TOP 1 ACCOUNTCODE
                               FROM            LG_005_01_EMFLINE
                               WHERE        ACCFICHEREF IN
                                                             (SELECT        ACCFICHEREF
                                                               FROM            LG_005_01_INVOICE
                                                               WHERE        LOGICALREF = INV.LOGICALREF)AND ACCOUNTCODE LIKE '360%') [MUHASEBE KODU],
															   ---





															   ---
															   CASE INV.TRCODE WHEN 6 THEN 'İADE'WHEN 8 THEN 'SATIŞ'WHEN 9 THEN 'SATIŞ'ELSE 'ALIŞ'END AS 'FATURA TİPİ',
															   (CASE INV.CAPIBLOCK_CREATEDBY WHEN 1 THEN 'LOGO' WHEN 2 THEN 'ZEYNEP OZKAN' WHEN 3 THEN 'NESRİN ÖZDEMİR' WHEN 4 THEN 
'GAMZE.ŞAHİN' WHEN 5 THEN 'CANSU.MOLLA' WHEN 6 THEN 'BÜŞRA.ERBEN' WHEN 7 THEN 'ZELİHA.GAYRET' WHEN 8 THEN 'DİLARA.KORKAK' WHEN 9 THEN 'ELİF.ŞAHİNHAN' WHEN 10 THEN 'ONUR.ÖZDİN' 
WHEN 11 THEN 'FİLİZ.KÜÇÜKLER' WHEN 12 THEN 'ÜMMÜHAN.YILDIRIM' WHEN 13 THEN 'SÜNDÜZ.MIZRAK' WHEN 14 THEN 'AYŞEGÜL.SABANCI' WHEN 15 THEN 'BÜŞRA.AKSU'
 WHEN 16 THEN 'GONCA.KURT' WHEN 17 THEN 'ONUR.GÜMÜŞ' WHEN 18 THEN 'REMZİYE.DEMİREL' WHEN 19 THEN 'İLKAY.ŞAHAN' 
WHEN 20 THEN 'AYTAÇ.UNUT' WHEN 21 THEN 'EMRE.METİN' WHEN 22 THEN 'ERSOY.GÖK' WHEN 23 THEN 'ŞENOL.YAMAN' WHEN 24 THEN 'SUNA.YILDIRIM'
 WHEN 25 THEN 'ALİ.PINAR' WHEN 26 THEN 'BUKET.GÜLERYÜZ' WHEN 27 THEN 'NİLGÜN.DERİNOĞLU' WHEN 28 THEN 'MÜGE.ÖZGENÇİL' WHEN 29 THEN 'TUĞÇE.ŞEN' WHEN 30 THEN 'BETÜL.KARATAŞ' WHEN 31 THEN 
'YELİZ.ÇINAR' WHEN 32 THEN 'ESMA.PALA' WHEN 33 THEN 'HASAN.LEKESİZEL' WHEN 34 THEN 'GİZEM.GÜL' WHEN 35 THEN 'ÜMMÜHAN.ÖZDEMİR' WHEN 36 THEN 'ELİF.OSMANÇELEBİOĞLU' WHEN 37 THEN 'ŞEYDA.AKFIRAT' 
WHEN 38 THEN 'MERVE.ÖNÜR' WHEN 39 THEN 'DİDEM.OCAKLI' WHEN 40 THEN 'NİLGÜN.AYTAÇ' WHEN 41 THEN 'RAMAZAN.ARSLAN' WHEN 42 THEN 'HAYRETTİN.BEKTAŞ'
 WHEN 43 THEN 'ERKAN.KABAKÇI' WHEN 44 THEN 'VOLKAN.TOPÇU' WHEN 45 THEN 'VOLKAN.DEMİR' WHEN 46 THEN 'MUSTAFA.AKSU' 
WHEN 47 THEN 'RECEP.PEKER' WHEN 48 THEN 'IGAKAMEDE' WHEN 49 THEN 'ORHANLIKADEME' WHEN 50 THEN 'RAİF.İLLEEZ' WHEN 51 THEN 'SEZGIN' WHEN 52 THEN 'UMMUHAN.YILDIRIM' 
WHEN 53 THEN 'AYŞEGÜL.SABANCIA' WHEN 54 THEN 'AYTAÇ.UNUTA' WHEN 58 THEN 'ELİF.ÖKSÜZ' WHEN 63 THEN 'BETUL' WHEN 66 THEN 'DUYGU.KOREKE' WHEN 67 THEN 'GAMZE' WHEN 70 THEN 'ZEKİ' 
 WHEN 71 THEN 'ELİF' WHEN 76 THEN 'EMRE' WHEN 79 THEN 'KAYHAN.ATICI' WHEN 82 THEN 'FİRDEVS.KARAMAN'WHEN 83 THEN 'SİNEM.MADANACI' ELSE 'DIGER' END) AS [EKLEYEN],STL.DEDUCTCODE AS [Tevkifat Kodu],
 CASE WHEN STL.DEDUCTCODE=606 AND STL.VAT=8 THEN '606 TEVKİFAT 9/10 %8' 
					  WHEN STL.DEDUCTCODE=606 AND STL.VAT=18 THEN '606 TEVKİFAT 9/10 %18'

					  WHEN STL.DEDUCTCODE=614 AND STL.VAT=18 THEN '614 TEVKİFAT 5/10 %18' 

					  WHEN STL.DEDUCTCODE=616 AND STL.VAT=8 THEN '616 TEVKİFAT 5/10 %8' 
					  WHEN STL.DEDUCTCODE=616 AND STL.VAT=18 THEN '616 TEVKİFAT 5/10 %18' 
					  
					  WHEN STL.DEDUCTCODE=624 AND STL.VAT=18 THEN '624 TEVKİFAT 2/10 %18' 

					   WHEN STL.DEDUCTCODE=650 AND STL.VAT=8  THEN '650 TEVKİFAT 5/10 %8'
					   WHEN STL.DEDUCTCODE=650 AND STL.VAT=18 THEN '650 TEVKİFAT 2/10 %18'
					   WHEN STL.DEDUCTCODE=603 AND STL.VAT=18 THEN '603 TEVKİFAT 7/10 %18'

					   -----ALIŞ
					   WHEN STL.DEDUCTCODE=206 AND STL.VAT=18 THEN '206 TEVKİFAT 9/10 %18'
					   WHEN STL.DEDUCTCODE=207 AND STL.VAT=18 THEN '207 TEVKİFAT 9/10 %18'
					   WHEN STL.DEDUCTCODE=214 AND STL.VAT=8 THEN '214 TEVKİFAT 5/10 %8'
					   WHEN STL.DEDUCTCODE=224 AND STL.VAT=18 THEN '224 TEVKİFAT 2/10 %18'
					    WHEN STL.DEDUCTCODE=225 AND STL.VAT=18 THEN '225 TEVKİFAT 3/10 %18'
						WHEN STL.DEDUCTCODE=612 AND STL.VAT=18 THEN '612 TEVKİFAT 9/10 %18'
					   ------

					  
					  ELSE 'YOK'END [TEV ADI]

					  ------------------------------------------------------
		








FROM            LG_005_01_STLINE STL LEFT JOIN
                         LG_005_ITEMS ITM ON STL.STOCKREF = ITM.LOGICALREF AND STL.LINETYPE IN (0, 8) LEFT JOIN
                         LG_005_SRVCARD SRV ON STL.STOCKREF = SRV.LOGICALREF AND STL.LINETYPE = 4 LEFT JOIN
                         LG_005_01_INVOICE INV ON STL.INVOICEREF = INV.LOGICALREF LEFT JOIN
                         LG_005_CLCARD CLC ON CLC.LOGICALREF = STL.CLIENTREF LEFT JOIN
                         LG_005_EMUHACC EMU ON EMU.LOGICALREF = STL.ACCOUNTREF LEFT JOIN
						 LG_005_EMUHACC EMU1 ON EMU1.LOGICALREF = STL.VATACCREF LEFT JOIN
						 LG_005_01_EMFICHE EMF ON EMF.LOGICALREF = INV.ACCFICHEREF LEFT JOIN
                         LG_005_UNITSETL UNT ON UNT.LOGICALREF = STL.UOMREF LEFT JOIN
                         LG_005_EMCENTER EMC ON EMC.LOGICALREF = STL.CENTERREF LEFT JOIN
						 LG_005_PROJECT PRJ ON PRJ.LOGICALREF=STL.PROJECTREF
WHERE        STL.TRCODE IN ( 2, 3, 7, 8) AND STL.LINETYPE IN (0, 4, 8, 11)  AND STL.BILLED = 1 AND STL.DEDUCTIONPART1 = 0 and INV.FICHENO NOT LIKE 'IHR2022%'---AND INV.FICHENO='ZYT2022000004109'


GO

/****** Object:  View [dbo].[DST_005_01_MIZAN]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE VIEW [dbo].[DST_005_01_MIZAN] AS 

SELECT
EMF.FICHENO [Fiş No],
EML.DATE_ [Fiş Tarihi],
month(EML.DATE_) [AY],
YEAR(EML.DATE_) [YIL],
EML.KEBIRCODE [Kebir Hesap],
--LEFT(EMU.CODE,1) [Grup],
EMU.CODE [Hesap Kodu],
EMU.DEFINITION_ [Hesap Adı],
CASE WHEN EML.TRCURR=0 THEN 'TL'
WHEN EML.TRCURR=1 THEN 'USD'
WHEN EML.TRCURR=20 THEN 'EUR'
WHEN EML.TRCURR=17 THEN 'GBP'
ELSE 'Tanımsız' END [Döviz],
CASE   WHEN EML.SIGN=0 THEN 'Borç' ELSE 'Alacak' END [Hareket],
EML.DEBIT [Borç],
EML.CREDIT [Alacak],

EML.DEBIT-EML.CREDIT [Bakiye],
EML.LINEEXP [Satır Açıklaması],
CASE WHEN EML.SIGN=0 AND EML.TRNET<>0 THEN EML.TRNET 
WHEN EML.SIGN=1 AND EML.TRNET<>0 THEN EML.TRNET*-1
WHEN EML.SIGN=0 AND EML.TRNET=0 THEN EML.DEBIT+EML.CREDIT 
WHEN EML.SIGN=1 AND EML.TRNET=0 THEN (EML.DEBIT+EML.CREDIT)*-1
END [İD Bakiye],
EMF.GENEXP1 [Genel Açıklama],
EMU.SPECODE [Hesap Özel Kod],
EMU.SPECODE2 [Hesap Özel Kod2],

CASE EMF.MODULENR WHEN 0 THEN 'Kaynak Fiş Türü Olmayanlar' WHEN 1 THEN 'Malzeme Fişleri' WHEN 2 THEN 'Satınalma Faturası' WHEN 3 THEN 'Satış Faturası' WHEN 4 THEN 'Cari Hesap Fişleri' WHEN 5 THEN 'Çek/Senet Bordroları' WHEN 6 THEN 'Banka Fişleri' WHEN 7 THEN 'Kasa İşlemleri' WHEN 20 THEN 'Dağıtım Fişleri' WHEN 25 THEN 'Sabit Kıymet' WHEN 160 THEN 'Teminat Bordroları' WHEN 170 THEN 'Kiralama İşlemleri' ELSE 'Diğer Fişler' END [Kaynak Fiş Türü]
FROM LG_005_01_EMFLINE EML 
             LEFT JOIN LG_005_EMUHACC EMU ON EML.ACCOUNTREF=EMU.LOGICALREF
             LEFT JOIN LG_005_01_EMFICHE EMF ON EMF.LOGICALREF=EML.ACCFICHEREF

WHERE EML.CANCELLED=0





GO

/****** Object:  View [dbo].[DST_005_01_MIZANN]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE VIEW [dbo].[DST_005_01_MIZANN] AS 

SELECT
EMF.FICHENO [Fiş No],
EML.DATE_ [Fiş Tarihi],
month(EML.DATE_) [AY],
YEAR(EML.DATE_) [YIL],
EML.KEBIRCODE [Kebir Hesap],
--LEFT(EMU.CODE,1) [Grup],
EMU.CODE [Hesap Kodu],
EMU.DEFINITION_ [Hesap Adı],
--CASE WHEN EML.TRCURR=0 THEN 'TL'
--           WHEN EML.TRCURR=1 THEN 'USD'
--           WHEN EML.TRCURR=20 THEN 'EUR'
--           WHEN EML.TRCURR=17 THEN 'GBP'
--           ELSE 'Tanımsız' END [Döviz],
CASE   WHEN EML.SIGN=0 THEN 'Borç' ELSE 'Alacak' END [Hareket],
EML.DEBIT [Borç],
EML.CREDIT [Alacak],

EML.DEBIT-EML.CREDIT [Bakiye],
EML.LINEEXP [Satır Açıklaması],
--CASE WHEN EML.SIGN=0 AND EML.TRNET<>0 THEN EML.TRNET 
--           WHEN EML.SIGN=1 AND EML.TRNET<>0 THEN EML.TRNET*-1
--           WHEN EML.SIGN=0 AND EML.TRNET=0 THEN EML.DEBIT+EML.CREDIT 
--           WHEN EML.SIGN=1 AND EML.TRNET=0 THEN (EML.DEBIT+EML.CREDIT)*-1
--           END [İD Bakiye],
EMF.GENEXP1 [Genel Açıklama],
EMU.SPECODE [Hesap Özel Kod],
EMU.SPECODE2 [Hesap Özel Kod2],

CASE EMF.MODULENR WHEN 0 THEN 'Kaynak Fiş Türü Olmayanlar' WHEN 1 THEN 'Malzeme Fişleri' WHEN 2 THEN 'Satınalma Faturası' WHEN 3 THEN 'Satış Faturası' WHEN 4 THEN 'Cari Hesap Fişleri' WHEN 5 THEN 'Çek/Senet Bordroları' WHEN 6 THEN 'Banka Fişleri' WHEN 7 THEN 'Kasa İşlemleri' WHEN 20 THEN 'Dağıtım Fişleri' WHEN 25 THEN 'Sabit Kıymet' WHEN 160 THEN 'Teminat Bordroları' WHEN 170 THEN 'Kiralama İşlemleri' ELSE 'Diğer Fişler' END [Kaynak Fiş Türü]
FROM LG_005_01_EMFLINE EML 
             LEFT JOIN LG_005_EMUHACC EMU ON EML.ACCOUNTREF=EMU.LOGICALREF
             LEFT JOIN LG_005_01_EMFICHE EMF ON EMF.LOGICALREF=EML.ACCFICHEREF

WHERE EML.CANCELLED=0





GO

/****** Object:  View [dbo].[DST_005_01_SATISFATURALARI]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


--USE [TIGERDB]
--GO

--/****** Object:  View [dbo].[DST_005_01_SATISLAR]    Script Date: 14.12.2021 15:51:55 ******/
--SET ANSI_NULLS ON
--GO

--SET QUOTED_IDENTIFIER ON
--GO





----USE [TIGERDB]
----GO

----/****** Object:  View [dbo].[DST_005_01_SATISLAR]    Script Date: 23.06.2020 22:58:17 ******/
----SET ANSI_NULLS ON
----GO

----SET QUOTED_IDENTIFIER ON
------GO

CREATE VIEW [dbo].[DST_005_01_SATISFATURALARI] AS 

SELECT
	--[GRUP KODU] =(SELECT CODE FROM LG_005_CLCARD CLC2 WHERE CLC.PARENTCLREF=CLC2.LOGICALREF and CARDTYPE=4) ,
	CLC2.CODE [Grup Kodu],
	CLC2.DEFINITION_ [Grup Firma Adı],
	--CLC.PARENTCLREF,
	CLC.SPECODE2[Satış Elemanı],
	LEFT(CLC.CODE,6) [Plaka],
	CASE 
	WHEN INV.TRCODE IN (1) THEN 'Satınalma'
	WHEN INV.TRCODE IN (3) THEN 'Toptan Satış İade'
	WHEN INV.TRCODE IN (8) THEN 'Toptan Satış'
	
	
	ELSE 'Diğer' END [Fatura Türü],
	MONTH(INV.DATE_) [Ay],
	DAY(INV.DATE_) [Gün],
	year(ınv.date_) [Yıl],
	INV.DATE_ [Fatura Tarihi],
	INV.FICHENO [Fatura No],
	INV.DOCODE [Fatura Belge No],
	STF.DATE_ [İrsaliye Tarihi],
	STF.FICHENO [İrsaliye No],
	STF.DOCODE [İrsaliye Belge No],
	CLC.CODE [Cari Kodu],
	CLC.DEFINITION_ [Cari Adı],
	CLC.CITY [Cari Şehir],
	CLC.COUNTRY [Cari Ülke],
	CASE WHEN STL.LINETYPE=0 THEN 'Malzeme' WHEN STL.LINETYPE=1 THEN 'Promosyon' WHEN STL.LINETYPE=4 THEN 'Hizmet' ELSE 'Diğer' END [Satır], 
	--STL.TRCODE,
	ISNULL(ITM.CODE,'')+ISNULL(SRV.CODE,'') [Stok/Hizmet Kodu],
	ISNULL(ITM.NAME,'')+ISNULL(SRV.DEFINITION_,'') [Stok/Hizmet Adı],
	--ITM.PRODUCERCODE [Stok Üretici kodu],
	--SPE.DEFINITION_ [Stok Grup Adı],
	STL.AMOUNT  [İadesiz Miktar],
	CASE WHEN STL.TRCODE IN (3,8) THEN STL.AMOUNT*-1 ELSE STL.AMOUNT END [İadeli Miktar],
	UNT.CODE [Satır Birim],	
	CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.PRICE END [Birim Fiyat],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.VATMATRAH END [KDV Matrah],
	CASE WHEN INV.TRCODE IN (8) THEN  STL.VATMATRAH WHEN INV.TRCODE IN (1,3) THEN  STL.VATMATRAH*-1 ELSE 0 END [KDV Matrah],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.VATAMNT END [KDV],
	CASE WHEN INV.TRCODE IN (8) THEN STL.VATAMNT WHEN INV.TRCODE IN (1,3) THEN  STL.VATAMNT*-1 ELSE 0 END [KDV],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.DISTDISC END [İndirim],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.DISTEXP END [Masraf],
	--CASE WHEN STL.LINETYPE=1 THEN 0 ELSE  STL.VATMATRAH+STL.VATAMNT END [KDV'li Tutar],
	CASE WHEN INV.TRCODE IN (8) THEN STL.VATMATRAH+STL.VATAMNT WHEN INV.TRCODE IN (1,3) THEN (STL.VATMATRAH+STL.VATAMNT)*-1 ELSE 0 END [KDV'li Tutar],
	INV.GENEXP1 + INV.GENEXP2 [Fatura Açıklama],
	STL.LINEEXP [Satır Açıklama]
	--PAY.CODE [Ödeme Planı]
	
	
FROM LG_005_01_STLINE STL WITH(NOLOCK)
		LEFT JOIN LG_005_ITEMS ITM WITH(NOLOCK) ON STL.STOCKREF=ITM.LOGICALREF AND STL.LINETYPE IN (0,1)
		LEFT JOIN LG_005_SRVCARD SRV WITH(NOLOCK) ON STL.STOCKREF=SRV.LOGICALREF AND STL.LINETYPE=4
		LEFT JOIN LG_005_CLCARD CLC WITH(NOLOCK) ON CLC.LOGICALREF=STL.CLIENTREF --AND CLC.CODE LIKE '120%'
		LEFT JOIN LG_005_CLCARD CLC2 WITH(NOLOCK) ON CLC2.LOGICALREF=CLC.PARENTCLREF AND CLC2.CARDTYPE=4
	    LEFT JOIN LG_005_01_INVOICE INV WITH(NOLOCK) ON INV.LOGICALREF=STL.INVOICEREF
		LEFT JOIN LG_005_01_STFICHE STF WITH(NOLOCK) ON STF.LOGICALREF=STL.STFICHEREF
		LEFT JOIN LG_005_UNITSETL UNT WITH(NOLOCK) ON STL.UOMREF=UNT.LOGICALREF
		LEFT JOIN LG_005_SPECODES SPE WITH(NOLOCK) ON SPE.SPECODE=ITM.STGRPCODE AND SPE.CODETYPE=4 AND SPE.SPECODETYPE=0
		LEFT JOIN LG_005_PAYPLANS PAY WITH(NOLOCK) ON INV.PAYDEFREF=PAY.LOGICALREF
		LEFT JOIN LG_005_ITMUNITA ITU2  WITH(NOLOCK) ON ITU2.ITEMREF=ITM.LOGICALREF AND ITU2.LINENR=2
		LEFT JOIN LG_005_ITMUNITA ITU3  WITH(NOLOCK) ON ITU3.ITEMREF=ITM.LOGICALREF AND ITU3.LINENR=3
		LEFT JOIN L_CAPIWHOUSE AMB ON AMB.NR=STL.SOURCEINDEX AND AMB.FIRMNR=005
		LEFT JOIN L_CAPIUSER USR ON USR.NR=STF.CAPIBLOCK_CREATEDBY
		LEFT JOIN LG_SLSMAN SLS ON SLS.LOGICALREF=STF.SALESMANREF
		

WHERE INV.TRCODE IN (3,8,9) AND INV.CANCELLED=0 AND STL.LINETYPE IN (0,1,4) AND STL.BILLED=1 --and (ITM.CODE LIKE '150%' OR ITM.CODE LIKE '151%' OR ITM.CODE LIKE '152%' OR ITM.CODE LIKE '153%') AND (CLC.CODE BETWEEN '120.01.001.01' AND '120.89.001.01')



GO

/****** Object:  View [dbo].[DST_005_INDIRILICEK_KDV]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE view [dbo].[DST_005_INDIRILICEK_KDV]
AS
SELECT
   top 100 percent

       '' [Sıra No]
	  ,I.DATE_ [Alış Faturasının Tarihi]
	  ,CASE I.EINVOICE WHEN 0 THEN LEFT(I.FICHENO,1) ELSE '' END [Alış  Serisi]
	  ,I.FICHENO [Alış Faturasının Sıra No'su]
	  ,I.DOCODE [Alış Faturasının Belge No,'su]
	  ,CL.DEFINITION_ [Satıcının Adı-Soyadı / Ünvanı]
	  ,CL.TAXNR+''+CL.TCKNO [Satıcının Vergi Kimlik Numarası / TC Kimlik Numarası]
	  ,(SELECT TOP 1 LINEEXP FROM LG_005_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))   [Alınan Mal ve/veya Hizmetin Cinsi]
	  ,(SELECT SUM(AMOUNT) FROM LG_005_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [Alınan Mal ve/veya Hizmetin Miktarı]
	  ,(SELECT SUM(VATMATRAH) FROM LG_005_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [Alınan Mal ve/veya Hizmetin KDV Hariç Tutarı]
	  ,(SELECT SUM(VATAMNT) FROM LG_005_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [KDV'si]
	  ,(SELECT  SUM((STL.VATMATRAH * (STL.VAT / 100) )* (CASE WHEN STL.TRCODE IN (1,4,3, 2) THEN - 1 ELSE 1 END)-STL.VATAMNT * (CASE WHEN STL.TRCODE IN (1,4,3, 2) THEN - 1 ELSE 1 END))*-1 FROM LG_005_01_STLINE STL WHERE STL.INVOICEREF=I.LOGICALREF AND  STL.LINETYPE IN (0,4))  [TEV KDV]
                         --STL.VATAMNT * (CASE WHEN STL.TRCODE IN (1,4,3, 2) THEN - 1 ELSE 1 END) [KDV], )
	  ,'' [GGB Tescil No'su (Alış İthalat İse)]
	  ,CONVERT(NVARCHAR,YEAR(I.DATE_))+CONVERT(NVARCHAR,MONTH(I.DATE_))  [Belgenin İndirim Hakkının Kullanıldığı KDV Dönemi]
	   
FROM 
    LG_005_01_INVOICE I INNER JOIN
	LG_005_CLCARD CL ON I.CLIENTREF=CL.LOGICALREF


WHERE I.CANCELLED=0
     AND I.TRCODE IN (1,4) ---and I.FICHENO='TEST'

	 ORDER BY DATE_








GO

/****** Object:  View [dbo].[DST_005_SATISFATURALARI]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE view [dbo].[DST_005_SATISFATURALARI] AS
SELECT
    top 100 percent
       '' [Sıra No]
	  ,I.DATE_ [Satış Faturasının Tarihi ]
	  ,I.DOCODE [Satış Faturasının Serisi]
	  ,I.FICHENO [Satış Faturasının Sıra No'su]
	  ,CL.DEFINITION_ [Satıcının Adı-Soyadı / Ünvanı]
	  ,CL.TAXNR+''+CL.TCKNO [Satıcının Vergi Kimlik Numarası / TC Kimlik Numarası]
	  ,(select TOP 1 CODE FROM LG_005_ITEMS WHERE LOGICALREF IN (SELECT STOCKREF FROM LG_005_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4)))   [Alınan Mal ve/veya Hizmetin Cinsi]
	  ,CONVERT(NVARCHAR,(SELECT SUM(AMOUNT) FROM LG_005_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4)))  [Satılan Mal ve/veya Hizmetin Miktarı]
	  ,(SELECT SUM(VATMATRAH) FROM LG_005_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [Satılan Mal ve/veya Hizmetin KDV Hariç Tutarı]
	  ,I.VAT [Kdv Oranı (%)]
	  ,(SELECT SUM(VATAMNT) FROM LG_005_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [KDV'si]
	  ,'406' [İade işlem Türü]
	 
	   
FROM 
    LG_005_01_INVOICE I INNER JOIN
	LG_005_CLCARD CL ON I.CLIENTREF=CL.LOGICALREF


WHERE I.CANCELLED=0
     AND I.TRCODE IN (7,8,9)

	 ORDER BY DATE_
GO

/****** Object:  View [dbo].[DST_005_SATISFATURALARI_1]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE view [dbo].[DST_005_SATISFATURALARI_1]
AS
SELECT
     top 100 percent

       '' [Sıra No]
	  ,I.DATE_ [Satış Faturasının Tarihi ]
	  ,I.DOCODE [Satış Faturasının Serisi]
	  ,I.FICHENO [Satış Faturasının Sıra No'su]
	  ,CL.DEFINITION_ [Satıcının Adı-Soyadı / Ünvanı]
	  ,CL.TAXNR+''+CL.TCKNO [Satıcının Vergi Kimlik Numarası / TC Kimlik Numarası]
	  ,(select TOP 1 CODE FROM LG_005_ITEMS WHERE LOGICALREF IN (SELECT STOCKREF FROM LG_005_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4)))   [Alınan Mal ve/veya Hizmetin Cinsi]
	  ,CONVERT(NVARCHAR,(SELECT SUM(AMOUNT) FROM LG_005_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4)))  [Satılan Mal ve/veya Hizmetin Miktarı]
	  ,(SELECT SUM(VATMATRAH) FROM LG_005_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [Satılan Mal ve/veya Hizmetin KDV Hariç Tutarı]
	  ,I.VAT [Kdv Oranı (%)]
	  ,(SELECT SUM(VATAMNT) FROM LG_005_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [KDV'si]
	  ,'406' [İade işlem Türü]
	 
	   
FROM 
    LG_005_01_INVOICE I INNER JOIN
	LG_005_CLCARD CL ON I.CLIENTREF=CL.LOGICALREF


WHERE I.CANCELLED=0
     AND I.TRCODE IN (7,8,9)

	 ORDER BY DATE_



GO

/****** Object:  View [dbo].[DST_445_01_ENVANTER]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[DST_445_01_ENVANTER] AS 
SELECT
--ITM.LOGICALREF
ITM.CODE [KODU]
,ITM.NAME [ADI]
,ITM.SPECODE2 [ÖZELKODU2]
,[CINSI] = (SELECT UNL.CODE FROM LG_445_UNITSETL UNL WHERE UNL.UNITSETREF = ITM.UNITSETREF AND UNL.LINENR = 1)

,ROUND(GNT.ONHAND,2) [FIILI STOK]
--,ROUND(GNT.RESERVED,2) [REZERVE STOK]
,ROUND(GNT.ONHAND - GNT.RESERVED,2) [GERCEK STOK]

--,[TL] = (SELECT AVG(SLT.TL) FROM STC_445_01_STOKDURUM_ALT SLT WHERE SLT.STOCKREF = ITM.LOGICALREF)
--,[BİRİMMALİYET] = (SELECT SUM(SLT.TUTAR)/SUM(SLT.MIKTAR) FROM STC_445_01_STOKDURUM_ALT SLT WHERE SLT.STOCKREF = ITM.LOGICALREF AND SLT.AMBAR=GNT.INVENNO)
--,[AMBAR]=(SELECT SLT.AMBAR FROM STC_445_01_STOKDURUM_ALT SLT WHERE SLT.STOCKREF = ITM.LOGICALREF AND SLT.AMBAR=GNT.INVENNO)
--,[KALAN TUTAR]=ROUND(GNT.ONHAND - GNT.RESERVED,2)*(SELECT SUM(SLT.TUTAR)/SUM(SLT.MIKTAR) FROM STC_445_01_STOKDURUM_ALT SLT WHERE SLT.STOCKREF = ITM.LOGICALREF AND SLT.AMBAR=GNT.INVENNO)
,GNT.INVENNO [AMBARNO]
,CPI.NAME [AMBAR ADI]
FROM LG_445_ITEMS ITM
LEFT JOIN LV_445_01_GNTOTST GNT ON GNT.STOCKREF = ITM.LOGICALREF AND GNT.INVENNO <>-1
LEFT JOIN L_CAPIWHOUSE CPI ON CPI.NR = GNT.INVENNO AND FIRMNR = 445

WHERE ITM.ACTIVE = 0  AND ITM.CARDTYPE IN (1,10,11,12)AND ROUND(GNT.ONHAND,2)>0 --- and ıtm.code='ERSE-1176'--AND ITM.LOGICALREF='226297'--AND ITM.LOGICALREF = 36
GO

/****** Object:  View [dbo].[DSTK_003_01_MIZAN]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE VIEW [dbo].[DSTK_003_01_MIZAN] AS

SELECT                EMF.DATE_ AS FİŞ_TARİHİ,
                      EMK.CODE AS KEBIR_KODU,EMK.DEFINITION_ AS KEBIR_ADI,
					  EMK.SPECODE AS OZEL_KOD,
					                      
                      
                      SUM(EML.DEBIT) AS BORC, SUM(EML.CREDIT) AS ALACAK,SUM(EML.DEBIT - EML.CREDIT) AS BAKIYE

                      --CASE WHEN EML.TRCURR = 0 THEN EML.DEBIT  ELSE CASE WHEN EML.SIGN=0 THEN EML.TRNET ELSE 0 END END AS BORC_ID, 
                      --CASE WHEN EML.TRCURR = 0 THEN EML.CREDIT ELSE CASE WHEN EML.SIGN=1 THEN EML.TRNET ELSE 0 END END AS ALACAK_ID,
                      --CASE WHEN EML.TRCURR = 0 THEN EML.DEBIT-EML.CREDIT ELSE CASE WHEN EML.SIGN=0 THEN EML.TRNET  ELSE EML.TRNET * - 1 END END AS BAKIYE_ID,
                      --CASE WHEN EML.SIGN = 0 THEN EML.REPORTNET ELSE 0 END AS BORC_RD, 
                      --CASE WHEN EML.SIGN = 1 THEN EML.REPORTNET ELSE 0 END AS ALACAK_RD, 
                      --CASE WHEN EML.SIGN = 0 THEN EML.REPORTNET ELSE EML.REPORTNET * - 1 END AS BAKIYE_RD,
                     
FROM   dbo.LG_003_01_EMFLINE AS EML LEFT  JOIN
                      dbo.LG_003_01_EMFICHE AS EMF ON EMF.LOGICALREF = EML.ACCFICHEREF LEFT  JOIN
                      dbo.LG_003_EMUHACC AS EMK ON EML.KEBIRCODE = EMK.CODE
WHERE(EML.CANCELLED = 0)AND EMF.DATE_ BETWEEN '20180101' AND '21001231'
GROUP BY EMK.CODE,EMK.DEFINITION_,EMK.SPECODE,EMF.DATE_  --ORDER BY EMK.CODE



UNION ALL


SELECT                EMF.DATE_ AS FİŞ_TARİHİ,
                      EMK1.CODE AS KEBIR_KODU,
                      EMK1.SPECODE AS OZEL_KOD,
                      EMK1.DEFINITION_ AS KEBIR_ADI,
                 
                      
                      SUM(EML.DEBIT) AS BORC, SUM(EML.CREDIT) AS ALACAK,SUM(EML.DEBIT - EML.CREDIT) AS BAKIYE

                      --CASE WHEN EML.TRCURR = 0 THEN EML.DEBIT  ELSE CASE WHEN EML.SIGN=0 THEN EML.TRNET ELSE 0 END END AS BORC_ID, 
                      --CASE WHEN EML.TRCURR = 0 THEN EML.CREDIT ELSE CASE WHEN EML.SIGN=1 THEN EML.TRNET ELSE 0 END END AS ALACAK_ID,
                      --CASE WHEN EML.TRCURR = 0 THEN EML.DEBIT-EML.CREDIT ELSE CASE WHEN EML.SIGN=0 THEN EML.TRNET  ELSE EML.TRNET * - 1 END END AS BAKIYE_ID,
                      --CASE WHEN EML.SIGN = 0 THEN EML.REPORTNET ELSE 0 END AS BORC_RD, 
                      --CASE WHEN EML.SIGN = 1 THEN EML.REPORTNET ELSE 0 END AS ALACAK_RD, 
                      --CASE WHEN EML.SIGN = 0 THEN EML.REPORTNET ELSE EML.REPORTNET * - 1 END AS BAKIYE_RD,
                     
FROM   dbo.LG_003_01_EMFLINE AS EML LEFT  JOIN
                      dbo.LG_003_01_EMFICHE AS EMF ON EMF.LOGICALREF = EML.ACCFICHEREF LEFT  JOIN
                      dbo.LG_003_EMUHACC AS EMK ON EML.KEBIRCODE = EMK.CODE LEFT  JOIN
                      dbo.LG_003_EMUHACC AS EMK1 ON EML.ACCOUNTCODE = EMK1.CODE
WHERE(EML.CANCELLED = 0)AND EMF.DATE_ BETWEEN '20180101' AND '21001231'
GROUP BY EMK1.CODE,EMK1.DEFINITION_,EMK1.SPECODE,EMF.DATE_  --ORDER BY EMK1.CODE



---UNION ALL

--SELECT                EMF.DATE_ AS FİŞ_TARİHİ,
--                      --EMK1.CODE AS KEBIR_KODU,
--                      SUBSTRING(EMK1.CODE,1,6) AS KEBIR_KODU,
--                      --EMK1.DEFINITION_ AS KEBIR_ADI,
--                      (SELECT DEFINITION_ FROM LG_003_EMUHACC WHERE CODE=SUBSTRING(EMK1.CODE,1,6))AS KEBIR_ADI,
                 
                      
--                      SUM(EML.DEBIT) AS BORC, SUM(EML.CREDIT) AS ALACAK,SUM(EML.DEBIT - EML.CREDIT) AS BAKIYE

--                      --CASE WHEN EML.TRCURR = 0 THEN EML.DEBIT  ELSE CASE WHEN EML.SIGN=0 THEN EML.TRNET ELSE 0 END END AS BORC_ID, 
--                      --CASE WHEN EML.TRCURR = 0 THEN EML.CREDIT ELSE CASE WHEN EML.SIGN=1 THEN EML.TRNET ELSE 0 END END AS ALACAK_ID,
--                      --CASE WHEN EML.TRCURR = 0 THEN EML.DEBIT-EML.CREDIT ELSE CASE WHEN EML.SIGN=0 THEN EML.TRNET  ELSE EML.TRNET * - 1 END END AS BAKIYE_ID,
--                      --CASE WHEN EML.SIGN = 0 THEN EML.REPORTNET ELSE 0 END AS BORC_RD, 
--                      --CASE WHEN EML.SIGN = 1 THEN EML.REPORTNET ELSE 0 END AS ALACAK_RD, 
--                      --CASE WHEN EML.SIGN = 0 THEN EML.REPORTNET ELSE EML.REPORTNET * - 1 END AS BAKIYE_RD,
                     
--FROM   dbo.LG_003_01_EMFLINE AS EML LEFT  JOIN
--                      dbo.LG_003_01_EMFICHE AS EMF ON EMF.LOGICALREF = EML.ACCFICHEREF LEFT  JOIN
--                      dbo.LG_003_EMUHACC AS EMK ON EML.KEBIRCODE = EMK.CODE LEFT  JOIN
--                      dbo.LG_003_EMUHACC AS EMK1 ON EML.ACCOUNTCODE = EMK1.CODE
--WHERE(EML.CANCELLED = 0)AND EMF.DATE_ BETWEEN '20180101' AND '21001231'
--GROUP BY EMK1.CODE,EMK1.DEFINITION_,EMF.DATE_  --ORDER BY EMK1.CODE

--SELECT * FROM LG_003_01_EMFLINE ORDER BY ACCOUNTCODE
--SELECT * FROM LG_003_EMUHACC ORDER BY CODE
--SELECT * FROM LG_003_EMUHACC ORDER BY LOGICALREF

GO

/****** Object:  View [dbo].[ELDEKILERIN_ORTALAMASI_001]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[ELDEKILERIN_ORTALAMASI_001]
AS
SELECT 


 SUM(AMOUNT) [AMOUNT]
 ,AVG(PRICE) [PRICE]
,L.STOCKREF 
,MONTH(L.DATE_) [AY]

 FROM LG_001_01_STLINE L


 WHERE 
       IOCODE=1
  
GROUP BY DATE_ ,L.STOCKREF,L.DATE_
GO

/****** Object:  View [dbo].[ENO_001_INDIRILICEK_KDV]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE view [dbo].[ENO_001_INDIRILICEK_KDV]
AS
SELECT
     top 100 percent

       '' [Sıra No]
	  ,I.DATE_ [Alış Faturasının Tarihi]
	  ,I.DOCODE [Alış Faturasının Serisi]
	  ,I.FICHENO [Alış Faturasının Sıra No'su]
	  ,CL.DEFINITION_ [Satıcının Adı-Soyadı / Ünvanı]
	  ,CL.TAXNR+''+CL.TCKNO [Satıcının Vergi Kimlik Numarası / TC Kimlik Numarası]
	  ,(SELECT TOP 1 LINEEXP FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))   [Alınan Mal ve/veya Hizmetin Cinsi]
	  ,(SELECT SUM(AMOUNT) FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [Alınan Mal ve/veya Hizmetin Miktarı]
	  ,(SELECT SUM(VATMATRAH) FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [Alınan Mal ve/veya Hizmetin KDV Hariç Tutarı]
	  ,(SELECT SUM(VATAMNT) FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [KDV'si]
	  ,'' [GGB Tescil No'su (Alış İthalat İse)]
	  ,CONVERT(NVARCHAR,YEAR(I.DATE_))+CONVERT(NVARCHAR,MONTH(I.DATE_))  [Belgenin İndirim Hakkının Kullanıldığı KDV Dönemi]
	   
FROM 
    LG_002_01_INVOICE I INNER JOIN
	LG_002_CLCARD CL ON I.CLIENTREF=CL.LOGICALREF


WHERE I.CANCELLED=0
     AND I.TRCODE IN (1,4)

	 ORDER BY DATE_





GO

/****** Object:  View [dbo].[ENO_001_SATISFATURALARI]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE view [dbo].[ENO_001_SATISFATURALARI]
AS
SELECT
     top 100 percent

       '' [Sıra No]
	  ,I.DATE_ [Satış Faturasının Tarihi ]
	  ,I.DOCODE [Satış Faturasının Serisi]
	  ,I.FICHENO [Satış Faturasının Sıra No'su]
	  ,CL.DEFINITION_ [Satıcının Adı-Soyadı / Ünvanı]
	  ,CL.TAXNR+''+CL.TCKNO [Satıcının Vergi Kimlik Numarası / TC Kimlik Numarası]
	  ,(select TOP 1 CODE FROM LG_002_ITEMS WHERE LOGICALREF IN (SELECT STOCKREF FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4)))   [Alınan Mal ve/veya Hizmetin Cinsi]
	  ,CONVERT(NVARCHAR,(SELECT SUM(AMOUNT) FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4)))  [Satılan Mal ve/veya Hizmetin Miktarı]
	  ,(SELECT SUM(VATMATRAH) FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [Satılan Mal ve/veya Hizmetin KDV Hariç Tutarı]
	  ,I.VAT [Kdv Oranı (%)]
	  ,(SELECT SUM(VATAMNT) FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [KDV'si]
	  ,'406' [İade işlem Türü]
	 
	   
FROM 
    LG_002_01_INVOICE I INNER JOIN
	LG_002_CLCARD CL ON I.CLIENTREF=CL.LOGICALREF


WHERE I.CANCELLED=0
     AND I.TRCODE IN (7,8,9)

	 ORDER BY DATE_



GO

/****** Object:  View [dbo].[ENO_002_INDIRILICEK_KDV_1]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE view [dbo].[ENO_002_INDIRILICEK_KDV_1]
AS
SELECT
     top 100 percent

       '' [Sıra No]
	  ,I.DATE_ [Alış Faturasının Tarihi]
	  ,I.DOCODE [Alış Faturasının Serisi]
	  ,I.FICHENO [Alış Faturasının Sıra No'su]
	  ,CL.DEFINITION_ [Satıcının Adı-Soyadı / Ünvanı]
	  ,CL.TAXNR+''+CL.TCKNO [Satıcının Vergi Kimlik Numarası / TC Kimlik Numarası]
	  ,(SELECT TOP 1 LINEEXP FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))   [Alınan Mal ve/veya Hizmetin Cinsi]
	  ,(SELECT SUM(AMOUNT) FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [Alınan Mal ve/veya Hizmetin Miktarı]
	  ,(SELECT SUM(VATMATRAH) FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [Alınan Mal ve/veya Hizmetin KDV Hariç Tutarı]
	  ,(SELECT SUM(VATAMNT) FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [KDV'si]
	  ,'' [GGB Tescil No'su (Alış İthalat İse)]
	  ,CONVERT(NVARCHAR,YEAR(I.DATE_))+CONVERT(NVARCHAR,MONTH(I.DATE_))  [Belgenin İndirim Hakkının Kullanıldığı KDV Dönemi]
	   
FROM 
    LG_002_01_INVOICE I INNER JOIN
	LG_002_CLCARD CL ON I.CLIENTREF=CL.LOGICALREF


WHERE I.CANCELLED=0
     AND I.TRCODE IN (1,4)

	 ORDER BY DATE_





GO

/****** Object:  View [dbo].[ENO_002_SATISFATURALARI]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE view [dbo].[ENO_002_SATISFATURALARI]
AS
SELECT
     top 100 percent

       '' [Sıra No]
	  ,I.DATE_ [Satış Faturasının Tarihi ]
	  ,I.DOCODE [Satış Faturasının Serisi]
	  ,I.FICHENO [Satış Faturasının Sıra No'su]
	  ,CL.DEFINITION_ [Satıcının Adı-Soyadı / Ünvanı]
	  ,CL.TAXNR+''+CL.TCKNO [Satıcının Vergi Kimlik Numarası / TC Kimlik Numarası]
	  ,(select TOP 1 CODE FROM LG_002_ITEMS WHERE LOGICALREF IN (SELECT STOCKREF FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4)))   [Alınan Mal ve/veya Hizmetin Cinsi]
	  ,CONVERT(NVARCHAR,(SELECT SUM(AMOUNT) FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4)))  [Satılan Mal ve/veya Hizmetin Miktarı]
	  ,(SELECT SUM(VATMATRAH) FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [Satılan Mal ve/veya Hizmetin KDV Hariç Tutarı]
	  ,I.VAT [Kdv Oranı (%)]
	  ,(SELECT SUM(VATAMNT) FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [KDV'si]
	  ,'406' [İade işlem Türü]
	 
	   
FROM 
    LG_002_01_INVOICE I INNER JOIN
	LG_002_CLCARD CL ON I.CLIENTREF=CL.LOGICALREF


WHERE I.CANCELLED=0
     AND I.TRCODE IN (7,8,9)

	 ORDER BY DATE_




GO

/****** Object:  View [dbo].[ENO_002_SATISFATURALARI_1]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE view [dbo].[ENO_002_SATISFATURALARI_1]
AS
SELECT
     top 100 percent

       '' [Sıra No]
	  ,I.DATE_ [Satış Faturasının Tarihi ]
	  ,I.DOCODE [Satış Faturasının Serisi]
	  ,I.FICHENO [Satış Faturasının Sıra No'su]
	  ,CL.DEFINITION_ [Satıcının Adı-Soyadı / Ünvanı]
	  ,CL.TAXNR+''+CL.TCKNO [Satıcının Vergi Kimlik Numarası / TC Kimlik Numarası]
	  ,(select TOP 1 CODE FROM LG_002_ITEMS WHERE LOGICALREF IN (SELECT STOCKREF FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4)))   [Alınan Mal ve/veya Hizmetin Cinsi]
	  ,CONVERT(NVARCHAR,(SELECT SUM(AMOUNT) FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4)))  [Satılan Mal ve/veya Hizmetin Miktarı]
	  ,(SELECT SUM(VATMATRAH) FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [Satılan Mal ve/veya Hizmetin KDV Hariç Tutarı]
	  ,I.VAT [Kdv Oranı (%)]
	  ,(SELECT SUM(VATAMNT) FROM LG_002_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [KDV'si]
	  ,'406' [İade işlem Türü]
	 
	   
FROM 
    LG_002_01_INVOICE I INNER JOIN
	LG_002_CLCARD CL ON I.CLIENTREF=CL.LOGICALREF


WHERE I.CANCELLED=0
     AND I.TRCODE IN (7,8,9)

	 ORDER BY DATE_



GO

/****** Object:  View [dbo].[ENO_003_INDIRILICEK_KDV]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE view [dbo].[ENO_003_INDIRILICEK_KDV]
AS
SELECT
     top 100 percent

       '' [Sıra No]
	  ,I.DATE_ [Alış Faturasının Tarihi]
	  ,I.DOCODE [Alış Faturasının Serisi]
	  ,I.FICHENO [Alış Faturasının Sıra No'su]
	  ,CL.DEFINITION_ [Satıcının Adı-Soyadı / Ünvanı]
	  ,CL.TAXNR+''+CL.TCKNO [Satıcının Vergi Kimlik Numarası / TC Kimlik Numarası]
	  ,(SELECT TOP 1 LINEEXP FROM LG_003_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))   [Alınan Mal ve/veya Hizmetin Cinsi]
	  ,(SELECT SUM(AMOUNT) FROM LG_003_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [Alınan Mal ve/veya Hizmetin Miktarı]
	  ,(SELECT SUM(VATMATRAH) FROM LG_003_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [Alınan Mal ve/veya Hizmetin KDV Hariç Tutarı]
	  ,(SELECT SUM(VATAMNT) FROM LG_003_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [KDV'si]
	  ,'' [GGB Tescil No'su (Alış İthalat İse)]
	  ,CONVERT(NVARCHAR,YEAR(I.DATE_))+CONVERT(NVARCHAR,MONTH(I.DATE_))  [Belgenin İndirim Hakkının Kullanıldığı KDV Dönemi]
	   
FROM 
    LG_003_01_INVOICE I INNER JOIN
	LG_003_CLCARD CL ON I.CLIENTREF=CL.LOGICALREF


WHERE I.CANCELLED=0
     AND I.TRCODE IN (1,4)

	 ORDER BY DATE_






GO

/****** Object:  View [dbo].[ENO_003_SATISFATURALARI]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE view [dbo].[ENO_003_SATISFATURALARI] AS
SELECT
     top 100 percent

       '' [Sıra No]
	  ,I.DATE_ [Satış Faturasının Tarihi ]
	  ,I.DOCODE [Satış Faturasının Serisi]
	  ,I.FICHENO [Satış Faturasının Sıra No'su]
	  ,CL.DEFINITION_ [Satıcının Adı-Soyadı / Ünvanı]
	  ,CL.TAXNR+''+CL.TCKNO [Satıcının Vergi Kimlik Numarası / TC Kimlik Numarası]
	  ,(select TOP 1 CODE FROM LG_003_ITEMS WHERE LOGICALREF IN (SELECT STOCKREF FROM LG_003_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4)))   [Alınan Mal ve/veya Hizmetin Cinsi]
	  ,CONVERT(NVARCHAR,(SELECT SUM(AMOUNT) FROM LG_003_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4)))  [Satılan Mal ve/veya Hizmetin Miktarı]
	  ,(SELECT SUM(VATMATRAH) FROM LG_003_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [Satılan Mal ve/veya Hizmetin KDV Hariç Tutarı]
	  ,I.VAT [Kdv Oranı (%)]
	  ,(SELECT SUM(VATAMNT) FROM LG_003_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [KDV'si]
	  ,'406' [İade işlem Türü]
	 
	   
FROM 
    LG_003_01_INVOICE I INNER JOIN
	LG_003_CLCARD CL ON I.CLIENTREF=CL.LOGICALREF


WHERE I.CANCELLED=0
     AND I.TRCODE IN (7,8,9)

	 ORDER BY DATE_




GO

/****** Object:  View [dbo].[ENO_004_INDIRILICEK_KDV]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE view [dbo].[ENO_004_INDIRILICEK_KDV]
AS
SELECT
     top 100 percent

       '' [Sıra No]
	  ,I.DATE_ [Alış Faturasının Tarihi]
	  ,CASE I.EINVOICE WHEN 0 THEN LEFT(I.FICHENO,1) ELSE '' END [Alış  Serisi]
	  ,I.FICHENO [Alış Faturasının Sıra No'su]
	  ,I.DOCODE [Alış Faturasının Belge No,'su]
	  ,CL.DEFINITION_ [Satıcının Adı-Soyadı / Ünvanı]
	  ,CL.TAXNR+''+CL.TCKNO [Satıcının Vergi Kimlik Numarası / TC Kimlik Numarası]
	  ,(SELECT TOP 1 LINEEXP FROM LG_004_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))   [Alınan Mal ve/veya Hizmetin Cinsi]
	  ,(SELECT SUM(AMOUNT) FROM LG_004_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [Alınan Mal ve/veya Hizmetin Miktarı]
	  ,(SELECT SUM(VATMATRAH) FROM LG_004_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [Alınan Mal ve/veya Hizmetin KDV Hariç Tutarı]
	  ,(SELECT SUM(VATAMNT) FROM LG_004_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [KDV'si]
	  ,'' [GGB Tescil No'su (Alış İthalat İse)]
	  ,CONVERT(NVARCHAR,YEAR(I.DATE_))+CONVERT(NVARCHAR,MONTH(I.DATE_))  [Belgenin İndirim Hakkının Kullanıldığı KDV Dönemi]
	   
FROM 
    LG_004_01_INVOICE I INNER JOIN
	LG_004_CLCARD CL ON I.CLIENTREF=CL.LOGICALREF


WHERE I.CANCELLED=0
     AND I.TRCODE IN (1,4)

	 ORDER BY DATE_







GO

/****** Object:  View [dbo].[ENO_004_SATISFATURALARI]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE view [dbo].[ENO_004_SATISFATURALARI] AS
SELECT
     top 100 percent

       '' [Sıra No]
	  ,I.DATE_ [Satış Faturasının Tarihi ]
	  ,I.DOCODE [Satış Faturasının Serisi]
	  ,I.FICHENO [Satış Faturasının Sıra No'su]
	  ,CL.DEFINITION_ [Satıcının Adı-Soyadı / Ünvanı]
	  ,CL.TAXNR+''+CL.TCKNO [Satıcının Vergi Kimlik Numarası / TC Kimlik Numarası]
	  ,(select TOP 1 CODE FROM LG_004_ITEMS WHERE LOGICALREF IN (SELECT STOCKREF FROM LG_004_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4)))   [Alınan Mal ve/veya Hizmetin Cinsi]
	  ,CONVERT(NVARCHAR,(SELECT SUM(AMOUNT) FROM LG_004_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4)))  [Satılan Mal ve/veya Hizmetin Miktarı]
	  ,(SELECT SUM(VATMATRAH) FROM LG_004_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [Satılan Mal ve/veya Hizmetin KDV Hariç Tutarı]
	  ,I.VAT [Kdv Oranı (%)]
	  ,(SELECT SUM(VATAMNT) FROM LG_004_01_STLINE WHERE INVOICEREF=I.LOGICALREF AND LINETYPE IN (0,4))  [KDV'si]
	  ,'406' [İade işlem Türü]
	 
	   
FROM 
    LG_004_01_INVOICE I INNER JOIN
	LG_004_CLCARD CL ON I.CLIENTREF=CL.LOGICALREF


WHERE I.CANCELLED=0
     AND I.TRCODE IN (7,8,9)

	 ORDER BY DATE_





GO

/****** Object:  View [dbo].[GNC_003_01_ACIK_SIPARISLER]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO







CREATE VIEW [dbo].[GNC_003_01_ACIK_SIPARISLER] AS
SELECT

ORF.FICHENO [SIPARIS FIS NO]
,ORF.DATE_ [FIS TARIHI]
,ORL.DUEDATE [TESLIM_TARIHI]
,ORF.DOCODE [BELGE NO]
,CLC.CODE [CH KODU]
,CLC.DEFINITION_ [CH UNVAN]
,PYP.CODE [ODEME PLANI]
,CASE ORL.TRCODE WHEN 1 THEN 'SATIS SIPARIS' WHEN 2 THEN 'SATIN ALMA SIPARS' END [TUR]
,ITM.CODE [MALZ. KODU]
,ITM.PRODUCERCODE [URETICI KODU]
,ITM.SPECODE2 [MARKA]
,ITM.NAME [MALZ. ADI]
,CPW.NAME [AMBAR]
,ORL.AMOUNT [MIKTAR]
,ORL.SHIPPEDAMOUNT [SEVK EDILEN MIKTAR]
,ORL.AMOUNT - ORL.SHIPPEDAMOUNT [BEKLEYEN]
,(ORL.AMOUNT - ORL.SHIPPEDAMOUNT) * (ORL.LINENET / ORL.AMOUNT) [BEKLEYEN TUTAR]
,ORF.NETTOTAL [NET FİŞ TOPLAMI]
,ORF.TOTALVAT [FİŞ KDV TUTARI]
,ORF.TOTALDISCOUNTED [KDVSIZ_TUTAR]
,ORF.TOTALDISCOUNTS [FİŞ İNDİRİM TUTARI]

,UNL.CODE [BIRIM]
,ROUND((ORL.LINENET / ORL.AMOUNT),3) [BIRIM FIYAT]
,CASE ORL.VAT WHEN 0 THEN 0 ELSE ((ROUND((ORL.LINENET / ORL.AMOUNT),3) * ORL.VAT)) / 100 END [KDV'SI]

,CASE ORL.TRCURR WHEN 0 THEN ROUND((ORL.LINENET / ORL.AMOUNT),3) ELSE ROUND((ORL.LINENET / ORL.AMOUNT),3) / ORL.TRRATE END [ID BIRIM FIYAT]
,CASE ORL.TRCURR WHEN 0 THEN 'TL' WHEN 1 THEN 'USD' WHEN 20 THEN 'EUR' END [ID TUR]
,PRJ.CODE [PROJE KODU]
,SLS.DEFINITION_ [SATIS TEMSILCISI]

FROM LG_003_01_ORFLINE ORL
LEFT JOIN LG_003_01_ORFICHE ORF ON ORF.LOGICALREF = ORL.ORDFICHEREF
LEFT JOIN LG_003_CLCARD CLC ON CLC.LOGICALREF = ORF.CLIENTREF
LEFT JOIN LG_003_ITEMS ITM ON ITM.LOGICALREF = ORL.STOCKREF
LEFT JOIN LG_003_PAYPLANS PYP ON PYP.LOGICALREF = ORF.PAYDEFREF
LEFT JOIN L_CAPIWHOUSE CPW ON CPW.NR = ORL.SOURCEINDEX AND CPW.FIRMNR = 003
LEFT JOIN LG_003_UNITSETL UNL ON UNL.LOGICALREF = ORL.UOMREF
LEFT JOIN LG_003_PROJECT PRJ ON PRJ.LOGICALREF = ORL.PROJECTREF
LEFT JOIN LG_SLSMAN SLS ON SLS.LOGICALREF = ORL.SALESMANREF
WHERE ORL.CANCELLED = 0 AND ORL.LINETYPE = 0 AND ORL.AMOUNT - ORL.SHIPPEDAMOUNT > 0--AND ORF.LOGICALREF = 1511





--SELECT LINENET,* FROM LG_003_01_ORFLINE WHERE ORDFICHEREF = 1511

--SELECT * FROM LG_003_01_ORFICHE WHERE FICHENO='580003781'




GO

/****** Object:  View [dbo].[GNC_003_01_AYRINTILI_BORCTAKIP]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE VIEW [dbo].[GNC_003_01_AYRINTILI_BORCTAKIP] AS

SELECT 
SUBSTRING(CLC.CODE,1,6) [Grup],
CLC.CODE [Cari Kodu],
CLC.SPECODE [OZELKOD],
CLC.DEFINITION_ [Cari Adı],

CariBakiyeTL = (SELECT SUM(CLT.DEBIT-CLT.CREDIT)FROM LG_003_01_CLTOTFIL CLT WHERE CLT.CARDREF=CLC.LOGICALREF AND CLT.TOTTYP=1), 

CASE   WHEN ABS(ROUND((SELECT SUM(CLT.DEBIT-CLT.CREDIT)FROM LG_003_01_CLTOTFIL CLT WHERE CLT.CARDREF=CLC.LOGICALREF AND CLT.TOTTYP=1),2) ) >1 THEN 'Bakiye Verenler'
             ELSE 'Bakiye Vermeyenler' END [Bakiye Bilgisi], 

CASE WHEN GETDATE() < PYT.DATE_ THEN 'Vadesi Gelmeyen' ELSE 'Vadesi Geçen' END [Vade Bilgisi],

PYT.DATE_ [Vade Tarihi],

CASE WHEN DATEPART(DD,PYT.DATE_)<16 THEN CONVERT(VARCHAR(7), PYT.DATE_, 120)+'-1' ELSE CONVERT(VARCHAR(7), PYT.DATE_, 120)+'-2' END [YYYY-MM-H],

PYT.PROCDATE [İşlem Tarihi],
CASE PYT.TRCURR WHEN 0 THEN 'TL' WHEN 1 THEN 'USD' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' ELSE 'Tanımsız' END [Döviz],
(PYT.TOTAL-PYT.PAID)*((PYT.SIGN*-2)+1) [Tutar] ,
CASE WHEN TRRATE>1 THEN (PYT.TOTAL-PYT.PAID)*((PYT.SIGN*-2)+1)*TRRATE ELSE (PYT.TOTAL-PYT.PAID)*((PYT.SIGN*-2)+1) END [Tutar_TL],
CASE PYT.SIGN WHEN 0 THEN 'Borç' ELSE 'Alacak' END Hareket,
CASE 
WHEN MODULENR=5 AND TRCODE=14 THEN 'Açılış'
WHEN MODULENR=5 AND TRCODE=3 THEN 'Borç Dekontu'
WHEN MODULENR=5 AND TRCODE=4 THEN 'Alacak Dekontu'
WHEN MODULENR=5 AND TRCODE=5 THEN 'Virman'

WHEN MODULENR=4 AND TRCODE=8 THEN 'Toptan Satış'
WHEN MODULENR=4 AND TRCODE=1 THEN 'Mal Alım'
WHEN MODULENR=4 AND TRCODE=4 THEN 'Alınan Hizmet'
WHEN MODULENR=4 AND TRCODE=9 THEN 'Verilen Hizmet'
WHEN MODULENR=4 AND TRCODE=3 THEN 'Satış İade'
WHEN MODULENR=4 AND TRCODE=6 THEN 'Alım İade'

WHEN MODULENR=7 AND TRCODE=3 THEN 'Gelen Havale'
WHEN MODULENR=7 AND TRCODE=4 THEN 'Gönderilen Havale'

WHEN MODULENR=6 AND TRCODE=1 THEN 'Çek Girişi'
WHEN MODULENR=6 AND TRCODE=2 THEN 'Senet Girişi'
WHEN MODULENR=6 AND TRCODE=3 THEN 'Çek Çıkışı'
WHEN MODULENR=6 AND TRCODE=4 THEN 'Senet Çıkışı'

WHEN MODULENR=10 AND TRCODE=1 THEN 'Nakit Tahsilat'
WHEN MODULENR=10 AND TRCODE=2 THEN 'Nakit Ödeme'

WHEN MODULENR=3 AND TRCODE=1 THEN 'Satış Siparişi'

WHEN MODULENR=61 AND TRCODE=3 THEN 'Borç Dekontu'

ELSE 'Tanımsız' END [İşlem Türü],

CASE   WHEN MODULENR=4 THEN
(SELECT FICHENO+'-'+DOCODE FROM LG_003_01_INVOICE INV WHERE INV.LOGICALREF=PYT.FICHEREF)
             WHEN MODULENR=5 THEN
(SELECT CLF.TRANNO FROM LG_003_01_CLFLINE CLF WHERE CLF.LOGICALREF=PYT.FICHEREF)
             WHEN MODULENR=10 THEN
(SELECT KSL.FICHENO FROM LG_003_01_KSLINES KSL WHERE KSL.LOGICALREF=PYT.FICHEREF)
             WHEN MODULENR=7 THEN
(SELECT BNF.TRANNO FROM LG_003_01_BNFLINE BNF WHERE BNF.LOGICALREF=PYT.FICHEREF)
             WHEN MODULENR=6 THEN
(SELECT CSR.ROLLNO FROM LG_003_01_CSROLL CSR WHERE CSR.LOGICALREF=PYT.FICHEREF)

ELSE 'Tanımsız' END [İşlem No],

CASE   WHEN MODULENR=4 THEN
(SELECT GENEXP1+'-'+GENEXP2 FROM LG_003_01_INVOICE INV WHERE INV.LOGICALREF=PYT.FICHEREF)
             WHEN MODULENR=5 THEN
(SELECT CLF.LINEEXP FROM LG_003_01_CLFLINE CLF WHERE CLF.LOGICALREF=PYT.FICHEREF)
             WHEN MODULENR=10 THEN
(SELECT KSL.LINEEXP FROM LG_003_01_KSLINES KSL WHERE KSL.LOGICALREF=PYT.FICHEREF)
             WHEN MODULENR=7 THEN
(SELECT BNF.LINEEXP FROM LG_003_01_BNFLINE BNF WHERE BNF.LOGICALREF=PYT.FICHEREF)
             
ELSE '' END [Açıklama]

FROM LG_003_01_PAYTRANS PYT LEFT JOIN LG_003_CLCARD CLC ON PYT.CARDREF=CLC.LOGICALREF
--where clc.code='120.34.0762'

--WHERE PYT.CANCELLED=0 AND (PYT.TOTAL-PYT.PAID)>0 AND PYT.PAIDINCASH=0 AND ( SUBSTRING(CLC.CODE,1,3) IN ('120*') )

GO

/****** Object:  View [dbo].[GNC_003_01_BANKA_MUHASEBE_BAKIYE]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO












--yenı 890

CREATE VIEW [dbo].[GNC_003_01_BANKA_MUHASEBE_BAKIYE]
AS
SELECT
BNC.DEFINITION_ [BANKA],
---BNA.LOGICALREF [BANKA HESAP REFERANSI],
BNA.CODE [HESAP KODU],
BNA.DEFINITION_ [HESAP ADI],
BNA.ACCOUNTNO [HESAP NO],
BNA.IBAN [IBAN],
BNA.CYPHCODE [GRUP KODU],
EMUH.CODE [MUHASEBE KODU],
---EMUH.LOGICALREF,
------------EMUH.DEFINITION_ [MUHASEBE HESAP ADI],
CASE BNA.CURRENCY WHEN 0 THEN 'TL' WHEN 160 THEN 'TL' WHEN 53 THEN 'TL'WHEN 1 THEN 'USD' WHEN 11 THEN 'CHF' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 31 THEN 'IRR' 
WHEN 161 THEN 'RON'ELSE 'YOK' END AS 'DÖVİZ TÜRÜ',
---SUM(ROUND(BNF.DEBIT,2)-ROUND(BNF.CREDIT,2)) [BAKIYE],
---- [BAKIYE] = (SELECT SUM(CASE WHEN MODULENR = 7 THEN (CASE SIGN WHEN 0 THEN TRNET WHEN 1 THEN TRNET * -1 END) ELSE TRNET END ) FROM LG_003_01_BNFLINE WHERE BNACCREF = BNA.LOGICALREF AND MODULENR IN (0,7,61,10)),

-----------------------------------------------------------------------------
--BAKIYE_ESKI=(SELECT SUM (DEBIT-CREDIT)  FROM LG_003_01_BNTOTFIL WHERE CARDREF=BNA.LOGICALREF AND TOTTYP IN (1)),

BAKIYE=ISNULL((SELECT SUM (TUTAR)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
BAKIYE_DOVIZ=ISNULL((SELECT SUM (TUTAR_DOVIZ)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
GUNCEL_BAKIYE_TL=ISNULL((SELECT SUM (GTutar_TL)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
--------------CASE 
--------------WHEN BNA.CURRENCY IN (0,160,53) THEN (SELECT SUM(DEBIT)-SUM(CREDIT) FROM LV_003_01_EMUHTOT WHERE ACCOUNTREF=EMUH.LOGICALREF AND TOTTYPE=1  AND ACCOUNTREF=CRD.ACCOUNTREF AND CURRTYP=0)
--------------WHEN BNA.CURRENCY IN (1) THEN (SELECT SUM(ROUND(EMUHTOT3.DEBIT,1)-ROUND(EMUHTOT3.CREDIT,1)) FROM LV_003_01_EMUHTOT EMUHTOT3 WHERE EMUHTOT3.ACCOUNTREF=EMUH.LOGICALREF AND EMUHTOT3.TOTTYPE=8 AND EMUHTOT3.ACCOUNTREF=CRD.ACCOUNTREF AND EMUHTOT3.CURRTYP=1)
--------------WHEN BNA.CURRENCY IN (20) THEN (SELECT SUM(EMUHTOT1.DEBIT)-SUM(EMUHTOT1.CREDIT) FROM LV_003_01_EMUHTOT EMUHTOT1 WHERE EMUHTOT1.ACCOUNTREF=EMUH.LOGICALREF AND EMUHTOT1.TOTTYPE=8 AND EMUHTOT1.ACCOUNTREF=CRD.ACCOUNTREF AND EMUHTOT1.CURRTYP=20)
--------------WHEN BNA.CURRENCY IN (31) THEN (SELECT SUM(EMUHTOT4.DEBIT)-SUM(EMUHTOT4.CREDIT) FROM LV_003_01_EMUHTOT EMUHTOT4 WHERE EMUHTOT4.ACCOUNTREF=EMUH.LOGICALREF AND EMUHTOT4.TOTTYPE=8 AND EMUHTOT4.ACCOUNTREF=CRD.ACCOUNTREF AND EMUHTOT4.CURRTYP=31)
--------------WHEN BNA.CURRENCY IN (17) THEN (SELECT SUM(EMUHTOT5.DEBIT)-SUM(EMUHTOT5.CREDIT) FROM LV_003_01_EMUHTOT EMUHTOT5 WHERE EMUHTOT5.ACCOUNTREF=EMUH.LOGICALREF AND EMUHTOT5.TOTTYPE=8 AND EMUHTOT5.ACCOUNTREF=CRD.ACCOUNTREF AND EMUHTOT5.CURRTYP=17)
--------------ELSE 'TANIMSIZ'
--------------END [MUHASEBE BAKİYE],
-------------------ASAGISI DOGRU----------------
--(SELECT SUM(DEBIT)-SUM(CREDIT) FROM LV_003_01_EMUHTOT WHERE ACCOUNTREF=EMUH.LOGICALREF AND TOTTYPE=1  AND ACCOUNTREF=CRD.ACCOUNTREF AND CURRTYP=0)[MUHASEBE BAKIYE TL TOPLAM],
--(SELECT SUM(EMUHTOT1.DEBIT)-SUM(EMUHTOT1.CREDIT) FROM LV_003_01_EMUHTOT EMUHTOT1 WHERE EMUHTOT1.ACCOUNTREF=EMUH.LOGICALREF AND EMUHTOT1.TOTTYPE=8 AND EMUHTOT1.ACCOUNTREF=CRD.ACCOUNTREF AND EMUHTOT1.CURRTYP=20) [MUHASEBE BAKIYE EURO TOPLAM],
--(SELECT SUM(ROUND(EMUHTOT3.DEBIT,1)-ROUND(EMUHTOT3.CREDIT,1)) FROM LV_003_01_EMUHTOT EMUHTOT3 WHERE EMUHTOT3.ACCOUNTREF=EMUH.LOGICALREF AND EMUHTOT3.TOTTYPE=8 AND EMUHTOT3.ACCOUNTREF=CRD.ACCOUNTREF AND EMUHTOT3.CURRTYP=1)  [MUHASEBE BAKIYE USD TOPLAM],
------ASIL OLAN---
BAKIYE_MUHASEBE=ISNULL((SELECT SUM (TUTAR)  FROM GNC_003_BANKACC_MUH WHERE [LOG]=EMUH.LOGICALREF ),0),
BAKIYE_DOVIZ_MUHASEBE=ISNULL((SELECT SUM (TUTAR_DOVIZ)  FROM GNC_003_BANKACC_MUH WHERE [LOG]=EMUH.LOGICALREF ),0),
---GUNCEL_BAKIYE_TL_ESKI_YANLIS=(SELECT SUM (GTutar_TL)  FROM GNC_003_BANKACC_MUH WHERE [LOG]=EMUH.LOGICALREF ),
GUNCEL_BAKIYE_TL_MUHASEBE=ISNULL((SELECT CASE BNA.CURRENCY WHEN 0 THEN (SELECT SUM (GTutar_TL_TL)  FROM GNC_003_BANKACC_MUH WHERE [LOG]=EMUH.LOGICALREF )
ELSE (SELECT SUM (GTutar_TL)  FROM GNC_003_BANKACC_MUH WHERE [LOG]=EMUH.LOGICALREF )END ),0),
-----///////////////////////
YENI_GUNCEL_BAKIYE_TL_MUHASEBE= ISNULL((SELECT CASE BNA.CURRENCY WHEN 0 THEN (SELECT SUM (GTutar_TL_TL)  FROM GNC_003_BANKACC_MUH WHERE [LOG]=EMUH.LOGICALREF )
ELSE (SELECT SUM (GTutar_TL)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF )END ),0)


-----(SELECT SUM(EMUHTOT4.DEBIT)-SUM(EMUHTOT4.CREDIT) FROM LV_003_01_EMUHTOT EMUHTOT4 WHERE EMUHTOT4.ACCOUNTREF=EMUH.LOGICALREF AND EMUHTOT4.TOTTYPE=8 AND EMUHTOT4.ACCOUNTREF=CRD.ACCOUNTREF AND EMUHTOT4.CURRTYP=31) [MUHASEBE BAKIYE IRR TOPLAM],
-----(SELECT SUM(EMUHTOT5.DEBIT)-SUM(EMUHTOT5.CREDIT) FROM LV_003_01_EMUHTOT EMUHTOT5 WHERE EMUHTOT5.ACCOUNTREF=EMUH.LOGICALREF AND EMUHTOT5.TOTTYPE=8 AND EMUHTOT5.ACCOUNTREF=CRD.ACCOUNTREF AND EMUHTOT5.CURRTYP=17) [MUHASEBE BAKIYE GBPTOPLAM]                                                                                           
FROM LG_003_BANKACC BNA
LEFT JOIN LG_003_BNCARD BNC ON BNC.LOGICALREF = BNA.BANKREF 
LEFT JOIN LG_003_01_GNTOTBN BNF ON BNF.CARDREF = BNA.LOGICALREF
LEFT JOIN LG_003_CRDACREF CRD ON CRD.CARDREF=BNA.LOGICALREF AND CRD.TRCODE IN (6,18,7) AND CRD.TYP IN(1)
LEFT JOIN LG_003_EMUHACC EMUH ON EMUH.LOGICALREF=CRD.ACCOUNTREF
--LEFT JOIN  LG_003_EMUHACC EMUH3 ON EMUH3.LOGICALREF=CRD.ACCOUNTREF
where  BNC.ACTIVE=0 AND BNA.ACTIVE=0 ---AND BNA.CODE='102.02.0002'----AND BNF.CARDREF = 349 --AND BNA.CODE='03    03'--and BNC.DEFINITION_ = 'CITIBANK A.Ş.' 
GROUP BY BNC.DEFINITION_ , BNA.DEFINITION_ , BNA.CODE,BNA.ACCOUNTNO,BNC.BRANCH,BNA.IBAN,
BNA.CURRENCY,EMUH.CODE,EMUH.DEFINITION_,EMUH.LOGICALREF,CRD.ACCOUNTREF,BNA.LOGICALREF,BNA.CYPHCODE---,EMUHTOT.DEBIT---,EMUHTOT.CREDIT
GO

/****** Object:  View [dbo].[GNC_003_01_BANKA_MUHASEBE_BAKIYE_DES]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
















CREATE VIEW [dbo].[GNC_003_01_BANKA_MUHASEBE_BAKIYE_DES]
AS

SELECT
'TL'[TİPİ],
BNC.DEFINITION_ [BANKA],
BAKIYE=ISNULL((SELECT SUM (TUTAR)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
CASE BNA.CURRENCY WHEN 0 THEN 'TL' WHEN 160 THEN 'TL' WHEN 53 THEN 'TL'WHEN 1 THEN 'USD' WHEN 11 THEN 'CHF' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 31 THEN 'IRR' 
WHEN 161 THEN 'RON'ELSE 'YOK' END AS 'DÖVİZ TÜRÜ',
BNA.CYPHCODE [GRUP KODU],
BNA.SPECODE [OZEL KODU]


FROM LG_003_BANKACC BNA
LEFT JOIN LG_003_BNCARD BNC ON BNC.LOGICALREF = BNA.BANKREF 
LEFT JOIN LG_003_01_GNTOTBN BNF ON BNF.CARDREF = BNA.LOGICALREF
LEFT JOIN LG_003_CRDACREF CRD ON CRD.CARDREF=BNA.LOGICALREF AND CRD.TRCODE IN (6,18,7) AND CRD.TYP IN(1)
LEFT JOIN LG_003_EMUHACC EMUH ON EMUH.LOGICALREF=CRD.ACCOUNTREF
--LEFT JOIN  LG_003_EMUHACC EMUH3 ON EMUH3.LOGICALREF=CRD.ACCOUNTREF
where  BNC.ACTIVE=0 AND BNA.ACTIVE=0 --AND BNA.CODE='102.04.0001'----AND BNF.CARDREF = 349 --AND BNA.CODE='03    03'--and BNC.DEFINITION_ = 'CITIBANK A.Ş.' 
AND BNA.CODE NOT IN ('101.01.0001','101.01.0002','101.01.0004','101.01.0005','101.02.0001','101.02.0002','103.04.0004','TEST  .001','102.05.0001','102.01007')
AND BNA.CURRENCY IN (0,160,53) AND BNA.SPECODE NOT IN ('KREDİ','ARAC KREDİ','34 DES 38','34 DES 08')AND BNA.CYPHCODE NOT  IN('KH')
GROUP BY BNC.DEFINITION_ , BNA.DEFINITION_ , BNA.CODE,BNA.ACCOUNTNO,BNC.BRANCH,BNA.IBAN,
BNA.CURRENCY,EMUH.CODE,EMUH.DEFINITION_,EMUH.LOGICALREF,CRD.ACCOUNTREF,BNA.LOGICALREF,BNA.CYPHCODE,BNA.SPECODE--,EMUHTOT.DEBIT---,EMUHTOT.CREDIT



UNION ALL
---///////////////////////////////////
--SELECT
--'TL1'[TİPİ],
--BNC.DEFINITION_ [BANKA],
--BAKIYE=ISNULL((SELECT SUM (TUTAR)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
--CASE BNA.CURRENCY WHEN 0 THEN 'TL' WHEN 160 THEN 'TL' WHEN 53 THEN 'TL'WHEN 1 THEN 'USD' WHEN 11 THEN 'CHF' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 31 THEN 'IRR' 
--WHEN 161 THEN 'RON'ELSE 'YOK' END AS 'DÖVİZ TÜRÜ',
--BNA.CYPHCODE [GRUP KODU],
--BNA.SPECODE [OZEL KODU]

--FROM LG_003_BANKACC BNA
--LEFT JOIN LG_003_BNCARD BNC ON BNC.LOGICALREF = BNA.BANKREF 
--LEFT JOIN LG_003_01_GNTOTBN BNF ON BNF.CARDREF = BNA.LOGICALREF
--LEFT JOIN LG_003_CRDACREF CRD ON CRD.CARDREF=BNA.LOGICALREF AND CRD.TRCODE IN (6,18,7) AND CRD.TYP IN(1)
--LEFT JOIN LG_003_EMUHACC EMUH ON EMUH.LOGICALREF=CRD.ACCOUNTREF
----LEFT JOIN  LG_003_EMUHACC EMUH3 ON EMUH3.LOGICALREF=CRD.ACCOUNTREF
--where  BNC.ACTIVE=0 AND BNA.ACTIVE=0 --AND BNA.CODE='102.04.0001'----AND BNF.CARDREF = 349 --AND BNA.CODE='03    03'--and BNC.DEFINITION_ = 'CITIBANK A.Ş.' 
--AND BNA.CODE NOT IN ('101.01.0001','101.01.0002','101.01.0004','101.01.0005','101.02.0001','101.02.0002','103.04.0004','TEST  .001')
--AND BNA.CURRENCY IN (1)
--GROUP BY BNC.DEFINITION_ , BNA.DEFINITION_ , BNA.CODE,BNA.ACCOUNTNO,BNC.BRANCH,BNA.IBAN,
--BNA.CURRENCY,EMUH.CODE,EMUH.DEFINITION_,EMUH.LOGICALREF,CRD.ACCOUNTREF,BNA.LOGICALREF,BNA.CYPHCODE,BNA.SPECODE---,EMUHTOT.DEBIT---,EMUHTOT.CREDIT
---////////////////////////////////////////////
--UNION ALL

--SELECT
--'TL'[TİPİ],
--BNC.DEFINITION_ [BANKA],
--BAKIYE=ISNULL((SELECT SUM (TUTAR)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
--CASE BNA.CURRENCY WHEN 0 THEN 'TL' WHEN 160 THEN 'TL' WHEN 53 THEN 'TL'WHEN 1 THEN 'USD' WHEN 11 THEN 'CHF' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 31 THEN 'IRR' 
--WHEN 161 THEN 'RON'ELSE 'YOK' END AS 'DÖVİZ TÜRÜ',
--BNA.CYPHCODE [GRUP KODU],
--BNA.SPECODE [OZEL KODU]


--FROM LG_003_BANKACC BNA
--LEFT JOIN LG_003_BNCARD BNC ON BNC.LOGICALREF = BNA.BANKREF 
--LEFT JOIN LG_003_01_GNTOTBN BNF ON BNF.CARDREF = BNA.LOGICALREF
--LEFT JOIN LG_003_CRDACREF CRD ON CRD.CARDREF=BNA.LOGICALREF AND CRD.TRCODE IN (6,18,7) AND CRD.TYP IN(1)
--LEFT JOIN LG_003_EMUHACC EMUH ON EMUH.LOGICALREF=CRD.ACCOUNTREF
----LEFT JOIN  LG_003_EMUHACC EMUH3 ON EMUH3.LOGICALREF=CRD.ACCOUNTREF
--where  BNC.ACTIVE=0 AND BNA.ACTIVE=0 --AND BNA.CODE='102.04.0001'----AND BNF.CARDREF = 349 --AND BNA.CODE='03    03'--and BNC.DEFINITION_ = 'CITIBANK A.Ş.' 
--AND BNA.CODE NOT IN ('101.01.0001','101.01.0002','101.01.0004','101.01.0005','101.02.0001','101.02.0002','103.04.0004','TEST  .001')
--AND BNA.CURRENCY IN (20)
--GROUP BY BNC.DEFINITION_ , BNA.DEFINITION_ , BNA.CODE,BNA.ACCOUNTNO,BNC.BRANCH,BNA.IBAN,
--BNA.CURRENCY,EMUH.CODE,EMUH.DEFINITION_,EMUH.LOGICALREF,CRD.ACCOUNTREF,BNA.LOGICALREF,BNA.CYPHCODE,BNA.SPECODE---,EMUHTOT.DEBIT---,EMUHTOT.CREDIT





--UNION ALL

--SELECT
--'DOVIZLI TUTAR'[TİPİ],
--BNC.DEFINITION_ [BANKA],
--BAKIYE_DOVIZ=ISNULL((SELECT SUM (TUTAR_DOVIZ)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
--CASE BNA.CURRENCY WHEN 0 THEN 'TL' WHEN 160 THEN 'TL' WHEN 53 THEN 'TL'WHEN 1 THEN 'USD' WHEN 11 THEN 'CHF' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 31 THEN 'IRR' 
--WHEN 161 THEN 'RON'ELSE 'YOK' END AS 'DÖVİZ TÜRÜ',
--BNA.CYPHCODE [GRUP KODU],
---BNA.SPECODE [OZEL KODU]


--FROM LG_003_BANKACC BNA
--LEFT JOIN LG_003_BNCARD BNC ON BNC.LOGICALREF = BNA.BANKREF 
--LEFT JOIN LG_003_01_GNTOTBN BNF ON BNF.CARDREF = BNA.LOGICALREF
--LEFT JOIN LG_003_CRDACREF CRD ON CRD.CARDREF=BNA.LOGICALREF AND CRD.TRCODE IN (6,18,7) AND CRD.TYP IN(1)
--LEFT JOIN LG_003_EMUHACC EMUH ON EMUH.LOGICALREF=CRD.ACCOUNTREF
----LEFT JOIN  LG_003_EMUHACC EMUH3 ON EMUH3.LOGICALREF=CRD.ACCOUNTREF
--where  BNC.ACTIVE=0 AND BNA.ACTIVE=0 --AND BNA.CODE='102.04.0001'----AND BNF.CARDREF = 349 --AND BNA.CODE='03    03'--and BNC.DEFINITION_ = 'CITIBANK A.Ş.' 
--AND BNA.CODE NOT IN ('101.01.0001','101.01.0002','101.01.0004','101.01.0005','101.02.0001','101.02.0002','103.04.0004','TEST  .001')
--AND BNA.CURRENCY IN (0,160,53)
--GROUP BY BNC.DEFINITION_ , BNA.DEFINITION_ , BNA.CODE,BNA.ACCOUNTNO,BNC.BRANCH,BNA.IBAN,
--BNA.CURRENCY,EMUH.CODE,EMUH.DEFINITION_,EMUH.LOGICALREF,CRD.ACCOUNTREF,BNA.LOGICALREF,BNA.CYPHCODE,BNA.SPECODE---,EMUHTOT.DEBIT---,EMUHTOT.CREDIT



---UNION ALL

SELECT
'USD'[TİPİ],
BNC.DEFINITION_ [BANKA],
BAKIYE_DOVIZ=ISNULL((SELECT SUM (TUTAR_DOVIZ)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
CASE BNA.CURRENCY WHEN 0 THEN 'TL' WHEN 160 THEN 'TL' WHEN 53 THEN 'TL'WHEN 1 THEN 'USD' WHEN 11 THEN 'CHF' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 31 THEN 'IRR' 
WHEN 161 THEN 'RON'ELSE 'YOK' END AS 'DÖVİZ TÜRÜ',
BNA.CYPHCODE [GRUP KODU],
BNA.SPECODE [OZEL KODU]


FROM LG_003_BANKACC BNA
LEFT JOIN LG_003_BNCARD BNC ON BNC.LOGICALREF = BNA.BANKREF 
LEFT JOIN LG_003_01_GNTOTBN BNF ON BNF.CARDREF = BNA.LOGICALREF
LEFT JOIN LG_003_CRDACREF CRD ON CRD.CARDREF=BNA.LOGICALREF AND CRD.TRCODE IN (6,18,7) AND CRD.TYP IN(1)
LEFT JOIN LG_003_EMUHACC EMUH ON EMUH.LOGICALREF=CRD.ACCOUNTREF
--LEFT JOIN  LG_003_EMUHACC EMUH3 ON EMUH3.LOGICALREF=CRD.ACCOUNTREF
where  BNC.ACTIVE=0 AND BNA.ACTIVE=0 --AND BNA.CODE='102.04.0001'----AND BNF.CARDREF = 349 --AND BNA.CODE='03    03'--and BNC.DEFINITION_ = 'CITIBANK A.Ş.' 
AND BNA.CODE NOT IN ('101.01.0001','101.01.0002','101.01.0004','101.01.0005','101.02.0001','101.02.0002','103.04.0004','TEST  .001','102.05.0001','102.01007')
AND BNA.CURRENCY IN (1) AND BNA.SPECODE NOT IN ('KREDİ','ARAC KREDİ')AND  BNA.CYPHCODE NOT  IN('KH')
GROUP BY BNC.DEFINITION_ , BNA.DEFINITION_ , BNA.CODE,BNA.ACCOUNTNO,BNC.BRANCH,BNA.IBAN,
BNA.CURRENCY,EMUH.CODE,EMUH.DEFINITION_,EMUH.LOGICALREF,CRD.ACCOUNTREF,BNA.LOGICALREF,BNA.CYPHCODE,BNA.SPECODE---,EMUHTOT.DEBIT---,EMUHTOT.CREDIT

UNION ALL

SELECT
'EURO'[TİPİ],
BNC.DEFINITION_ [BANKA],
BAKIYE_DOVIZ=ISNULL((SELECT SUM (TUTAR_DOVIZ)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
CASE BNA.CURRENCY WHEN 0 THEN 'TL' WHEN 160 THEN 'TL' WHEN 53 THEN 'TL'WHEN 1 THEN 'USD' WHEN 11 THEN 'CHF' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 31 THEN 'IRR' 
WHEN 161 THEN 'RON'ELSE 'YOK' END AS 'DÖVİZ TÜRÜ',
BNA.CYPHCODE [GRUP KODU],
BNA.SPECODE [OZEL KODU]


FROM LG_003_BANKACC BNA
LEFT JOIN LG_003_BNCARD BNC ON BNC.LOGICALREF = BNA.BANKREF 
LEFT JOIN LG_003_01_GNTOTBN BNF ON BNF.CARDREF = BNA.LOGICALREF
LEFT JOIN LG_003_CRDACREF CRD ON CRD.CARDREF=BNA.LOGICALREF AND CRD.TRCODE IN (6,18,7) AND CRD.TYP IN(1)
LEFT JOIN LG_003_EMUHACC EMUH ON EMUH.LOGICALREF=CRD.ACCOUNTREF
--LEFT JOIN  LG_003_EMUHACC EMUH3 ON EMUH3.LOGICALREF=CRD.ACCOUNTREF
where  BNC.ACTIVE=0 AND BNA.ACTIVE=0 --AND BNA.CODE='102.04.0001'----AND BNF.CARDREF = 349 --AND BNA.CODE='03    03'--and BNC.DEFINITION_ = 'CITIBANK A.Ş.' 
AND BNA.CODE NOT IN ('101.01.0001','101.01.0002','101.01.0004','101.01.0005','101.02.0001','101.02.0002','103.04.0004','TEST  .001','102.05.0001','102.01007')
AND BNA.CURRENCY IN (20)AND BNA.SPECODE NOT IN ('KREDİ','ARAC KREDİ')AND BNA.CYPHCODE NOT  IN('KH')
GROUP BY BNC.DEFINITION_ , BNA.DEFINITION_ , BNA.CODE,BNA.ACCOUNTNO,BNC.BRANCH,BNA.IBAN,
BNA.CURRENCY,EMUH.CODE,EMUH.DEFINITION_,EMUH.LOGICALREF,CRD.ACCOUNTREF,BNA.LOGICALREF,BNA.CYPHCODE,BNA.SPECODE---,EMUHTOT.DEBIT---,EMUHTOT.CREDIT






UNION ALL

SELECT
'GUNCEL TL BAKIYE'[TİPİ],
BNC.DEFINITION_ [BANKA],
GUNCEL_BAKIYE_TL=ISNULL((SELECT SUM (GTutar_TL)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
CASE BNA.CURRENCY WHEN 0 THEN 'TL' WHEN 160 THEN 'TL' WHEN 53 THEN 'TL'WHEN 1 THEN 'USD' WHEN 11 THEN 'CHF' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 31 THEN 'IRR' 
WHEN 161 THEN 'RON'ELSE 'YOK' END AS 'DÖVİZ TÜRÜ',
BNA.CYPHCODE [GRUP KODU],
BNA.SPECODE [OZEL KODU]


FROM LG_003_BANKACC BNA
LEFT JOIN LG_003_BNCARD BNC ON BNC.LOGICALREF = BNA.BANKREF 
LEFT JOIN LG_003_01_GNTOTBN BNF ON BNF.CARDREF = BNA.LOGICALREF
LEFT JOIN LG_003_CRDACREF CRD ON CRD.CARDREF=BNA.LOGICALREF AND CRD.TRCODE IN (6,18,7) AND CRD.TYP IN(1)
LEFT JOIN LG_003_EMUHACC EMUH ON EMUH.LOGICALREF=CRD.ACCOUNTREF
--LEFT JOIN  LG_003_EMUHACC EMUH3 ON EMUH3.LOGICALREF=CRD.ACCOUNTREF
where  BNC.ACTIVE=0 AND BNA.ACTIVE=0 --AND BNA.CODE='102.04.0001'----AND BNF.CARDREF = 349 --AND BNA.CODE='03    03'--and BNC.DEFINITION_ = 'CITIBANK A.Ş.' 
AND BNA.CODE NOT IN ('101.01.0001','101.01.0002','101.01.0004','101.01.0005','101.02.0001','101.02.0002','103.04.0004','TEST  .001','102.05.0001','102.01007')
AND BNA.CURRENCY IN (0,160,53)AND BNA.SPECODE NOT IN ('KREDİ','ARAC KREDİ')AND BNA.CYPHCODE NOT  IN('KH')
GROUP BY BNC.DEFINITION_ , BNA.DEFINITION_ , BNA.CODE,BNA.ACCOUNTNO,BNC.BRANCH,BNA.IBAN,
BNA.CURRENCY,EMUH.CODE,EMUH.DEFINITION_,EMUH.LOGICALREF,CRD.ACCOUNTREF,BNA.LOGICALREF,BNA.CYPHCODE,BNA.SPECODE---,EMUHTOT.DEBIT---,EMUHTOT.CREDIT



UNION ALL

SELECT
'GUNCEL TL BAKIYE'[TİPİ],
BNC.DEFINITION_ [BANKA],
GUNCEL_BAKIYE_TL=ISNULL((SELECT SUM (GTutar_TL)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
CASE BNA.CURRENCY WHEN 0 THEN 'TL' WHEN 160 THEN 'TL' WHEN 53 THEN 'TL'WHEN 1 THEN 'USD' WHEN 11 THEN 'CHF' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 31 THEN 'IRR' 
WHEN 161 THEN 'RON'ELSE 'YOK' END AS 'DÖVİZ TÜRÜ',
BNA.CYPHCODE [GRUP KODU],
BNA.SPECODE [OZEL KODU]


FROM LG_003_BANKACC BNA
LEFT JOIN LG_003_BNCARD BNC ON BNC.LOGICALREF = BNA.BANKREF 
LEFT JOIN LG_003_01_GNTOTBN BNF ON BNF.CARDREF = BNA.LOGICALREF
LEFT JOIN LG_003_CRDACREF CRD ON CRD.CARDREF=BNA.LOGICALREF AND CRD.TRCODE IN (6,18,7) AND CRD.TYP IN(1)
LEFT JOIN LG_003_EMUHACC EMUH ON EMUH.LOGICALREF=CRD.ACCOUNTREF
--LEFT JOIN  LG_003_EMUHACC EMUH3 ON EMUH3.LOGICALREF=CRD.ACCOUNTREF
where  BNC.ACTIVE=0 AND BNA.ACTIVE=0 --AND BNA.CODE='102.04.0001'----AND BNF.CARDREF = 349 --AND BNA.CODE='03    03'--and BNC.DEFINITION_ = 'CITIBANK A.Ş.' 
AND BNA.CODE NOT IN ('101.01.0001','101.01.0002','101.01.0004','101.01.0005','101.02.0001','101.02.0002','103.04.0004','TEST  .001','102.05.0001','102.01007')
AND BNA.CURRENCY IN (1)AND BNA.SPECODE NOT IN ('KREDİ','ARAC KREDİ')AND BNA.CYPHCODE NOT  IN('KH')
GROUP BY BNC.DEFINITION_ , BNA.DEFINITION_ , BNA.CODE,BNA.ACCOUNTNO,BNC.BRANCH,BNA.IBAN,
BNA.CURRENCY,EMUH.CODE,EMUH.DEFINITION_,EMUH.LOGICALREF,CRD.ACCOUNTREF,BNA.LOGICALREF,BNA.CYPHCODE,BNA.SPECODE---,EMUHTOT.DEBIT---,EMUHTOT.CREDIT

UNION ALL

SELECT
'GUNCEL TL BAKIYE'[TİPİ],
BNC.DEFINITION_ [BANKA],
GUNCEL_BAKIYE_TL=ISNULL((SELECT SUM (GTutar_TL)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
CASE BNA.CURRENCY WHEN 0 THEN 'TL' WHEN 160 THEN 'TL' WHEN 53 THEN 'TL'WHEN 1 THEN 'USD' WHEN 11 THEN 'CHF' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 31 THEN 'IRR' 
WHEN 161 THEN 'RON'ELSE 'YOK' END AS 'DÖVİZ TÜRÜ',
BNA.CYPHCODE [GRUP KODU],
BNA.SPECODE [OZEL KODU]


FROM LG_003_BANKACC BNA
LEFT JOIN LG_003_BNCARD BNC ON BNC.LOGICALREF = BNA.BANKREF 
LEFT JOIN LG_003_01_GNTOTBN BNF ON BNF.CARDREF = BNA.LOGICALREF
LEFT JOIN LG_003_CRDACREF CRD ON CRD.CARDREF=BNA.LOGICALREF AND CRD.TRCODE IN (6,18,7) AND CRD.TYP IN(1)
LEFT JOIN LG_003_EMUHACC EMUH ON EMUH.LOGICALREF=CRD.ACCOUNTREF
--LEFT JOIN  LG_003_EMUHACC EMUH3 ON EMUH3.LOGICALREF=CRD.ACCOUNTREF
where  BNC.ACTIVE=0 AND BNA.ACTIVE=0 --AND BNA.CODE='102.04.0001'----AND BNF.CARDREF = 349 --AND BNA.CODE='03    03'--and BNC.DEFINITION_ = 'CITIBANK A.Ş.' 
AND BNA.CODE NOT IN ('101.01.0001','101.01.0002','101.01.0004','101.01.0005','101.02.0001','101.02.0002','103.04.0004','TEST  .001','102.05.0001','102.01007')
AND BNA.CURRENCY IN (20)AND BNA.SPECODE NOT IN ('KREDİ','ARAC KREDİ')AND BNA.CYPHCODE NOT  IN('KH')
GROUP BY BNC.DEFINITION_ , BNA.DEFINITION_ , BNA.CODE,BNA.ACCOUNTNO,BNC.BRANCH,BNA.IBAN,
BNA.CURRENCY,EMUH.CODE,EMUH.DEFINITION_,EMUH.LOGICALREF,CRD.ACCOUNTREF,BNA.LOGICALREF,BNA.CYPHCODE,BNA.SPECODE---,EMUHTOT.DEBIT---,EMUHTOT.CREDIT
GO

/****** Object:  View [dbo].[GNC_003_01_BANKA_MUHASEBE_BAKIYE_DES_KREDI]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
















CREATE VIEW [dbo].[GNC_003_01_BANKA_MUHASEBE_BAKIYE_DES_KREDI]
AS

SELECT
'TL'[TİPİ],
BNC.DEFINITION_ [BANKA],
TUTARBORC=ISNULL((SELECT SUM (TUTARBORC)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
TUTARALACAK=ISNULL((SELECT SUM (TUTARALACAK)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
BAKIYE=ISNULL((SELECT SUM (TUTAR)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
CASE BNA.CURRENCY WHEN 0 THEN 'TL' WHEN 160 THEN 'TL' WHEN 53 THEN 'TL'WHEN 1 THEN 'USD' WHEN 11 THEN 'CHF' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 31 THEN 'IRR' 
WHEN 161 THEN 'RON'ELSE 'YOK' END AS 'DÖVİZ TÜRÜ',
BNA.CYPHCODE [GRUP KODU],
BNA.SPECODE [OZEL KODU]


FROM LG_003_BANKACC BNA
LEFT JOIN LG_003_BNCARD BNC ON BNC.LOGICALREF = BNA.BANKREF 
LEFT JOIN LG_003_01_GNTOTBN BNF ON BNF.CARDREF = BNA.LOGICALREF
LEFT JOIN LG_003_CRDACREF CRD ON CRD.CARDREF=BNA.LOGICALREF AND CRD.TRCODE IN (6,18,7) AND CRD.TYP IN(1)
LEFT JOIN LG_003_EMUHACC EMUH ON EMUH.LOGICALREF=CRD.ACCOUNTREF
--LEFT JOIN  LG_003_EMUHACC EMUH3 ON EMUH3.LOGICALREF=CRD.ACCOUNTREF
where  BNC.ACTIVE=0 AND BNA.ACTIVE=0 --AND BNA.CODE='102.04.0001'----AND BNF.CARDREF = 349 --AND BNA.CODE='03    03'--and BNC.DEFINITION_ = 'CITIBANK A.Ş.' 
AND BNA.CODE NOT IN ('101.01.0001','101.01.0002','101.01.0004','101.01.0005','101.02.0001','101.02.0002','103.04.0004','TEST  .001')
AND BNA.CURRENCY IN (0,160,53) and BNA.SPECODE IN ('KREDİ','ARAC KREDİ','CEK KRS','KGF','34 DES 38','34 DES 08')
GROUP BY BNC.DEFINITION_ , BNA.DEFINITION_ , BNA.CODE,BNA.ACCOUNTNO,BNC.BRANCH,BNA.IBAN,
BNA.CURRENCY,EMUH.CODE,EMUH.DEFINITION_,EMUH.LOGICALREF,CRD.ACCOUNTREF,BNA.LOGICALREF,BNA.CYPHCODE,BNA.SPECODE--,EMUHTOT.DEBIT---,EMUHTOT.CREDIT



UNION ALL
---///////////////////////////////////
--SELECT
--'TL1'[TİPİ],
--BNC.DEFINITION_ [BANKA],
--BAKIYE=ISNULL((SELECT SUM (TUTAR)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
--CASE BNA.CURRENCY WHEN 0 THEN 'TL' WHEN 160 THEN 'TL' WHEN 53 THEN 'TL'WHEN 1 THEN 'USD' WHEN 11 THEN 'CHF' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 31 THEN 'IRR' 
--WHEN 161 THEN 'RON'ELSE 'YOK' END AS 'DÖVİZ TÜRÜ',
--BNA.CYPHCODE [GRUP KODU],
--BNA.SPECODE [OZEL KODU]

--FROM LG_003_BANKACC BNA
--LEFT JOIN LG_003_BNCARD BNC ON BNC.LOGICALREF = BNA.BANKREF 
--LEFT JOIN LG_003_01_GNTOTBN BNF ON BNF.CARDREF = BNA.LOGICALREF
--LEFT JOIN LG_003_CRDACREF CRD ON CRD.CARDREF=BNA.LOGICALREF AND CRD.TRCODE IN (6,18,7) AND CRD.TYP IN(1)
--LEFT JOIN LG_003_EMUHACC EMUH ON EMUH.LOGICALREF=CRD.ACCOUNTREF
----LEFT JOIN  LG_003_EMUHACC EMUH3 ON EMUH3.LOGICALREF=CRD.ACCOUNTREF
--where  BNC.ACTIVE=0 AND BNA.ACTIVE=0 --AND BNA.CODE='102.04.0001'----AND BNF.CARDREF = 349 --AND BNA.CODE='03    03'--and BNC.DEFINITION_ = 'CITIBANK A.Ş.' 
--AND BNA.CODE NOT IN ('101.01.0001','101.01.0002','101.01.0004','101.01.0005','101.02.0001','101.02.0002','103.04.0004','TEST  .001')
--AND BNA.CURRENCY IN (1)
--GROUP BY BNC.DEFINITION_ , BNA.DEFINITION_ , BNA.CODE,BNA.ACCOUNTNO,BNC.BRANCH,BNA.IBAN,
--BNA.CURRENCY,EMUH.CODE,EMUH.DEFINITION_,EMUH.LOGICALREF,CRD.ACCOUNTREF,BNA.LOGICALREF,BNA.CYPHCODE,BNA.SPECODE---,EMUHTOT.DEBIT---,EMUHTOT.CREDIT
---////////////////////////////////////////////
--UNION ALL

--SELECT
--'TL'[TİPİ],
--BNC.DEFINITION_ [BANKA],
--BAKIYE=ISNULL((SELECT SUM (TUTAR)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
--CASE BNA.CURRENCY WHEN 0 THEN 'TL' WHEN 160 THEN 'TL' WHEN 53 THEN 'TL'WHEN 1 THEN 'USD' WHEN 11 THEN 'CHF' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 31 THEN 'IRR' 
--WHEN 161 THEN 'RON'ELSE 'YOK' END AS 'DÖVİZ TÜRÜ',
--BNA.CYPHCODE [GRUP KODU],
--BNA.SPECODE [OZEL KODU]


--FROM LG_003_BANKACC BNA
--LEFT JOIN LG_003_BNCARD BNC ON BNC.LOGICALREF = BNA.BANKREF 
--LEFT JOIN LG_003_01_GNTOTBN BNF ON BNF.CARDREF = BNA.LOGICALREF
--LEFT JOIN LG_003_CRDACREF CRD ON CRD.CARDREF=BNA.LOGICALREF AND CRD.TRCODE IN (6,18,7) AND CRD.TYP IN(1)
--LEFT JOIN LG_003_EMUHACC EMUH ON EMUH.LOGICALREF=CRD.ACCOUNTREF
----LEFT JOIN  LG_003_EMUHACC EMUH3 ON EMUH3.LOGICALREF=CRD.ACCOUNTREF
--where  BNC.ACTIVE=0 AND BNA.ACTIVE=0 --AND BNA.CODE='102.04.0001'----AND BNF.CARDREF = 349 --AND BNA.CODE='03    03'--and BNC.DEFINITION_ = 'CITIBANK A.Ş.' 
--AND BNA.CODE NOT IN ('101.01.0001','101.01.0002','101.01.0004','101.01.0005','101.02.0001','101.02.0002','103.04.0004','TEST  .001')
--AND BNA.CURRENCY IN (20)
--GROUP BY BNC.DEFINITION_ , BNA.DEFINITION_ , BNA.CODE,BNA.ACCOUNTNO,BNC.BRANCH,BNA.IBAN,
--BNA.CURRENCY,EMUH.CODE,EMUH.DEFINITION_,EMUH.LOGICALREF,CRD.ACCOUNTREF,BNA.LOGICALREF,BNA.CYPHCODE,BNA.SPECODE---,EMUHTOT.DEBIT---,EMUHTOT.CREDIT





--UNION ALL

--SELECT
--'DOVIZLI TUTAR'[TİPİ],
--BNC.DEFINITION_ [BANKA],
--BAKIYE_DOVIZ=ISNULL((SELECT SUM (TUTAR_DOVIZ)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
--CASE BNA.CURRENCY WHEN 0 THEN 'TL' WHEN 160 THEN 'TL' WHEN 53 THEN 'TL'WHEN 1 THEN 'USD' WHEN 11 THEN 'CHF' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 31 THEN 'IRR' 
--WHEN 161 THEN 'RON'ELSE 'YOK' END AS 'DÖVİZ TÜRÜ',
--BNA.CYPHCODE [GRUP KODU],
---BNA.SPECODE [OZEL KODU]


--FROM LG_003_BANKACC BNA
--LEFT JOIN LG_003_BNCARD BNC ON BNC.LOGICALREF = BNA.BANKREF 
--LEFT JOIN LG_003_01_GNTOTBN BNF ON BNF.CARDREF = BNA.LOGICALREF
--LEFT JOIN LG_003_CRDACREF CRD ON CRD.CARDREF=BNA.LOGICALREF AND CRD.TRCODE IN (6,18,7) AND CRD.TYP IN(1)
--LEFT JOIN LG_003_EMUHACC EMUH ON EMUH.LOGICALREF=CRD.ACCOUNTREF
----LEFT JOIN  LG_003_EMUHACC EMUH3 ON EMUH3.LOGICALREF=CRD.ACCOUNTREF
--where  BNC.ACTIVE=0 AND BNA.ACTIVE=0 --AND BNA.CODE='102.04.0001'----AND BNF.CARDREF = 349 --AND BNA.CODE='03    03'--and BNC.DEFINITION_ = 'CITIBANK A.Ş.' 
--AND BNA.CODE NOT IN ('101.01.0001','101.01.0002','101.01.0004','101.01.0005','101.02.0001','101.02.0002','103.04.0004','TEST  .001')
--AND BNA.CURRENCY IN (0,160,53)
--GROUP BY BNC.DEFINITION_ , BNA.DEFINITION_ , BNA.CODE,BNA.ACCOUNTNO,BNC.BRANCH,BNA.IBAN,
--BNA.CURRENCY,EMUH.CODE,EMUH.DEFINITION_,EMUH.LOGICALREF,CRD.ACCOUNTREF,BNA.LOGICALREF,BNA.CYPHCODE,BNA.SPECODE---,EMUHTOT.DEBIT---,EMUHTOT.CREDIT



---UNION ALL

SELECT
'USD'[TİPİ],
BNC.DEFINITION_ [BANKA],
TUTARBORC=ISNULL((SELECT SUM (TUTARBORC)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
TUTARALACAK=ISNULL((SELECT SUM (TUTARALACAK)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
BAKIYE_DOVIZ=ISNULL((SELECT SUM (TUTAR_DOVIZ)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
CASE BNA.CURRENCY WHEN 0 THEN 'TL' WHEN 160 THEN 'TL' WHEN 53 THEN 'TL'WHEN 1 THEN 'USD' WHEN 11 THEN 'CHF' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 31 THEN 'IRR' 
WHEN 161 THEN 'RON'ELSE 'YOK' END AS 'DÖVİZ TÜRÜ',
BNA.CYPHCODE [GRUP KODU],
BNA.SPECODE [OZEL KODU]


FROM LG_003_BANKACC BNA
LEFT JOIN LG_003_BNCARD BNC ON BNC.LOGICALREF = BNA.BANKREF 
LEFT JOIN LG_003_01_GNTOTBN BNF ON BNF.CARDREF = BNA.LOGICALREF
LEFT JOIN LG_003_CRDACREF CRD ON CRD.CARDREF=BNA.LOGICALREF AND CRD.TRCODE IN (6,18,7) AND CRD.TYP IN(1)
LEFT JOIN LG_003_EMUHACC EMUH ON EMUH.LOGICALREF=CRD.ACCOUNTREF
--LEFT JOIN  LG_003_EMUHACC EMUH3 ON EMUH3.LOGICALREF=CRD.ACCOUNTREF
where  BNC.ACTIVE=0 AND BNA.ACTIVE=0 --AND BNA.CODE='102.04.0001'----AND BNF.CARDREF = 349 --AND BNA.CODE='03    03'--and BNC.DEFINITION_ = 'CITIBANK A.Ş.' 
AND BNA.CODE NOT IN ('101.01.0001','101.01.0002','101.01.0004','101.01.0005','101.02.0001','101.02.0002','103.04.0004','TEST  .001')
AND BNA.CURRENCY IN (1) and BNA.SPECODE IN ('KREDİ','ARAC KREDİ','CEK KRS','KGF','34 DES 38','34 DES 08')
GROUP BY BNC.DEFINITION_ , BNA.DEFINITION_ , BNA.CODE,BNA.ACCOUNTNO,BNC.BRANCH,BNA.IBAN,
BNA.CURRENCY,EMUH.CODE,EMUH.DEFINITION_,EMUH.LOGICALREF,CRD.ACCOUNTREF,BNA.LOGICALREF,BNA.CYPHCODE,BNA.SPECODE---,EMUHTOT.DEBIT---,EMUHTOT.CREDIT

UNION ALL

SELECT
'EURO'[TİPİ],
BNC.DEFINITION_ [BANKA],
TUTARBORC=ISNULL((SELECT SUM (TUTARBORC)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
TUTARALACAK=ISNULL((SELECT SUM (TUTARALACAK)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
BAKIYE_DOVIZ=ISNULL((SELECT SUM (TUTAR_DOVIZ)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
CASE BNA.CURRENCY WHEN 0 THEN 'TL' WHEN 160 THEN 'TL' WHEN 53 THEN 'TL'WHEN 1 THEN 'USD' WHEN 11 THEN 'CHF' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 31 THEN 'IRR' 
WHEN 161 THEN 'RON'ELSE 'YOK' END AS 'DÖVİZ TÜRÜ',
BNA.CYPHCODE [GRUP KODU],
BNA.SPECODE [OZEL KODU]


FROM LG_003_BANKACC BNA
LEFT JOIN LG_003_BNCARD BNC ON BNC.LOGICALREF = BNA.BANKREF 
LEFT JOIN LG_003_01_GNTOTBN BNF ON BNF.CARDREF = BNA.LOGICALREF
LEFT JOIN LG_003_CRDACREF CRD ON CRD.CARDREF=BNA.LOGICALREF AND CRD.TRCODE IN (6,18,7) AND CRD.TYP IN(1)
LEFT JOIN LG_003_EMUHACC EMUH ON EMUH.LOGICALREF=CRD.ACCOUNTREF
--LEFT JOIN  LG_003_EMUHACC EMUH3 ON EMUH3.LOGICALREF=CRD.ACCOUNTREF
where  BNC.ACTIVE=0 AND BNA.ACTIVE=0 --AND BNA.CODE='102.04.0001'----AND BNF.CARDREF = 349 --AND BNA.CODE='03    03'--and BNC.DEFINITION_ = 'CITIBANK A.Ş.' 
AND BNA.CODE NOT IN ('101.01.0001','101.01.0002','101.01.0004','101.01.0005','101.02.0001','101.02.0002','103.04.0004','TEST  .001')
AND BNA.CURRENCY IN (20)and  BNA.SPECODE IN ('KREDİ','ARAC KREDİ','CEK KRS','KGF','34 DES 38','34 DES 08')
GROUP BY BNC.DEFINITION_ , BNA.DEFINITION_ , BNA.CODE,BNA.ACCOUNTNO,BNC.BRANCH,BNA.IBAN,
BNA.CURRENCY,EMUH.CODE,EMUH.DEFINITION_,EMUH.LOGICALREF,CRD.ACCOUNTREF,BNA.LOGICALREF,BNA.CYPHCODE,BNA.SPECODE---,EMUHTOT.DEBIT---,EMUHTOT.CREDIT






UNION ALL

SELECT
'GUNCEL TL BAKIYE'[TİPİ],
BNC.DEFINITION_ [BANKA],
TUTARBORC=ISNULL((SELECT SUM (TUTARBORC)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
TUTARALACAK=ISNULL((SELECT SUM (TUTARALACAK)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
GUNCEL_BAKIYE_TL=ISNULL((SELECT SUM (GTutar_TL)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
CASE BNA.CURRENCY WHEN 0 THEN 'TL' WHEN 160 THEN 'TL' WHEN 53 THEN 'TL'WHEN 1 THEN 'USD' WHEN 11 THEN 'CHF' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 31 THEN 'IRR' 
WHEN 161 THEN 'RON'ELSE 'YOK' END AS 'DÖVİZ TÜRÜ',
BNA.CYPHCODE [GRUP KODU],
BNA.SPECODE [OZEL KODU]


FROM LG_003_BANKACC BNA
LEFT JOIN LG_003_BNCARD BNC ON BNC.LOGICALREF = BNA.BANKREF 
LEFT JOIN LG_003_01_GNTOTBN BNF ON BNF.CARDREF = BNA.LOGICALREF
LEFT JOIN LG_003_CRDACREF CRD ON CRD.CARDREF=BNA.LOGICALREF AND CRD.TRCODE IN (6,18,7) AND CRD.TYP IN(1)
LEFT JOIN LG_003_EMUHACC EMUH ON EMUH.LOGICALREF=CRD.ACCOUNTREF
--LEFT JOIN  LG_003_EMUHACC EMUH3 ON EMUH3.LOGICALREF=CRD.ACCOUNTREF
where  BNC.ACTIVE=0 AND BNA.ACTIVE=0 --AND BNA.CODE='102.04.0001'----AND BNF.CARDREF = 349 --AND BNA.CODE='03    03'--and BNC.DEFINITION_ = 'CITIBANK A.Ş.' 
AND BNA.CODE NOT IN ('101.01.0001','101.01.0002','101.01.0004','101.01.0005','101.02.0001','101.02.0002','103.04.0004','TEST  .001')
AND BNA.CURRENCY IN (0,160,53)and BNA.SPECODE IN ('KREDİ','ARAC KREDİ','CEK KRS','KGF','34 DES 38','34 DES 08')
GROUP BY BNC.DEFINITION_ , BNA.DEFINITION_ , BNA.CODE,BNA.ACCOUNTNO,BNC.BRANCH,BNA.IBAN,
BNA.CURRENCY,EMUH.CODE,EMUH.DEFINITION_,EMUH.LOGICALREF,CRD.ACCOUNTREF,BNA.LOGICALREF,BNA.CYPHCODE,BNA.SPECODE---,EMUHTOT.DEBIT---,EMUHTOT.CREDIT



UNION ALL

SELECT
'GUNCEL TL BAKIYE'[TİPİ],
BNC.DEFINITION_ [BANKA],
TUTARBORC=ISNULL((SELECT SUM (TUTARBORC)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
TUTARALACAK=ISNULL((SELECT SUM (TUTARALACAK)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
GUNCEL_BAKIYE_TL=ISNULL((SELECT SUM (GTutar_TL)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
CASE BNA.CURRENCY WHEN 0 THEN 'TL' WHEN 160 THEN 'TL' WHEN 53 THEN 'TL'WHEN 1 THEN 'USD' WHEN 11 THEN 'CHF' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 31 THEN 'IRR' 
WHEN 161 THEN 'RON'ELSE 'YOK' END AS 'DÖVİZ TÜRÜ',
BNA.CYPHCODE [GRUP KODU],
BNA.SPECODE [OZEL KODU]


FROM LG_003_BANKACC BNA
LEFT JOIN LG_003_BNCARD BNC ON BNC.LOGICALREF = BNA.BANKREF 
LEFT JOIN LG_003_01_GNTOTBN BNF ON BNF.CARDREF = BNA.LOGICALREF
LEFT JOIN LG_003_CRDACREF CRD ON CRD.CARDREF=BNA.LOGICALREF AND CRD.TRCODE IN (6,18,7) AND CRD.TYP IN(1)
LEFT JOIN LG_003_EMUHACC EMUH ON EMUH.LOGICALREF=CRD.ACCOUNTREF
--LEFT JOIN  LG_003_EMUHACC EMUH3 ON EMUH3.LOGICALREF=CRD.ACCOUNTREF
where  BNC.ACTIVE=0 AND BNA.ACTIVE=0 --AND BNA.CODE='102.04.0001'----AND BNF.CARDREF = 349 --AND BNA.CODE='03    03'--and BNC.DEFINITION_ = 'CITIBANK A.Ş.' 
AND BNA.CODE NOT IN ('101.01.0001','101.01.0002','101.01.0004','101.01.0005','101.02.0001','101.02.0002','103.04.0004','TEST  .001')
AND BNA.CURRENCY IN (1)and BNA.SPECODE IN ('KREDİ','ARAC KREDİ','CEK KRS','KGF','34 DES 38','34 DES 08')
GROUP BY BNC.DEFINITION_ , BNA.DEFINITION_ , BNA.CODE,BNA.ACCOUNTNO,BNC.BRANCH,BNA.IBAN,
BNA.CURRENCY,EMUH.CODE,EMUH.DEFINITION_,EMUH.LOGICALREF,CRD.ACCOUNTREF,BNA.LOGICALREF,BNA.CYPHCODE,BNA.SPECODE---,EMUHTOT.DEBIT---,EMUHTOT.CREDIT

UNION ALL

SELECT
'GUNCEL TL BAKIYE'[TİPİ],
BNC.DEFINITION_ [BANKA],
TUTARBORC=ISNULL((SELECT SUM (TUTARBORC)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
TUTARALACAK=ISNULL((SELECT SUM (TUTARALACAK)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
GUNCEL_BAKIYE_TL=ISNULL((SELECT SUM (GTutar_TL)  FROM GNC_003_BANKACC_TOT WHERE [LOG]=BNA.LOGICALREF ),0),
CASE BNA.CURRENCY WHEN 0 THEN 'TL' WHEN 160 THEN 'TL' WHEN 53 THEN 'TL'WHEN 1 THEN 'USD' WHEN 11 THEN 'CHF' WHEN 20 THEN 'EUR' WHEN 17 THEN 'GBP' WHEN 31 THEN 'IRR' 
WHEN 161 THEN 'RON'ELSE 'YOK' END AS 'DÖVİZ TÜRÜ',
BNA.CYPHCODE [GRUP KODU],
BNA.SPECODE [OZEL KODU]


FROM LG_003_BANKACC BNA
LEFT JOIN LG_003_BNCARD BNC ON BNC.LOGICALREF = BNA.BANKREF 
LEFT JOIN LG_003_01_GNTOTBN BNF ON BNF.CARDREF = BNA.LOGICALREF
LEFT JOIN LG_003_CRDACREF CRD ON CRD.CARDREF=BNA.LOGICALREF AND CRD.TRCODE IN (6,18,7) AND CRD.TYP IN(1)
LEFT JOIN LG_003_EMUHACC EMUH ON EMUH.LOGICALREF=CRD.ACCOUNTREF
--LEFT JOIN  LG_003_EMUHACC EMUH3 ON EMUH3.LOGICALREF=CRD.ACCOUNTREF
where  BNC.ACTIVE=0 AND BNA.ACTIVE=0 --AND BNA.CODE='102.04.0001'----AND BNF.CARDREF = 349 --AND BNA.CODE='03    03'--and BNC.DEFINITION_ = 'CITIBANK A.Ş.' 
AND BNA.CODE NOT IN ('101.01.0001','101.01.0002','101.01.0004','101.01.0005','101.02.0001','101.02.0002','103.04.0004','TEST  .001')
AND BNA.CURRENCY IN (20)and BNA.SPECODE IN ('KREDİ','ARAC KREDİ','CEK KRS','KGF','34 DES 38','34 DES 08')
GROUP BY BNC.DEFINITION_ , BNA.DEFINITION_ , BNA.CODE,BNA.ACCOUNTNO,BNC.BRANCH,BNA.IBAN,
BNA.CURRENCY,EMUH.CODE,EMUH.DEFINITION_,EMUH.LOGICALREF,CRD.ACCOUNTREF,BNA.LOGICALREF,BNA.CYPHCODE,BNA.SPECODE---,EMUHTOT.DEBIT---,EMUHTOT.CREDIT
GO

/****** Object:  View [dbo].[GNC_003_01_CARIBAKIYELER_AYBAZINDA]    Script Date: 17.04.2022 16:50:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
















CREATE VIEW [dbo].[GNC_003_01_CARIBAKIYELER_AYBAZINDA]
AS


 SELECT

CLC.CODE [CH KODU]
,CLC.DEFINITION_ [CH UNVAN]
,CASE WHEN CLC.CODE LIKE '120%'THEN '120'WHEN CLC.CODE LIKE '320%' THEN '320'WHEN CLC.CODE LIKE '128%' THEN '128'WHEN CLC.CODE LIKE '329%' THEN '329'ELSE 'DİGER' END 'CARİ GRUP'

,[CH TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0)
--,[OCAK TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190101' and '20190131')
--,[ŞUBAT TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190201' and '20190228')
--,[MART TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190301' and '20190331')
--,[NİSAN TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190401' and '20190430')
--,[MAYIS TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190501' and '20190531')
--,[HAZİRAN TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190601' and '20190630')
--,[TEMMUZ TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190701' and '20190731')
--,[AĞUSTOS TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190801' and '20190831')
--,[EYLÜL TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190901' and '20190930')
--,[EKİM TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20191001' and '20191031')
--,[KASIM TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20191101' and '20191130')
--,[ARALIK TL BAKIYE]  = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (0,160) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20191201' and '20191231')
,[TL SATIS ORT VADE]   = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_003_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (0,160))
,[TL ALIS ORT VADE]   = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_003_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 1 AND PYT.TRCODE = 1 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (0,160))

,[CH USD BAKIYE] =     (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0)
--,[OCAK USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190101' and '20190131')
--,[ŞUBAT USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190201' and '20190228')
--,[MART USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190301' and '20190331')
--,[NİSAN USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190401' and '20190430')
--,[MAYIS USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190501' and '20190531')
--,[HAZİRAN USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190601' and '20190630')
--,[TEMMUZ USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190701' and '20190731')
--,[AĞUSTOS USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190801' and '20190831')
--,[EYLÜL USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190901' and '20190930')
--,[EKİM USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20191001' and '20191031')
--,[KASIM USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20191101' and '20191130')
--,[ARALIK USD BAKIYE] =    (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET  WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE  CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20191201' and '20191231')
,[CH USD_KUR FARKI]  =(SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (1) THEN CASE CLF.SIGN WHEN 0 THEN CLF.AMOUNT WHEN 1 THEN CLF.AMOUNT * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.TRCODE IN(6)AND CLF.DATE_ BETWEEN '20200101'AND '20201231' )
,[USD SATIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_003_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (1))
,[USD ALIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_003_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 1 AND PYT.TRCODE = 1 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (1))

,[CH EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0)
--,[OCAK  EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190101' and '20190131')
--,[ŞUBAT EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190201' and '20190228')
--,[MART EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190301' and '20190331')
--,[NİSAN EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190401' and '20190430')
--,[MAYIS EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190501' and '20190531')
--,[HAZİRAN EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190601' and '20190630')
--,[TEMMUZ EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190701' and '20190731')
--,[AĞUSTOS EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190801' and '20190831')
--,[EYLÜL EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20190901' and '20190930')
--,[EKİM EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20191001' and '20191031')
--,[KASIM EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20191101' and '20191130')
--,[ARALIK EUR BAKIYE] = (SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.TRNET WHEN 1 THEN CLF.TRNET * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.DATE_ BETWEEN '20191201' and '20191231')
,[CH EURO_KUR FARKI]  =(SELECT ISNULL(ROUND(SUM(CASE WHEN CLF.TRCURR IN (20) THEN CASE CLF.SIGN WHEN 0 THEN CLF.AMOUNT WHEN 1 THEN CLF.AMOUNT * -1 END ELSE 0 END),2),0) FROM LG_003_01_CLFLINE CLF WHERE CLF.CLIENTREF = CLC.LOGICALREF AND CLF.CANCELLED = 0 AND CLF.TRCODE IN(6)AND CLF.DATE_ BETWEEN '20200101'AND '20201231' ) 
,[EUR SATIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_003_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (20))
,[EUR ALIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_003_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 1 AND PYT.TRCODE = 1 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID AND PYT.TRCURR IN (20))

,[TOPLAM TL BAKIYE] = (SELECT ISNULL(ROUND(CLC2.DEBIT - CLC2.CREDIT,3),0) FROM LV_003_01_CLCARD CLC2 WHERE CLC2.LOGICALREF = CLC.LOGICALREF)
---,[TOPLAM TL YENI] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20190101' and '20191231' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20190101' AND '20191231' AND CLIENTREF=CLC.LOGICALREF),0)
,[OCAK] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200101' and '20200131' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200101' AND '20200131' AND CLIENTREF=CLC.LOGICALREF),0)
,[ŞUBAT] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200201' and '20200229' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200201' and '20200229' AND CLIENTREF=CLC.LOGICALREF),0)
,[MART] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200301' and '20200331' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200301' and '20200331' AND CLIENTREF=CLC.LOGICALREF),0)
,[NİSAN] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200401' and '20200430' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200401' and '20200430' AND CLIENTREF=CLC.LOGICALREF),0)
,[MAYIS] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200501' and '20200531' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200501' and '20200531' AND CLIENTREF=CLC.LOGICALREF),0)
,[HAZİRAN] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200601' and '20200630' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200601' and '20200630' AND CLIENTREF=CLC.LOGICALREF),0)
,[TEMMUZ] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200701' and '20200731' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200701' and '20200731' AND CLIENTREF=CLC.LOGICALREF),0)
,[AĞUSTOS] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200801' and '20200831' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200801' and '20200831' AND CLIENTREF=CLC.LOGICALREF),0)
,[EYLÜL] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20200901' and '20200930' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20200901' and '20200930' AND CLIENTREF=CLC.LOGICALREF),0)
,[EKİM] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20201001' and '20201031' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20201001' and '20201031' AND CLIENTREF=CLC.LOGICALREF),0)
,[KASIM] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20201101' and '20201130' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20201101' and '20201130'AND CLIENTREF=CLC.LOGICALREF),0)
,[ARALIK] =ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=0 AND CANCELLED=0 AND DATE_ BETWEEN '20201201' and '20201231' AND CLIENTREF=CLC.LOGICALREF),0) - ISNULL((SELECT ROUND(SUM(AMOUNT),3) FROM LG_003_01_CLFLINE WHERE SIGN=1 AND CANCELLED=0 AND DATE_ BETWEEN '20201201' and '20201231' AND CLIENTREF=CLC.LOGICALREF),0)
,[TOPLAM TL SATIS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_003_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 0 AND PYT.TRCODE = 8 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID)
,[TOPLAM TL ALS ORT VADE]  = (SELECT ISNULL(CONVERT(CHAR(10),CAST(AVG(CAST(DATE_ AS FLOAT)) AS DATETIME), 103),0) FROM LG_003_01_PAYTRANS PYT WHERE PYT.CARDREF = CLC.LOGICALREF AND PYT.CANCELLED = 0 AND PYT.SIGN = 1 AND PYT.TRCODE = 1 AND PYT.MODULENR = 4 AND PYT.TOTAL <> PYT.PAID)

FROM LG_003_CLCARD CLC
WHERE CLC.ACTIVE = 0 AND CLC.CARDTYPE <> 22 AND
  (SUBSTRING(CLC.CODE, 1, 3) = '120' OR
   SUBSTRING(CLC.CODE, 1, 3) = '320' OR
   SUBSTRING(CLC.CODE, 1, 3) = '128' OR
   SUBSTRING(CLC.CODE, 1, 3) = '329' OR 
   SUBSTRING(CLC.CODE, 1, 3) = '136' OR
   SUBSTRING(CLC.CODE, 1, 3) = '336' OR
   SUBSTRING(CLC.CODE, 1, 3) = '770' OR
   SUBSTRING(CLC.CODE, 1, 3) = '309')

GO

