USE [LKSDB]
GO

/****** Object:  View [dbo].[SAGLAM_320_FATURA_RAPORLARI_DETAYLI]    Script Date: 29.01.2023 12:21:28 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

--USE [LKSDB]
--GO

--/****** Object:  View [dbo].[SAGLAM_320_FATURA_RAPORLARI_DETAYLI]    Script Date: 19.02.2021 10:49:51 ******/
--SET ANSI_NULLS ON
--GO

--SET QUOTED_IDENTIFIER ON
--GO

------USE [LKSDB]
------GO

------/****** Object:  View [dbo].[SAGLAM_320_FATURA_RAPORLARI_DETAYLI]    Script Date: 14.11.2020 13:56:29 ******/
------SET ANSI_NULLS ON
------GO

------SET QUOTED_IDENTIFIER ON
------GO
ALTER VIEW [dbo].[SAGLAM_320_FATURA_RAPORLARI_DETAYLI]
AS
SELECT     'SATIŞ' TİP,INVOICE.FICHENO AS FATURA_NO ,CLCARD.CODE 'CARİ KODU', CLCARD.DEFINITION_ AS [CARİ ÜNVANI],CLCARD.SPECODE AS MUSTERİÖZELKODU, 
                      CASE STLINE.LINETYPE WHEN 0 THEN 'Stok' WHEN 4 THEN 'Hizmet' ELSE 'DİGER' END 'TİPİ', CASE WHEN STLINE.TRCODE IN (6,7, 8) 
                      THEN CASE WHEN STLINE.LINETYPE IN (0) 
                      THEN ITEMS.CODE ELSE SRVCARD.CODE END ELSE CASE WHEN STLINE.LINETYPE = 4 THEN SRVCARD.CODE ELSE ITEMS.CODE END END 'STOK KODU', 
                      CASE WHEN STLINE.TRCODE IN (6,7,8) THEN CASE WHEN STLINE.LINETYPE IN (0) 
                      THEN ITEMS.NAME ELSE SRVCARD.DEFINITION_ END ELSE CASE WHEN STLINE.LINETYPE = 4 THEN SRVCARD.DEFINITION_ ELSE ITEMS.NAME END END 'STOK AÇIKLAMASI',
                       CASE STLINE.LINETYPE WHEN 0 THEN ITEMS.SPECODE WHEN 4 THEN SRVCARD.SPECODE ELSE 'DİGER' END 'STOK ÖZEL KODU', 
                      CASE STLINE.LINETYPE WHEN 0 THEN ITEMS.STGRPCODE WHEN 4 THEN SRVCARD.SPECODE ELSE 'DİGER' END 'STOK GRUP KODU',
					 
				
                      STLINE.DATE_ AS [İŞLEM TARİHİ],
					  YEAR(STLINE.DATE_) [YIL],
					   
					   CASE DATEPART(MONTH, STLINE.DATE_) 
                      WHEN 1 THEN 'OCAK' WHEN 2 THEN 'ŞUBAT' WHEN 3 THEN 'MART' WHEN 4 THEN 'NİSAN' WHEN 5 THEN 'MAYIS' WHEN 6 THEN 'HAZİRAN' WHEN 7 THEN 'TEMMUZ'
                       WHEN 8 THEN 'AĞUSTOS' WHEN 9 THEN 'EYLÜL' WHEN 10 THEN 'EKİM' WHEN 11 THEN 'KASIM' WHEN 12 THEN 'ARALIK' END AS [İŞLEM AYI], 
					   CASE STLINE.TRCODE WHEN 7 THEN 'Parekende satış'WHEN 8 THEN 'Toptan satış'WHEN 6 THEN 'Alım iade'WHEN 9 THEN 'Verilen Hizmet'ELSE 'DİĞER'END AS TÜR,
                       CASE WHEN ITEMS.UNITSETREF= 7 THEN CASE STLINE.TRCODE WHEN 7 THEN AMOUNT WHEN 8 THEN AMOUNT WHEN 9 THEN AMOUNT ELSE AMOUNT *  1 END ELSE '' END AS [MİKTAR KG],
					   CASE WHEN ITEMS.UNITSETREF IN (5,6) THEN CASE STLINE.TRCODE WHEN 7 THEN AMOUNT WHEN 8 THEN AMOUNT WHEN 9 THEN AMOUNT ELSE AMOUNT *  1 END ELSE '' END AS [MİKTAR ADET],
					
					  STLINE.PRICE AS [BİRİM FİYAT], 
                      CASE STLINE.TRCODE WHEN 7 THEN VATMATRAH WHEN 8 THEN VATMATRAH WHEN 9 THEN VATMATRAH ELSE VATMATRAH *  1 END AS KDVMATRAHI,STLINE.VATAMNT AS [KDVTUTARI],
				CASE STLINE.TRCODE WHEN 7 THEN VATMATRAH WHEN 8 THEN VATMATRAH WHEN 9 THEN VATMATRAH ELSE VATMATRAH *  1 END+STLINE.VATAMNT AS [NET TUTAR],
					  STLINE.TOTAL AS İNDİRİMSİZTUTAR,CASE WHEN STLINE.TRCODE IN (2, 3) THEN STLINE.DISTDISC * - 1 ELSE STLINE.DISTDISC END AS İSKONTO,
			
                      CASE STLINE.TRCURR WHEN 0 THEN 'TL'WHEN 1 THEN 'USD'WHEN 20 THEN 'EURO' ELSE '' END AS İDTÜRÜ, 
                      CASE STLINE.TRRATE WHEN 0 THEN 0 ELSE STLINE.PRICE / STLINE.TRRATE END AS İDBİRİMFİYATI, 
                      CASE STLINE.TRRATE WHEN 0 THEN 0 ELSE STLINE.VAT / STLINE.TRRATE END AS İDKDV, 
                      CASE STLINE.TRRATE WHEN 0 THEN 0 ELSE STLINE.TOTAL / STLINE.TRRATE END AS İDTUTAR,
					   PYP.DEFINITION_ AS VADE,
					   
					  CASE STLINE.BILLED WHEN 1 THEN 'FATURALANDI' WHEN 0 THEN 'İRSALİYE' ELSE 'DİĞER' END [FATURALANMA DURUMU],
					  UNT.NAME [Birim Seti]
FROM         dbo.LG_320_01_STLINE AS STLINE LEFT OUTER JOIN
                      dbo.LG_320_ITEMS AS ITEMS ON STLINE.STOCKREF = ITEMS.LOGICALREF LEFT OUTER JOIN
                      dbo.LG_320_SRVCARD AS SRVCARD ON STLINE.STOCKREF = SRVCARD.LOGICALREF LEFT OUTER JOIN
                      dbo.LG_320_CLCARD AS CLCARD ON STLINE.CLIENTREF = CLCARD.LOGICALREF LEFT OUTER JOIN
                      dbo.LG_320_01_INVOICE AS INVOICE ON INVOICE.LOGICALREF = STLINE.INVOICEREF LEFT OUTER JOIN
                      dbo.LG_320_PAYPLANS AS PYP ON PYP.LOGICALREF = CLCARD.PAYMENTREF LEFT JOIN
					  dbo.LG_320_EMCENTER AS EMC ON EMC.LOGICALREF=STLINE.CENTERREF LEFT JOIN
					  dbo.lg_320_PROJECT AS PROJ ON PROJ.LOGICALREF=STLINE.PROJECTREF LEFT JOIN
					  LG_320_UNITSETF AS UNT ON UNT.LOGICALREF=ITEMS.UNITSETREF
					  
WHERE     (STLINE.TRCODE IN (6, 7, 8,9)) AND (STLINE.DATE_ BETWEEN '20200101' AND '20211231') AND (STLINE.CANCELLED = 0) AND (STLINE.LINETYPE IN (0, 4))
 ---AND INVOICE.FICHENO='A11675'
UNION ALL
SELECT     'ALIŞ' TİP,INVOICE.FICHENO AS FATURA_NO,CLCARD.CODE 'CARİ KODU', CLCARD.DEFINITION_ AS [CARİ ÜNVANI], CLCARD.SPECODE AS MUSTERİÖZELKODU,
                      CASE STLINE.LINETYPE WHEN 0 THEN 'Stok' WHEN 4 THEN 'Hizmet' ELSE 'DİGER' END 'TİPİ', CASE WHEN STLINE.TRCODE IN (1, 3) 
                      THEN CASE WHEN STLINE.LINETYPE IN (0) 
                      THEN ITEMS.CODE ELSE SRVCARD.CODE END ELSE CASE WHEN STLINE.LINETYPE = 4 THEN SRVCARD.CODE ELSE ITEMS.CODE END END 'STOK KODU', 
                      CASE WHEN STLINE.TRCODE IN (1, 3) THEN CASE WHEN STLINE.LINETYPE IN (0) 
                      THEN ITEMS.NAME ELSE SRVCARD.DEFINITION_ END ELSE CASE WHEN STLINE.LINETYPE = 4 THEN SRVCARD.DEFINITION_ ELSE ITEMS.NAME END END 'STOK AÇIKLAMASI',
                       CASE STLINE.LINETYPE WHEN 0 THEN ITEMS.SPECODE WHEN 4 THEN SRVCARD.SPECODE ELSE 'DİGER' END 'STOK ÖZEL KODU', 
                      CASE STLINE.LINETYPE WHEN 0 THEN ITEMS.STGRPCODE WHEN 4 THEN SRVCARD.SPECODE ELSE 'DİGER' END 'STOK GRUP KODU',
					
                       
                      STLINE.DATE_ AS [İŞLEM TARİHİ], 
					  YEAR(STLINE.DATE_) [YIL],
					  
					  CASE DATEPART(MONTH, STLINE.DATE_) 
                      WHEN 1 THEN 'OCAK' WHEN 2 THEN 'ŞUBAT' WHEN 3 THEN 'MART' WHEN 4 THEN 'NİSAN' WHEN 5 THEN 'MAYIS' WHEN 6 THEN 'HAZİRAN' WHEN 7 THEN 'TEMMUZ'
                       WHEN 8 THEN 'AĞUSTOS' WHEN 9 THEN 'EYLÜL' WHEN 10 THEN 'EKİM' WHEN 11 THEN 'KASIM' WHEN 12 THEN 'ARALIK' END AS [İŞLEM AYI], 
					   CASE STLINE.TRCODE WHEN 1 THEN 'Alım faturası'WHEN 3 THEN 'Satış iade faturası'WHEN 4 THEN 'Alınan Hizmet'ELSE 'DİĞER'END AS TÜR,
                       CASE WHEN ITEMS.UNITSETREF= 7 THEN CASE STLINE.TRCODE WHEN 7 THEN AMOUNT WHEN 8 THEN AMOUNT WHEN 9 THEN AMOUNT ELSE AMOUNT *  1 END ELSE '' END AS [MİKTAR KG],
					   CASE WHEN ITEMS.UNITSETREF IN (5,6) THEN CASE STLINE.TRCODE WHEN 7 THEN AMOUNT WHEN 8 THEN AMOUNT WHEN 9 THEN AMOUNT ELSE AMOUNT *  1 END ELSE '' END AS [MİKTAR ADET],
					  STLINE.PRICE AS [BİRİM FİYAT],
					
					  CASE STLINE.TRCODE WHEN 1 THEN VATMATRAH WHEN 4 THEN VATMATRAH ELSE VATMATRAH *  1 END AS KDVMATRAHI,STLINE.VATAMNT AS [KDVTUTARI],
					  CASE STLINE.TRCODE WHEN 1 THEN VATMATRAH WHEN 4 THEN VATMATRAH ELSE VATMATRAH *  1 END+STLINE.VATAMNT AS [NET TUTAR],
					  STLINE.TOTAL AS İNDİRİMSİZTUTAR,CASE WHEN STLINE.TRCODE IN (2, 3) THEN STLINE.DISTDISC * - 1 ELSE STLINE.DISTDISC END AS İSKONTO,
					
					  
                      CASE STLINE.TRCURR WHEN 0 THEN 'TL'WHEN 1 THEN 'USD'WHEN 20 THEN 'EURO' ELSE '' END AS İDTÜRÜ, 
                      CASE STLINE.TRRATE WHEN 0 THEN 0 ELSE STLINE.PRICE / STLINE.TRRATE END AS İDBİRİMFİYATI, 
                      CASE STLINE.TRRATE WHEN 0 THEN 0 ELSE STLINE.VAT / STLINE.TRRATE END AS İDKDV, 
                      CASE STLINE.TRRATE WHEN 0 THEN 0 ELSE STLINE.TOTAL / STLINE.TRRATE END AS İDTUTAR,
                       PYP.DEFINITION_ AS VADE,
					   CASE STLINE.BILLED WHEN 1 THEN 'FATURALANDI' WHEN 0 THEN 'İRSALİYE' ELSE 'DİĞER' END [FATURALANMA DURUMU],
					   UNT.NAME [Birim Seti]
FROM         dbo.LG_320_01_STLINE AS STLINE LEFT OUTER JOIN
                      dbo.LG_320_ITEMS AS ITEMS ON STLINE.STOCKREF = ITEMS.LOGICALREF LEFT OUTER JOIN
                      dbo.LG_320_SRVCARD AS SRVCARD ON STLINE.STOCKREF = SRVCARD.LOGICALREF LEFT OUTER JOIN
                      dbo.LG_320_CLCARD AS CLCARD ON STLINE.CLIENTREF = CLCARD.LOGICALREF LEFT OUTER JOIN
                      dbo.LG_320_01_INVOICE AS INVOICE ON INVOICE.LOGICALREF = STLINE.INVOICEREF LEFT OUTER JOIN
                      dbo.LG_320_PAYPLANS AS PYP ON PYP.LOGICALREF = CLCARD.PAYMENTREF LEFT JOIN
					  dbo.LG_320_EMCENTER AS EMC ON EMC.LOGICALREF=STLINE.CENTERREF LEFT JOIN
					  dbo.lg_320_PROJECT AS PROJ ON PROJ.LOGICALREF=STLINE.PROJECTREF LEFT JOIN
					    LG_320_UNITSETF AS UNT ON UNT.LOGICALREF=ITEMS.UNITSETREF
WHERE     (STLINE.TRCODE IN (1,3,4,26)) AND (STLINE.DATE_ BETWEEN '20200101' AND '20211231') AND (STLINE.CANCELLED = 0) AND (STLINE.LINETYPE IN (0, 4))
---and ınvoıce.fıcheno='M012019000003205'

UNION ALL


SELECT 
--'ALINAN SMM' TİP,
CASE     WHEN CLFL.TRCODE=46 THEN 'ALIŞ'
                               WHEN CLFL.TRCODE=47 THEN 'SATIŞ'
                               ELSE '' END TİP,
CLF.FICHENO FATURA_NO,
CLC.CODE [CARİ KODU],
CLC.DEFINITION_ AS [CARİ ÜNVANI],
CLC.SPECODE AS MUSTERİÖZELKODU,
'Hizmet' TİPİ,
'' AS [STOK KODU],
'' [STOK AÇIKLAMASI],
'' [STOK ÖZEL KODU],
'' [STOK GRUP KODU],

CLF.DATE_ [İŞLEM TARİHİ],
YEAR(CLF.DATE_) [YIL],

CASE DATEPART(MONTH, CLF.DATE_) 
                      WHEN 1 THEN 'OCAK' WHEN 2 THEN 'ŞUBAT' WHEN 3 THEN 'MART' WHEN 4 THEN 'NİSAN' WHEN 5 THEN 'MAYIS' WHEN 6 THEN 'HAZİRAN' WHEN 7 THEN 'TEMMUZ'
                       WHEN 8 THEN 'AĞUSTOS' WHEN 9 THEN 'EYLÜL' WHEN 10 THEN 'EKİM' WHEN 11 THEN 'KASIM' WHEN 12 THEN 'ARALIK' END AS [İŞLEM AYI],
CASE     CLFL.TRCODE 
                               WHEN 46 THEN 'Alınan SMM'
                               WHEN 47 THEN 'Verilen SMM'
                               ELSE '' END [TÜR],

''[MİKTAR KG],
''[MİKTAR ADET],
''  [BİRİM FİYAT],
CLFL.AMOUNT*100/(100-(CLFL.DISCRATE-CLFL.VATRATE)) KDVMATRAHI,
CLFL.AMOUNT*100/(100-(CLFL.DISCRATE-CLFL.VATRATE))*CLFL.VATRATE/100 [KDVTUTARI],
CLFL.AMOUNT*100/(100-(CLFL.DISCRATE-CLFL.VATRATE)) +(CLFL.AMOUNT*100/(100-(CLFL.DISCRATE-CLFL.VATRATE))*CLFL.VATRATE/100 ) [NET TUTAR],

'' İNDİRİMSİZTUTAR,
'' İSKONTO,



  CASE CLFL.TRCURR WHEN 0 THEN 'TL'WHEN 1 THEN 'USD'WHEN 20 THEN 'EURO' ELSE '' END AS İDTÜRÜ,
''İDBİRİMFİYATI,
''İDKDV,
''İDTUTAR,
''VADE,		
'FATURALANDI'[FATURALANMA DURUMU],
'' [Birim Seti]

---CLF.DOCODE [Belge No],
----CLFL.AMOUNT*100/(100-(CLFL.DISCRATE-CLFL.VATRATE)) [Tutar],
--case CLFL.TRCODE WHEN 47 THEN CLFL.AMOUNT*100/(100-(CLFL.DISCRATE-CLFL.VATRATE))*CLFL.VATRATE/100  WHEN 46 THEN CLFL.AMOUNT*100/(100-(CLFL.DISCRATE-CLFL.VATRATE))*CLFL.VATRATE/100*-1  ELSE 'X' end[TEV KDV],           
FROM LG_320_01_CLFLINE CLFL
                               LEFT JOIN LG_320_01_CLFICHE CLF ON CLFL.SOURCEFREF=CLF.LOGICALREF
                               LEFT JOIN LG_320_CLCARD CLC ON CLC.LOGICALREF=CLFL.CLIENTREF
							  
							

WHERE CLFL.TRCODE IN (47,46)


GO


