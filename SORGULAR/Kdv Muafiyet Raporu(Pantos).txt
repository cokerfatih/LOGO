USE [TIGERDB]
GO

/****** Object:  View [dbo].[DST_022_01_SATISLAR]    Script Date: 02/17/2022 15:26:31 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[DST_022_01_SATISLAR] AS 

SELECT
	
	CASE 
	WHEN STL.TRCODE IN (3) THEN 'Satış İade' 
	WHEN STL.TRCODE IN (7) THEN 'Perakende Satış'
	WHEN STL.TRCODE IN (8) THEN 'Toptan Satış'
	WHEN STL.TRCODE IN (6) THEN 'Satınalma İade'
	WHEN STL.TRCODE IN (9) THEN 'Verilen Hizmet'

	
	ELSE 'Diğer' END [Hareket],
	
	--STL.SOURCEINDEX [Ambar No],
	--AMB.NAME [Ambar Adı],
	--MONTH(STF.DATE_) [Ay (İrsaliye)],
	MONTH(INV.DATE_) [Ay (Fatura)],
	INV.DATE_ [Fatura Tarihi],
	INV.FICHENO [Fatura No],
	INV.DOCODE [Fatura Belge No],
	STL.VATEXCEPTCODE [KDV İstisna Kodu],
	STL.VATEXCEPTREASON [KDV İstisna Sebebi],
	--INV.CYPHCODE [Fatura Yetki Kodu],
	--CASE WHEN STL.INVOICEREF=0 THEN 'Faturalanmamış' ELSE 'Faturalanmış' END [Faturalanma],
	
	--STF.DATE_ [İrsaliye Tarihi],
	--STF.FICHENO [İrsaliye No],
	--STF.DOCODE [İrsaliye Belge No],
	--STF.CYPHCODE [İrsaliye Yetki Kodu],
	CLC.CODE [Cari Kodu],
	CLC.DEFINITION_ [Cari Adı],
	--CLC.TRADINGGRP [Cari TİG],
	--CLC.CYPHCODE [Cari Yetki Kodu],
	CLC.CITYCODE [Cari Şehir Kodu],
	CLC.CITY [Cari Şehir],
	CLC.COUNTRY [Cari Ülke],
	CASE WHEN STL.LINETYPE=0 THEN 'Malzeme' WHEN STL.LINETYPE=1 THEN 'Promosyon' WHEN STL.LINETYPE=4 THEN 'Hizmet' ELSE 'Diğer' END [Satır], 
	
	ISNULL(ITM.CODE,'')+ISNULL(SRV.CODE,'') [Stok/Hizmet Kodu],
	ISNULL(ITM.NAME,'')+ISNULL(SRV.DEFINITION_,'') [Stok/Hizmet Adı],
	--ITM.PRODUCERCODE [Stok Üretici kodu],
	--SPE.DEFINITION_ [Stok Grup Adı],
	CASE WHEN STL.TRCODE IN (3,4) THEN STL.AMOUNT*-1 ELSE STL.AMOUNT END [Miktar],
	UNT.CODE [Satır Birim],
	
	CASE WHEN STL.LINETYPE=1 THEN 0 ELSE (CASE WHEN STL.TRCODE IN (3,4) THEN STL.VATMATRAH*-1 ELSE STL.VATMATRAH END) END [Matrah],
	CASE WHEN STL.LINETYPE=1 THEN 0 ELSE (CASE WHEN STL.TRCODE IN (3,4) THEN STL.VATAMNT*-1 ELSE STL.VATAMNT END) END [KDV],
	CASE WHEN STL.LINETYPE=1 THEN 0 ELSE (CASE WHEN STL.TRCODE IN (3,4) THEN STL.DISTDISC*-1 ELSE STL.DISTDISC END) END [İndirim],
	CASE WHEN STL.LINETYPE=1 THEN 0 ELSE (CASE WHEN STL.TRCODE IN (3,4) THEN STL.DISTEXP ELSE STL.DISTEXP END) END [Masraf],
	--CLC_2.CODE [Sevkiyat Cari Kodu],
	--CLC_2.DEFINITION_ [Sevkiyat Cari Adı],
	INV.GENEXP1 + INV.GENEXP2 [Fatura Açıklama],
	PAY.CODE [Ödeme Planı]

	--USR.NAME [Ekleyen(irsaliye)]
	--SHP.NAME [Sevkıyat Adresi],
	--SHP.CITYCODE [Sevk Adresi Şehir Kodu],
	--SLS.DEFINITION_ [Satış Elemanı]
	--[Satış Elemanı-Cari] = (SELECT TOP 1 SALESMAN_NAME FROM ST_000_SATICI_CARI_BAGLANTISI WHERE FIRMNR=10 AND CLCARD_CODE=CLC.CODE ORDER BY SALESMAN_CODE)

FROM LG_022_01_STLINE STL WITH(NOLOCK)
		LEFT JOIN LG_022_ITEMS ITM WITH(NOLOCK) ON STL.STOCKREF=ITM.LOGICALREF AND STL.LINETYPE IN (0,1)
		LEFT JOIN LG_022_SRVCARD SRV WITH(NOLOCK) ON STL.STOCKREF=SRV.LOGICALREF AND STL.LINETYPE=4
		LEFT JOIN LG_022_CLCARD CLC WITH(NOLOCK) ON CLC.LOGICALREF=STL.CLIENTREF
		LEFT JOIN LG_022_01_INVOICE INV WITH(NOLOCK) ON INV.LOGICALREF=STL.INVOICEREF
		LEFT JOIN LG_022_01_STFICHE STF WITH(NOLOCK) ON STF.LOGICALREF=STL.STFICHEREF
		LEFT JOIN LG_022_UNITSETL UNT WITH(NOLOCK) ON STL.UOMREF=UNT.LOGICALREF
		LEFT JOIN LG_022_CLCARD CLC_2 WITH(NOLOCK) ON CLC_2.LOGICALREF=INV.RECVREF
		LEFT JOIN LG_022_SPECODES SPE WITH(NOLOCK) ON SPE.SPECODE=ITM.STGRPCODE AND SPE.CODETYPE=4 AND SPE.SPECODETYPE=0
		LEFT JOIN LG_022_PAYPLANS PAY WITH(NOLOCK) ON INV.PAYDEFREF=PAY.LOGICALREF
		LEFT JOIN LG_022_ITMUNITA ITU2  WITH(NOLOCK) ON ITU2.ITEMREF=ITM.LOGICALREF AND ITU2.LINENR=2
		LEFT JOIN LG_022_ITMUNITA ITU3  WITH(NOLOCK) ON ITU3.ITEMREF=ITM.LOGICALREF AND ITU3.LINENR=3
		LEFT JOIN L_CAPIWHOUSE AMB ON AMB.NR=STL.SOURCEINDEX AND AMB.FIRMNR=010
		LEFT JOIN L_CAPIUSER USR ON USR.NR=STF.CAPIBLOCK_CREATEDBY
		LEFT JOIN LG_022_SHIPINFO SHP WITH(NOLOCK) ON SHP.LOGICALREF=STF.SHIPINFOREF
		LEFT JOIN LG_SLSMAN SLS ON SLS.LOGICALREF=STF.SALESMANREF

WHERE STL.TRCODE IN (6,9) AND STL.CANCELLED=0 AND STL.LINETYPE=4 --and INV.LOGICALREF=15813

GO


